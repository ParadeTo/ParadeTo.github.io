<!DOCTYPE html>




<html class="theme-next mist" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />


<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />





  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="ai,agent," />










<meta name="description" content="前言随着大语言模型（LLM）能力的快速提升，AI Agent 已经从概念走向实践。然而，如何让 Agent 更可靠、更高效地完成复杂任务，成为开发者面临的关键挑战。 就像软件工程中的设计模式为常见问题提供了经过验证的解决方案，Agent 开发同样需要成熟的设计模式来指导实践。本文介绍五种核心模式：ReAct 通过推理与行动的交替循环处理需要外部信息的任务，CodeAct 通过生成代码应对复杂计算，">
<meta name="keywords" content="ai,agent">
<meta property="og:type" content="article">
<meta property="og:title" content="Agent 设计模式实战">
<meta property="og:url" content="http://www.paradeto.com/2025/11/18/ai-patterns/index.html">
<meta property="og:site_name" content="Ayou">
<meta property="og:description" content="前言随着大语言模型（LLM）能力的快速提升，AI Agent 已经从概念走向实践。然而，如何让 Agent 更可靠、更高效地完成复杂任务，成为开发者面临的关键挑战。 就像软件工程中的设计模式为常见问题提供了经过验证的解决方案，Agent 开发同样需要成熟的设计模式来指导实践。本文介绍五种核心模式：ReAct 通过推理与行动的交替循环处理需要外部信息的任务，CodeAct 通过生成代码应对复杂计算，">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://www.paradeto.com/2025/11/18/ai-patterns/react-workflow.png">
<meta property="og:image" content="http://www.paradeto.com/2025/11/18/ai-patterns/langgraph-workflow.png">
<meta property="og:image" content="http://www.paradeto.com/2025/11/18/ai-patterns/codeact-workflow.png">
<meta property="og:image" content="http://www.paradeto.com/2025/11/18/ai-patterns/plan-workflow.png">
<meta property="og:image" content="http://www.paradeto.com/2025/11/18/ai-patterns/plan-advanced-workflow.png">
<meta property="og:image" content="http://www.paradeto.com/2025/11/18/ai-patterns/reflection-workflow.png">
<meta property="og:image" content="http://www.paradeto.com/2025/11/18/ai-patterns/human-loop-workflow.png">
<meta property="og:updated_time" content="2025-11-20T12:47:46.843Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Agent 设计模式实战">
<meta name="twitter:description" content="前言随着大语言模型（LLM）能力的快速提升，AI Agent 已经从概念走向实践。然而，如何让 Agent 更可靠、更高效地完成复杂任务，成为开发者面临的关键挑战。 就像软件工程中的设计模式为常见问题提供了经过验证的解决方案，Agent 开发同样需要成熟的设计模式来指导实践。本文介绍五种核心模式：ReAct 通过推理与行动的交替循环处理需要外部信息的任务，CodeAct 通过生成代码应对复杂计算，">
<meta name="twitter:image" content="http://www.paradeto.com/2025/11/18/ai-patterns/react-workflow.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>









  <link rel="canonical" href="http://www.paradeto.com/2025/11/18/ai-patterns/"/>






  <title>Agent 设计模式实战 | Ayou</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?6a0c6a11d4daa051d62442b432fb279d";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
    
    
      
    

    <div class="container sidebar-position-left page-post-detail">
      <div class="headband"></div>

      <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
        <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Ayou</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Good Good Study, Day Day Up!</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-demo">
          <a href="/demo/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Demo
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/resume" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            About
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
      </header>

      <main id="main" class="main">
        <div class="main-inner">
          <div class="content-wrap">
            <div id="content" class="content">
              

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.paradeto.com/2025/11/18/ai-patterns/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ayou">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ayou">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Agent 设计模式实战</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2025-11-18T11:08:27+08:00">
                2025-11-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ai/" itemprop="url" rel="index">
                    <span itemprop="name">ai</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>随着大语言模型（LLM）能力的快速提升，AI Agent 已经从概念走向实践。然而，如何让 Agent 更可靠、更高效地完成复杂任务，成为开发者面临的关键挑战。</p>
<p>就像软件工程中的设计模式为常见问题提供了经过验证的解决方案，Agent 开发同样需要成熟的设计模式来指导实践。本文介绍五种核心模式：ReAct 通过推理与行动的交替循环处理需要外部信息的任务，CodeAct 通过生成代码应对复杂计算，计划模式为结构化任务提供清晰执行路径，反思模式通过迭代改进提升输出质量，人机协作模式在关键节点引入人工判断。</p>
<p>本文将深入介绍这五种核心 Agent 设计模式，通过理论讲解与实战案例，帮助你快速掌握每种模式的工作原理、适用场景和实现要点。</p>
<h1 id="一、ReAct-模式"><a href="#一、ReAct-模式" class="headerlink" title="一、ReAct 模式"></a>一、ReAct 模式</h1><h2 id="1-1-什么是-ReAct"><a href="#1-1-什么是-ReAct" class="headerlink" title="1.1 什么是 ReAct"></a>1.1 什么是 ReAct</h2><p>ReAct（Reasoning + Acting）是一种将推理（Reasoning）和行动（Acting）相结合的 Agent 设计模式。它的核心思想是让 LLM 在解决问题时，不是一次性给出答案，而是模拟人类的思维过程：<strong>边思考、边行动、边观察结果，然后继续思考</strong>。</p>
<p>这种模式特别适合处理需要外部信息或工具支持的任务。通过将复杂问题分解为多个”思考-行动-观察”的小步骤，Agent 能够逐步逼近最终答案，整个过程更加透明、可控。</p>
<h2 id="1-2-工作流程"><a href="#1-2-工作流程" class="headerlink" title="1.2 工作流程"></a>1.2 工作流程</h2><p>ReAct 的核心流程可以概括为一个循环：Thought → Action → Observation → Thought。在每次循环中，Agent 首先进行思考阶段，分析当前问题和已有信息，决定下一步需要采取什么行动。例如，当需要查询股票价格时，Agent 会思考”我需要查询青岛啤酒的股票收盘价”。</p>
<p>接着进入行动阶段，Agent 选择合适的工具并指定参数，如 <code>Action: get_closing_price</code> 和 <code>Action Input: {&quot;name&quot;: &quot;青岛啤酒&quot;}</code>。工具执行后进入观察阶段，将执行结果反馈给 Agent，例如 <code>Observation: 67.92</code>。Agent 收到观察结果后，会判断问题是否已经解决。如果未解决，则继续下一轮思考-行动-观察循环；如果已解决，则输出最终答案。</p>
<p><img src="/2025/11/18/ai-patterns/react-workflow.png" alt="ReAct 工作流程"></p>
<p>流程图展示了 ReAct 的完整执行过程。在底部的主流程中，Input 经过 LLM 推理后依次生成 Thought、Action、Action Input 和 PAUSE 标记。PAUSE 触发工具执行，执行结果形成 Observation 并返回给 LLM，由此形成一个闭环。当 LLM 判断已获得足够信息时，会从 Thought 节点输出 Final Answer，结束整个流程。</p>
<h2 id="1-3-实战案例"><a href="#1-3-实战案例" class="headerlink" title="1.3 实战案例"></a>1.3 实战案例</h2><h2 id="案例：比较两个股票的收盘价"><a href="#案例：比较两个股票的收盘价" class="headerlink" title="案例：比较两个股票的收盘价"></a>案例：比较两个股票的收盘价</h2><p><strong>任务：</strong> 请比较青岛啤酒和贵州茅台的股票收盘价谁高？</p>
<h2 id="核心代码实现"><a href="#核心代码实现" class="headerlink" title="核心代码实现"></a>核心代码实现</h2><p><strong>1. 工具定义与注册</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 工具定义（JSON Schema 格式）</span></span><br><span class="line"><span class="keyword">const</span> tools = [</span><br><span class="line">  &#123;</span><br><span class="line">    name: <span class="string">'get_closing_price'</span>,</span><br><span class="line">    description: <span class="string">'使用该工具获取指定股票的收盘价'</span>,</span><br><span class="line">    parameters: &#123;</span><br><span class="line">      <span class="keyword">type</span>: <span class="string">'object'</span>,</span><br><span class="line">      properties: &#123;</span><br><span class="line">        name: &#123;<span class="keyword">type</span>: <span class="string">'string'</span>, description: <span class="string">'股票名称'</span>&#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">      required: [<span class="string">'name'</span>],</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">// 工具注册表（工具名 -&gt; 实现函数）</span></span><br><span class="line"><span class="keyword">const</span> toolRegistry = &#123;</span><br><span class="line">  get_closing_price: <span class="function">(<span class="params">params</span>) =&gt;</span> getClosingPrice(params.name),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>2. Prompt 模板（关键部分）</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> REACT_PROMPT = <span class="string">`</span></span><br><span class="line"><span class="string">You run in a loop of Thought, Action, Action Input, PAUSE, Observation.</span></span><br><span class="line"><span class="string">At the end of the loop you output an Answer.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Your available actions are: &#123;tools&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Example:</span></span><br><span class="line"><span class="string">Question: 今天北京天气怎么样？</span></span><br><span class="line"><span class="string">Thought: 我需要调用 get_weather 工具获取天气</span></span><br><span class="line"><span class="string">Action: get_weather</span></span><br><span class="line"><span class="string">Action Input: &#123;"city": "BeiJing"&#125;</span></span><br><span class="line"><span class="string">PAUSE</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Observation: 北京的气温是0度.</span></span><br><span class="line"><span class="string">Final Answer: 北京的气温是0度.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">New input: &#123;input&#125;`</span></span><br></pre></td></tr></table></figure>
<p><strong>3. Agent 主循环（核心逻辑）</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">reactAgent</span>(<span class="params">query: <span class="built_in">string</span></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 构建初始提示词</span></span><br><span class="line">  <span class="keyword">const</span> prompt = REACT_PROMPT.replace(<span class="string">'&#123;tools&#125;'</span>, <span class="built_in">JSON</span>.stringify(tools)).replace(</span><br><span class="line">    <span class="string">'&#123;input&#125;'</span>,</span><br><span class="line">    query</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> messages = [&#123;role: <span class="string">'user'</span>, content: prompt&#125;]</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="comment">// 1. 调用 LLM</span></span><br><span class="line">    <span class="keyword">const</span> response = <span class="keyword">await</span> llm.chat(messages)</span><br><span class="line">    <span class="keyword">const</span> text = response.content</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 检查是否有最终答案</span></span><br><span class="line">    <span class="keyword">if</span> (text.includes(<span class="string">'Final Answer:'</span>)) &#123;</span><br><span class="line">      <span class="keyword">return</span> text.match(<span class="regexp">/Final Answer:\s*(.*)/</span>)[<span class="number">1</span>]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 解析 Action 和 Action Input</span></span><br><span class="line">    <span class="keyword">const</span> action = text.match(<span class="regexp">/Action:\s*(\w+)/</span>)?.[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">const</span> input = text.match(<span class="regexp">/Action Input:\s*(&#123;.*&#125;)/</span>s)?.[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!action || !input) <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. 执行工具</span></span><br><span class="line">    <span class="keyword">const</span> params = <span class="built_in">JSON</span>.parse(input)</span><br><span class="line">    <span class="keyword">const</span> observation = <span class="keyword">await</span> toolRegistry[action](params)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5. 将 LLM 响应和 Observation 加入历史</span></span><br><span class="line">    messages.push(</span><br><span class="line">      &#123;role: <span class="string">'assistant'</span>, content: text&#125;,</span><br><span class="line">      &#123;role: <span class="string">'user'</span>, content: <span class="string">`Observation: <span class="subst">$&#123;observation&#125;</span>`</span>&#125;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Agent 的执行逻辑相对简单直接。首先用 Prompt 模板初始化消息，将工具列表和用户问题注入其中。然后进入主循环，不断调用 LLM 直到出现 <code>Final Answer</code> 标记。在每次循环中，解析 LLM 输出的 <code>Action</code> 和 <code>Action Input</code>，从工具注册表中找到对应的工具函数并执行，最后将执行结果作为 Observation 反馈给 LLM，开启下一轮循环。</p>
<h2 id="运行结果示例"><a href="#运行结果示例" class="headerlink" title="运行结果示例"></a>运行结果示例</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">第一轮：</span><br><span class="line">Thought: 我需要获取青岛啤酒的股票收盘价</span><br><span class="line">Action: get_closing_price</span><br><span class="line">Action Input: &#123;&quot;name&quot;: &quot;青岛啤酒&quot;&#125;</span><br><span class="line">→ Observation: 67.92</span><br><span class="line"></span><br><span class="line">第二轮：</span><br><span class="line">Thought: 现在需要获取贵州茅台的收盘价</span><br><span class="line">Action: get_closing_price</span><br><span class="line">Action Input: &#123;&quot;name&quot;: &quot;贵州茅台&quot;&#125;</span><br><span class="line">→ Observation: 1488.21</span><br><span class="line"></span><br><span class="line">最终答案：</span><br><span class="line">贵州茅台的股票收盘价（1488.21）比青岛啤酒（67.92）高得多</span><br></pre></td></tr></table></figure>
<h2 id="1-4-使用-Function-Call-来实现"><a href="#1-4-使用-Function-Call-来实现" class="headerlink" title="1.4 使用 Function Call 来实现"></a>1.4 使用 Function Call 来实现</h2><p>前面展示的是经典的 ReAct 模式实现，需要通过 Prompt 让 LLM 输出特定格式（Thought/Action/Observation），然后手动解析这些文本。而现代 LLM API 都支持 <strong>Function Calling</strong>（函数调用），这让 ReAct 的实现变得更简单、更可靠。</p>
<h2 id="核心代码实现-1"><a href="#核心代码实现-1" class="headerlink" title="核心代码实现"></a>核心代码实现</h2><p><strong>1. 工具定义（标准 OpenAI 格式）</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;ChatCompletionTool&#125; <span class="keyword">from</span> <span class="string">'openai/resources/chat/completions'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> tools: ChatCompletionTool[] = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">type</span>: <span class="string">'function'</span>,</span><br><span class="line">    <span class="function"><span class="keyword">function</span>: </span>&#123;</span><br><span class="line">      name: <span class="string">'get_closing_price'</span>,</span><br><span class="line">      description: <span class="string">'使用该工具获取指定股票的收盘价'</span>,</span><br><span class="line">      parameters: &#123;</span><br><span class="line">        <span class="keyword">type</span>: <span class="string">'object'</span>,</span><br><span class="line">        properties: &#123;</span><br><span class="line">          name: &#123;</span><br><span class="line">            <span class="keyword">type</span>: <span class="string">'string'</span>,</span><br><span class="line">            description: <span class="string">'股票名称'</span>,</span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">        required: [<span class="string">'name'</span>],</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">// 工具注册表</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> toolRegistry: Record&lt;<span class="built_in">string</span>, <span class="function">(<span class="params">params: <span class="built_in">any</span></span>) =&gt;</span> <span class="built_in">string</span>&gt; = &#123;</span><br><span class="line">  get_closing_price: <span class="function">(<span class="params">params</span>) =&gt;</span> getClosingPrice(params.name),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>2. Agent 主循环（Function Call 版本）</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="function"><span class="keyword">function</span><span class="title">CallAgent</span>(<span class="params">query: <span class="built_in">string</span></span>) </span>&#123;</span></span><br><span class="line"><span class="function">  <span class="title">const</span> <span class="title">messages</span>: <span class="title">ChatCompletionMessageParam</span>[] = [</span></span><br><span class="line"><span class="function">    </span>&#123;role: <span class="string">'user'</span>, content: query&#125;,</span><br><span class="line">  ]</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="comment">// 1. 调用 LLM，传入 tools 配置</span></span><br><span class="line">    <span class="keyword">const</span> response = <span class="keyword">await</span> client.chat.completions.create(&#123;</span><br><span class="line">      model: <span class="string">'gpt-4o'</span>,</span><br><span class="line">      messages,</span><br><span class="line">      tools,</span><br><span class="line">      tool_choice: <span class="string">'auto'</span>, <span class="comment">// LLM 自动决定是否调用工具</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> choice = response.choices[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">if</span> (!choice?.message) <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> toolCalls = choice.message.tool_calls</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 如果没有工具调用，说明已经得到最终答案</span></span><br><span class="line">    <span class="keyword">if</span> (!toolCalls || toolCalls.length === <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'最终答案:'</span>, choice.message.content)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 执行工具调用</span></span><br><span class="line">    messages.push(choice.message) <span class="comment">// 保存 LLM 的工具调用请求</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> toolCall of toolCalls) &#123;</span><br><span class="line">      <span class="keyword">if</span> (toolCall.type === <span class="string">'function'</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> toolName = toolCall.function.name</span><br><span class="line">        <span class="keyword">const</span> args = <span class="built_in">JSON</span>.parse(toolCall.function.arguments)</span><br><span class="line">        <span class="keyword">const</span> toolFunc = toolRegistry[toolName]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (toolFunc) &#123;</span><br><span class="line">          <span class="keyword">const</span> result = toolFunc(args)</span><br><span class="line"></span><br><span class="line">          <span class="comment">// 4. 将工具执行结果返回给 LLM</span></span><br><span class="line">          messages.push(&#123;</span><br><span class="line">            role: <span class="string">'tool'</span>,</span><br><span class="line">            content: result,</span><br><span class="line">            tool_call_id: toolCall.id,</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="1-5-使用-LangGraph-实现"><a href="#1-5-使用-LangGraph-实现" class="headerlink" title="1.5 使用 LangGraph 实现"></a>1.5 使用 LangGraph 实现</h2><p>对于复杂的 Agent 场景（需要记忆、反思、人工介入等），LangGraph 提供了声明式的图结构定义，更易于维护和扩展。</p>
<p>LangGraph 将 Agent 建模为状态图，其中节点代表执行具体任务的函数，边定义节点之间的转换规则，而状态则是在各个节点之间传递的数据。这种抽象让 Agent 的执行流程更加清晰可控。</p>
<p><img src="/2025/11/18/ai-patterns/langgraph-workflow.png" alt="LangGraph 工作流程"></p>
<h2 id="核心代码"><a href="#核心代码" class="headerlink" title="核心代码"></a>核心代码</h2><p><strong>构建图：</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;StateGraph, END&#125; <span class="keyword">from</span> <span class="string">'@langchain/langgraph'</span></span><br><span class="line"><span class="keyword">import</span> &#123;Annotation&#125; <span class="keyword">from</span> <span class="string">'@langchain/langgraph'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. 定义状态</span></span><br><span class="line"><span class="keyword">const</span> GraphState = Annotation.Root(&#123;</span><br><span class="line">  messages: Annotation&lt;BaseMessage[]&gt;(&#123;</span><br><span class="line">    reducer: <span class="function">(<span class="params">x, y</span>) =&gt;</span> x.concat(y),</span><br><span class="line">    <span class="keyword">default</span>: <span class="function"><span class="params">()</span> =&gt;</span> [],</span><br><span class="line">  &#125;),</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 定义节点</span></span><br><span class="line"><span class="keyword">const</span> llm = <span class="keyword">new</span> ChatOpenAI(&#123;model: <span class="string">'gpt-4o'</span>&#125;).bindTools(tools)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">callModel</span>(<span class="params">state: <span class="keyword">typeof</span> GraphState.State</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> response = <span class="keyword">await</span> llm.invoke(state.messages)</span><br><span class="line">  <span class="keyword">return</span> &#123;messages: [response]&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">callTools</span>(<span class="params">state: <span class="keyword">typeof</span> GraphState.State</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> lastMessage = state.messages[state.messages.length - <span class="number">1</span>]</span><br><span class="line">  <span class="keyword">const</span> toolMessages = <span class="keyword">await</span> <span class="built_in">Promise</span>.all(</span><br><span class="line">    lastMessage.tool_calls.map(<span class="keyword">async</span> (tc) =&gt; &#123;</span><br><span class="line">      <span class="keyword">const</span> tool = tools.find(<span class="function">(<span class="params">t</span>) =&gt;</span> t.name === tc.name)</span><br><span class="line">      <span class="keyword">const</span> result = <span class="keyword">await</span> tool.invoke(tc.args)</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> ToolMessage(&#123;content: <span class="built_in">String</span>(result), tool_call_id: tc.id&#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  )</span><br><span class="line">  <span class="keyword">return</span> &#123;messages: toolMessages&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 路由函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">shouldContinue</span>(<span class="params">state: <span class="keyword">typeof</span> GraphState.State</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> lastMessage = state.messages[state.messages.length - <span class="number">1</span>]</span><br><span class="line">  <span class="keyword">return</span> lastMessage.tool_calls?.length &gt; <span class="number">0</span> ? <span class="string">'tools'</span> : END</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. 构建图</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">buildGraph</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> StateGraph(GraphState)</span><br><span class="line">    .addNode(<span class="string">'agent'</span>, callModel)</span><br><span class="line">    .addNode(<span class="string">'tools'</span>, callTools)</span><br><span class="line">    .addEdge(<span class="string">'__start__'</span>, <span class="string">'agent'</span>)</span><br><span class="line">    .addConditionalEdges(<span class="string">'agent'</span>, shouldContinue)</span><br><span class="line">    .addEdge(<span class="string">'tools'</span>, <span class="string">'agent'</span>)</span><br><span class="line">    .compile()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5. 运行</span></span><br><span class="line"><span class="keyword">const</span> app = buildGraph()</span><br><span class="line"><span class="keyword">await</span> app.invoke(&#123;messages: [<span class="keyword">new</span> HumanMessage(<span class="string">'问题'</span>)]&#125;)</span><br></pre></td></tr></table></figure>
<p>其实 <code>@langchain/langgraph</code> 提供了 <code>createReactAgent</code>，可以更加方便的实现类似功能：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;createReactAgent&#125; <span class="keyword">from</span> <span class="string">'@langchain/langgraph/prebuilt'</span></span><br><span class="line"><span class="keyword">import</span> &#123;ChatOpenAI&#125; <span class="keyword">from</span> <span class="string">'@langchain/openai'</span></span><br><span class="line"><span class="keyword">import</span> &#123;tool&#125; <span class="keyword">from</span> <span class="string">'@langchain/core/tools'</span></span><br><span class="line"><span class="keyword">import</span> &#123;z&#125; <span class="keyword">from</span> <span class="string">'zod'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义工具</span></span><br><span class="line"><span class="keyword">const</span> getClosingPriceTool = tool(</span><br><span class="line">  (input) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> name = (input <span class="keyword">as</span> &#123;name: <span class="built_in">string</span>&#125;).name</span><br><span class="line">    <span class="keyword">if</span> (name === <span class="string">'青岛啤酒'</span>) <span class="keyword">return</span> <span class="string">'67.92'</span></span><br><span class="line">    <span class="keyword">if</span> (name === <span class="string">'贵州茅台'</span>) <span class="keyword">return</span> <span class="string">'1488.21'</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'未搜到该股票'</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    name: <span class="string">'get_closing_price'</span>,</span><br><span class="line">    description: <span class="string">'获取指定股票的收盘价'</span>,</span><br><span class="line">    schema: z.object(&#123;name: z.string().describe(<span class="string">'股票名称'</span>)&#125;),</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建 Agent（一行代码）</span></span><br><span class="line"><span class="keyword">const</span> agent = createReactAgent(&#123;</span><br><span class="line">  llm: <span class="keyword">new</span> ChatOpenAI(&#123;model: <span class="string">'gpt-4o'</span>&#125;),</span><br><span class="line">  tools: [getClosingPriceTool],</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 运行</span></span><br><span class="line"><span class="keyword">const</span> result = <span class="keyword">await</span> agent.invoke(&#123;</span><br><span class="line">  messages: [&#123;role: <span class="string">'user'</span>, content: <span class="string">'比较青岛啤酒和贵州茅台的收盘价'</span>&#125;],</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="1-6-适用场景"><a href="#1-6-适用场景" class="headerlink" title="1.6 适用场景"></a>1.6 适用场景</h2><p>ReAct 模式特别适合需要外部信息或工具支持的任务。当问题无法仅凭 LLM 内部知识解决时，比如查询实时数据、调用 API、执行计算等，ReAct 通过工具调用弥补了 LLM 的能力边界。这种模式对于多步骤推理任务也很有效，Agent 可以逐步收集信息、分析结果、调整策略，最终得出答案。同时，ReAct 的透明性让整个推理过程可观察可调试，便于理解 Agent 的决策逻辑。</p>
<h2 id="1-7-注意事项"><a href="#1-7-注意事项" class="headerlink" title="1.7 注意事项"></a>1.7 注意事项</h2><p>实现 ReAct 模式时需要注意几个关键点。Prompt 设计至关重要，需要清晰地定义 Thought、Action、Observation 的格式，并提供足够的示例帮助 LLM 理解预期输出。工具描述要准确明确，让 LLM 能够正确选择和使用工具。同时要设置合理的迭代次数上限，避免陷入无限循环。错误处理机制也不可忽视，当工具调用失败或 LLM 输出格式错误时，需要有恰当的降级策略。此外，要注意 Token 消耗，因为每次迭代都会增加消息历史的长度。</p>
<h1 id="二、CodeAct-模式"><a href="#二、CodeAct-模式" class="headerlink" title="二、CodeAct 模式"></a>二、CodeAct 模式</h1><h2 id="2-1-核心理念"><a href="#2-1-核心理念" class="headerlink" title="2.1 核心理念"></a>2.1 核心理念</h2><p>CodeAct（Code as Action）让 Agent 通过生成并执行代码来完成任务。与 ReAct 调用预定义工具不同，CodeAct 赋予 Agent 更大的灵活性，特别适合复杂计算、数据处理或需要组合多个操作的场景。核心流程是：Thought → Code Generation → Code Execution → Observation。</p>
<h2 id="2-2-工作流程"><a href="#2-2-工作流程" class="headerlink" title="2.2 工作流程"></a>2.2 工作流程</h2><p><img src="/2025/11/18/ai-patterns/codeact-workflow.png" alt="CodeAct 工作流程"></p>
<p>CodeAct 的执行流程从 LLM 分析用户问题开始，理解需要完成什么任务。接着 LLM 生成对应的代码（通常是 Python 或 JavaScript），这些代码会在沙箱环境中执行以保证安全性。执行结果作为 Observation 返回给 LLM，LLM 根据结果判断是继续生成新代码完善方案，还是已经得到满意答案可以结束流程。</p>
<h2 id="2-3-实战案例"><a href="#2-3-实战案例" class="headerlink" title="2.3 实战案例"></a>2.3 实战案例</h2><p><strong>需求：</strong> 计算 1~100 的和</p>
<h2 id="核心代码-1"><a href="#核心代码-1" class="headerlink" title="核心代码"></a>核心代码</h2><p><strong>1. 提示词（Prompt）</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// prompts.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> SYSTEM_PROMPT = <span class="string">`你是一个能够编写和执行代码的智能助手。</span></span><br><span class="line"><span class="string">当用户提出问题时，你需要：</span></span><br><span class="line"><span class="string">1. 分析问题并确定需要编写什么代码</span></span><br><span class="line"><span class="string">2. 编写能解决问题的 JavaScript 代码</span></span><br><span class="line"><span class="string">3. 代码必须将最终结果存储在 'result' 变量中</span></span><br><span class="line"><span class="string">4. 将代码包裹在 \`\`\`javascript 代码块中</span></span><br><span class="line"><span class="string">5. 分析执行结果，如果有错误则修改代码再次执行</span></span><br><span class="line"><span class="string">6. 最终给用户提供答案`</span></span><br></pre></td></tr></table></figure>
<p><strong>2. 工具（代码执行器）</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// tools.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123;z&#125; <span class="keyword">from</span> <span class="string">'zod'</span></span><br><span class="line"><span class="keyword">import</span> &#123;tool&#125; <span class="keyword">from</span> <span class="string">'@langchain/core/tools'</span></span><br><span class="line"><span class="keyword">import</span> vm <span class="keyword">from</span> <span class="string">'vm'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> executePythonTool = tool(</span><br><span class="line">  (input) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> code = (input <span class="keyword">as</span> &#123;code: <span class="built_in">string</span>&#125;).code</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'执行代码:\n'</span>, code)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 使用 vm 创建沙箱环境</span></span><br><span class="line">      <span class="keyword">const</span> context = &#123;result: <span class="literal">undefined</span>, <span class="built_in">console</span>&#125;</span><br><span class="line">      vm.createContext(context)</span><br><span class="line">      vm.runInContext(code, context, &#123;timeout: <span class="number">5000</span>&#125;)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> result = context.result ?? <span class="string">'执行成功'</span></span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'执行结果:\n'</span>, result)</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">String</span>(result)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error: <span class="built_in">any</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">`代码执行错误: <span class="subst">$&#123;error.message&#125;</span>`</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    name: <span class="string">'execute_javascript'</span>,</span><br><span class="line">    description: <span class="string">'执行 JavaScript 代码并返回结果'</span>,</span><br><span class="line">    schema: z.object(&#123;</span><br><span class="line">      code: z.string().describe(<span class="string">'要执行的 JavaScript 代码'</span>),</span><br><span class="line">    &#125;),</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p><strong>3. Agent 逻辑（LangGraph）</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// graph.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123;StateGraph, END&#125; <span class="keyword">from</span> <span class="string">'@langchain/langgraph'</span></span><br><span class="line"><span class="keyword">import</span> &#123;Annotation&#125; <span class="keyword">from</span> <span class="string">'@langchain/langgraph'</span></span><br><span class="line"><span class="keyword">import</span> &#123;ChatOpenAI&#125; <span class="keyword">from</span> <span class="string">'@langchain/openai'</span></span><br><span class="line"><span class="keyword">import</span> &#123;AIMessage, HumanMessage, SystemMessage&#125; <span class="keyword">from</span> <span class="string">'@langchain/core/messages'</span></span><br><span class="line"><span class="keyword">import</span> &#123;SYSTEM_PROMPT&#125; <span class="keyword">from</span> <span class="string">'./prompts'</span></span><br><span class="line"><span class="keyword">import</span> &#123;executePythonTool&#125; <span class="keyword">from</span> <span class="string">'./tools'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义状态</span></span><br><span class="line"><span class="keyword">const</span> CodeActState = Annotation.Root(&#123;</span><br><span class="line">  messages: Annotation&lt;<span class="built_in">any</span>[]&gt;(&#123;</span><br><span class="line">    reducer: <span class="function">(<span class="params">x, y</span>) =&gt;</span> x.concat(y),</span><br><span class="line">    <span class="keyword">default</span>: <span class="function"><span class="params">()</span> =&gt;</span> [],</span><br><span class="line">  &#125;),</span><br><span class="line">  output: Annotation&lt;<span class="built_in">string</span>&gt;<span class="function">(<span class="params">&#123;<span class="keyword">default</span>: (<span class="params"></span>) =&gt; ''&#125;</span>),</span></span><br><span class="line"><span class="function">  <span class="params">userPrompt</span>: <span class="params">Annotation</span>&lt;<span class="params">string</span>&gt;(<span class="params">&#123;<span class="keyword">default</span>: (<span class="params"></span>) =&gt; ''&#125;</span>),</span></span><br><span class="line"><span class="function">&#125;)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="params">const</span> <span class="params">llm</span> = <span class="params">new</span> <span class="params">ChatOpenAI</span>(<span class="params">&#123;model: 'gpt-4o'&#125;</span>)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">// 提取代码</span></span><br><span class="line"><span class="function"><span class="params">function</span> <span class="params">extractCode</span>(<span class="params">content: <span class="built_in">string</span></span>) &#123;</span></span><br><span class="line"><span class="function">  <span class="params">if</span> (<span class="params">content.includes(<span class="params">'```javascript'</span>)</span>) &#123;</span></span><br><span class="line"><span class="function">    <span class="params">const</span> <span class="params">blocks</span> = <span class="params">content</span>.<span class="params">split</span>(<span class="params">'```javascript'</span>)</span></span><br><span class="line"><span class="function">    <span class="params">const</span> <span class="params">code</span> = <span class="params">blocks</span>[1].<span class="params">split</span>(<span class="params">'```'</span>)[0].<span class="params">trim</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    <span class="params">return</span> <span class="params">code</span></span></span><br><span class="line"><span class="function">  &#125;</span></span><br><span class="line"><span class="function">  <span class="params">return</span> <span class="params">null</span></span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">// <span class="params">LLM</span> 节点</span></span><br><span class="line"><span class="function"><span class="params">async</span> <span class="params">function</span> <span class="params">llmCall</span>(<span class="params">state: <span class="keyword">typeof</span> CodeActState.State</span>) &#123;</span></span><br><span class="line"><span class="function">  <span class="params">const</span> <span class="params">messages</span> = [</span></span><br><span class="line"><span class="function">    <span class="params">new</span> <span class="params">SystemMessage</span>(<span class="params">SYSTEM_PROMPT</span>),</span></span><br><span class="line"><span class="function">    <span class="params">new</span> <span class="params">HumanMessage</span>(<span class="params">state.userPrompt</span>),</span></span><br><span class="line"><span class="function">    ...<span class="params">state</span>.<span class="params">messages</span>,</span></span><br><span class="line"><span class="function">  ]</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  <span class="params">const</span> <span class="params">response</span> = <span class="params">await</span> <span class="params">llm</span>.<span class="params">invoke</span>(<span class="params">messages</span>)</span></span><br><span class="line"><span class="function">  <span class="params">const</span> <span class="params">code</span> = <span class="params">extractCode</span>(<span class="params">response.content <span class="keyword">as</span> <span class="built_in">string</span></span>)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  <span class="params">if</span> (<span class="params">code</span>) &#123;</span></span><br><span class="line"><span class="function">    <span class="params">return</span> &#123;</span></span><br><span class="line"><span class="function">      <span class="params">messages</span>: [<span class="params">response</span>],</span></span><br><span class="line"><span class="function">      <span class="params">output</span>: '',</span></span><br><span class="line"><span class="function">      <span class="params">code</span>,</span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function">  &#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  <span class="params">return</span> &#123;</span></span><br><span class="line"><span class="function">    <span class="params">messages</span>: [<span class="params">response</span>],</span></span><br><span class="line"><span class="function">    <span class="params">output</span>: <span class="params">response</span>.<span class="params">content</span>,</span></span><br><span class="line"><span class="function">  &#125;</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">// 路由函数</span></span><br><span class="line"><span class="function"><span class="params">function</span> <span class="params">shouldExecute</span>(<span class="params">state: <span class="keyword">typeof</span> CodeActState.State</span>) &#123;</span></span><br><span class="line"><span class="function">  <span class="params">return</span> <span class="params">state</span>.<span class="params">output</span> ? <span class="params">END</span> : '<span class="params">executeNode</span>'</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">// 执行节点</span></span><br><span class="line"><span class="function"><span class="params">async</span> <span class="params">function</span> <span class="params">executeNode</span>(<span class="params">state: <span class="keyword">typeof</span> CodeActState.State</span>) &#123;</span></span><br><span class="line"><span class="function">  <span class="params">const</span> <span class="params">code</span> = (<span class="params">state <span class="keyword">as</span> <span class="built_in">any</span></span>).<span class="params">code</span></span></span><br><span class="line"><span class="function">  <span class="params">const</span> <span class="params">result</span> = <span class="params">await</span> <span class="params">executePythonTool</span>.<span class="params">invoke</span>(<span class="params">&#123;code&#125;</span>)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  <span class="params">return</span> &#123;</span></span><br><span class="line"><span class="function">    <span class="params">messages</span>: [<span class="params">new</span> <span class="params">HumanMessage</span>(<span class="params">`## 执行结果:\n$&#123;result&#125;`</span>)],</span></span><br><span class="line"><span class="function">  &#125;</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">// 构建图</span></span><br><span class="line"><span class="function"><span class="params">export</span> <span class="params">function</span> <span class="params">buildCodeActGraph</span><span class="params">()</span> &#123;</span></span><br><span class="line"><span class="function">  <span class="params">return</span> <span class="params">new</span> <span class="params">StateGraph</span>(<span class="params">CodeActState</span>)</span></span><br><span class="line"><span class="function">    .<span class="params">addNode</span>(<span class="params">'llmCall', llmCall</span>)</span></span><br><span class="line"><span class="function">    .<span class="params">addNode</span>(<span class="params">'executeNode', executeNode</span>)</span></span><br><span class="line"><span class="function">    .<span class="params">addEdge</span>(<span class="params">'__start__', 'llmCall'</span>)</span></span><br><span class="line"><span class="function">    .<span class="params">addConditionalEdges</span>(<span class="params">'llmCall', shouldExecute</span>)</span></span><br><span class="line"><span class="function">    .<span class="params">addEdge</span>(<span class="params">'executeNode', 'llmCall'</span>)</span></span><br><span class="line"><span class="function">    .<span class="params">compile</span><span class="params">()</span></span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure>
<p><strong>4. 运行</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> agent = buildCodeActGraph()</span><br><span class="line"><span class="keyword">const</span> result = <span class="keyword">await</span> agent.invoke(&#123;</span><br><span class="line">  userPrompt: <span class="string">'请计算 1~100 的和'</span>,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="built_in">console</span>.log(result.output)</span><br></pre></td></tr></table></figure>
<h2 id="运行效果"><a href="#运行效果" class="headerlink" title="运行效果"></a>运行效果</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[启动 CodeAct Agent]</span><br><span class="line">[用户问题] 请计算 1~100 的和</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[LLM 节点] 分析问题...</span><br><span class="line">[生成代码]</span><br><span class="line"></span><br><span class="line">[执行节点] 运行代码...</span><br><span class="line">## 执行代码:</span><br><span class="line"> let n = 100;</span><br><span class="line">let result = (n * (n + 1)) / 2;</span><br><span class="line">result;</span><br><span class="line">## 执行结果:</span><br><span class="line"> 执行成功</span><br><span class="line"></span><br><span class="line">[LLM 节点] 分析问题...</span><br><span class="line">[直接给出答案]</span><br><span class="line"></span><br><span class="line">[完成]</span><br><span class="line"></span><br><span class="line">[最终答案]</span><br><span class="line"> 很好！结果表明，1 到 100 的和是 5050。您是否还有其他数学问题或需要进一步的帮助？</span><br></pre></td></tr></table></figure>
<p>从结果可以看到，大模型并没有使用循环，而是用等差数列求和公式来实现的，有点聪明的样子。</p>
<h2 id="2-4-适用场景"><a href="#2-4-适用场景" class="headerlink" title="2.4 适用场景"></a>2.4 适用场景</h2><p>CodeAct 模式特别适合需要灵活处理数据或进行复杂计算的场景。当任务涉及数学计算、数据转换、文本处理、算法实现等需要编程逻辑的操作时，生成代码往往比调用预定义工具更加高效和灵活。同时，对于需要组合多个操作或处理非标准化数据的任务，CodeAct 也展现出明显优势。这种模式让 Agent 不再局限于现有工具的能力边界，可以根据具体需求动态生成解决方案。</p>
<h2 id="2-5-注意事项"><a href="#2-5-注意事项" class="headerlink" title="2.5 注意事项"></a>2.5 注意事项</h2><p>使用 CodeAct 模式时必须高度重视安全性问题。代码执行必须在沙箱环境中进行，避免恶意代码对系统造成破坏。建议使用 vm 模块或 Docker 容器等隔离机制，并设置执行超时限制防止无限循环。此外，生成的代码质量依赖于 LLM 的能力，可能存在语法错误或逻辑错误，需要完善的错误处理机制。对于生产环境，还应该记录所有执行的代码以便审计和调试。</p>
<h1 id="三、计划模式（Plan-Mode）"><a href="#三、计划模式（Plan-Mode）" class="headerlink" title="三、计划模式（Plan Mode）"></a>三、计划模式（Plan Mode）</h1><h2 id="3-1-核心理念"><a href="#3-1-核心理念" class="headerlink" title="3.1 核心理念"></a>3.1 核心理念</h2><p>计划模式采用”先计划，后执行”的策略。ReAct 每步都需重新思考，适合探索性任务；计划模式则在开始时制定完整方案再逐步执行，更适合结构化程度高的任务。优势在于执行路径清晰、便于监控进度和预测资源消耗。但灵活性较低，初始计划不准确时可能需要人工调整。</p>
<h2 id="3-2-工作流程"><a href="#3-2-工作流程" class="headerlink" title="3.2 工作流程"></a>3.2 工作流程</h2><p><img src="/2025/11/18/ai-patterns/plan-workflow.png" alt="Plan 工作流程"></p>
<h2 id="3-3-实战案例-简单计划模式"><a href="#3-3-实战案例-简单计划模式" class="headerlink" title="3.3 实战案例:简单计划模式"></a>3.3 实战案例:简单计划模式</h2><p><strong>需求：</strong> 比较茅台和青岛啤酒哪个贵？</p>
<h2 id="核心代码-2"><a href="#核心代码-2" class="headerlink" title="核心代码"></a>核心代码</h2><p><strong>1. 计划生成提示词</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// prompts.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> PLAN_PROMPT = <span class="string">`你是一个金融分析师，擅长对股票的收盘价进行比较。</span></span><br><span class="line"><span class="string">请为用户提出的问题创建分析方案步骤：</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">可调用工具列表：</span></span><br><span class="line"><span class="string">get_closing_price: 根据股票名称获取收盘价</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">要求：</span></span><br><span class="line"><span class="string">1. 用中文列出清晰步骤</span></span><br><span class="line"><span class="string">2. 每个步骤标记序号</span></span><br><span class="line"><span class="string">3. 明确说明需要分析和执行的内容</span></span><br><span class="line"><span class="string">4. 只需输出计划内容，不要做任何额外的解释和说明`</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> PLAN_EXECUTE_PROMPT = <span class="string">`你是一个思路清晰，有条理的金融分析师，</span></span><br><span class="line"><span class="string">必须严格按照以下计划执行：</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">当前计划：</span></span><br><span class="line"><span class="string">&#123;plan&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">如果你认为计划已经执行到最后一步了，请在内容的末尾加上 Final Answer 字样`</span></span><br></pre></td></tr></table></figure>
<p><strong>2. 状态定义</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// types.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> PlanState = Annotation.Root(&#123;</span><br><span class="line">  messages: Annotation&lt;BaseMessage[]&gt;(&#123;</span><br><span class="line">    reducer: <span class="function">(<span class="params">x, y</span>) =&gt;</span> x.concat(y),</span><br><span class="line">    <span class="keyword">default</span>: <span class="function"><span class="params">()</span> =&gt;</span> [],</span><br><span class="line">  &#125;),</span><br><span class="line">  plan: Annotation&lt;<span class="built_in">string</span>&gt;(&#123;</span><br><span class="line">    reducer: <span class="function">(<span class="params">x, y</span>) =&gt;</span> y ?? x,</span><br><span class="line">    <span class="keyword">default</span>: <span class="function"><span class="params">()</span> =&gt;</span> <span class="string">''</span>,</span><br><span class="line">  &#125;),</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><strong>3. 工作流构建</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// graph.ts</span></span><br><span class="line"><span class="comment">// 计划节点：生成执行计划</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">planNode</span>(<span class="params">state: <span class="keyword">typeof</span> PlanState.State</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> response = <span class="keyword">await</span> llm.invoke([</span><br><span class="line">    <span class="keyword">new</span> SystemMessage(PLAN_PROMPT),</span><br><span class="line">    state.messages[<span class="number">0</span>],</span><br><span class="line">  ])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> plan = response.content <span class="keyword">as</span> <span class="built_in">string</span></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'[计划内容]\n'</span>, plan)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;plan&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行节点：按计划执行并调用工具</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">executeNode</span>(<span class="params">state: <span class="keyword">typeof</span> PlanState.State</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> messages = [</span><br><span class="line">    <span class="keyword">new</span> SystemMessage(PLAN_EXECUTE_PROMPT.replace(<span class="string">'&#123;plan&#125;'</span>, state.plan)),</span><br><span class="line">    ...state.messages,</span><br><span class="line">  ]</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> response = <span class="keyword">await</span> llmWithTools.invoke(messages)</span><br><span class="line">  <span class="keyword">return</span> &#123;messages: [response]&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 工具节点：执行工具调用</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">toolNode</span>(<span class="params">state: <span class="keyword">typeof</span> PlanState.State</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> lastMessage = state.messages[state.messages.length - <span class="number">1</span>]</span><br><span class="line">  <span class="keyword">const</span> toolCalls = lastMessage.tool_calls || []</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> toolMessages = <span class="keyword">await</span> <span class="built_in">Promise</span>.all(</span><br><span class="line">    toolCalls.map(<span class="keyword">async</span> (tc) =&gt; &#123;</span><br><span class="line">      <span class="keyword">const</span> tool = toolsByName[tc.name]</span><br><span class="line">      <span class="keyword">const</span> result = <span class="keyword">await</span> tool.invoke(tc.args)</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> ToolMessage(&#123;</span><br><span class="line">        content: <span class="built_in">String</span>(result),</span><br><span class="line">        tool_call_id: tc.id,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;messages: toolMessages&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 路由函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">shouldContinue</span>(<span class="params">state: <span class="keyword">typeof</span> PlanState.State</span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> content = state.messages[state.messages.length - <span class="number">1</span>].content</span><br><span class="line">  <span class="keyword">return</span> content.includes(<span class="string">'Final Answer'</span>) ? END : <span class="string">'toolNode'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 构建图</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">buildPlanGraph</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> StateGraph(PlanState)</span><br><span class="line">    .addNode(<span class="string">'planNode'</span>, planNode)</span><br><span class="line">    .addNode(<span class="string">'executeNode'</span>, executeNode)</span><br><span class="line">    .addNode(<span class="string">'toolNode'</span>, toolNode)</span><br><span class="line">    .addEdge(<span class="string">'__start__'</span>, <span class="string">'planNode'</span>)</span><br><span class="line">    .addEdge(<span class="string">'planNode'</span>, <span class="string">'executeNode'</span>)</span><br><span class="line">    .addConditionalEdges(<span class="string">'executeNode'</span>, shouldContinue)</span><br><span class="line">    .addEdge(<span class="string">'toolNode'</span>, <span class="string">'executeNode'</span>)</span><br><span class="line">    .compile()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="运行效果-1"><a href="#运行效果-1" class="headerlink" title="运行效果"></a>运行效果</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[启动计划模式 Agent]</span><br><span class="line">[用户问题] 茅台和青岛啤酒哪个贵？</span><br><span class="line"></span><br><span class="line">[计划节点] 生成执行计划...</span><br><span class="line">[计划内容]</span><br><span class="line">1. 获取贵州茅台的股票收盘价</span><br><span class="line">2. 获取青岛啤酒的股票收盘价</span><br><span class="line">3. 比较两者的收盘价，确定哪个更贵</span><br><span class="line"></span><br><span class="line">[执行节点] 按计划执行...</span><br><span class="line">[工具节点] 执行工具...</span><br><span class="line">   执行: get_closing_price(&#123;&quot;name&quot;:&quot;贵州茅台&quot;&#125;)</span><br><span class="line">   结果: 1488.21</span><br><span class="line"></span><br><span class="line">[执行节点] 按计划执行...</span><br><span class="line">[工具节点] 执行工具...</span><br><span class="line">   执行: get_closing_price(&#123;&quot;name&quot;:&quot;青岛啤酒&quot;&#125;)</span><br><span class="line">   结果: 67.92</span><br><span class="line"></span><br><span class="line">[执行节点] 按计划执行...</span><br><span class="line">[完成]</span><br><span class="line"></span><br><span class="line">[最终答案]</span><br><span class="line">根据收盘价比较：</span><br><span class="line">- 贵州茅台：1488.21 元</span><br><span class="line">- 青岛啤酒：67.92 元</span><br><span class="line"></span><br><span class="line">结论：贵州茅台更贵</span><br><span class="line">Final Answer</span><br></pre></td></tr></table></figure>
<h2 id="3-4-高级计划模式：动态调整"><a href="#3-4-高级计划模式：动态调整" class="headerlink" title="3.4 高级计划模式：动态调整"></a>3.4 高级计划模式：动态调整</h2><p>简单计划模式的局限是<strong>计划一旦生成就固定不变</strong>。高级计划模式引入了<strong>动态重新规划</strong>能力，可以根据执行结果调整剩余步骤，下面我们来改进一下。</p>
<h2 id="工作流程"><a href="#工作流程" class="headerlink" title="工作流程"></a>工作流程</h2><p><img src="/2025/11/18/ai-patterns/plan-advanced-workflow.png" alt="高级计划模式工作流程"></p>
<h2 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h2><p><strong>1. Prompt 设计</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 执行助手 Prompt（用于 ReAct Agent）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> SYSTEM_PROMPT = <span class="string">`你是一个任务执行助手`</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 计划评估 Prompt（核心：引导 LLM 动态调整计划）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> PLAN_PROMPT = <span class="string">`你是一个计划评估助手，负责根据已完成的步骤评估任务进度，并动态调整后续计划。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">你的目标:</span></span><br><span class="line"><span class="string">&#123;input&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">原始计划:</span></span><br><span class="line"><span class="string">&#123;plan&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">已完成的步骤及结果:</span></span><br><span class="line"><span class="string">&#123;past_steps&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">核心规则：</span></span><br><span class="line"><span class="string">1. 仔细分析已完成步骤的结果</span></span><br><span class="line"><span class="string">2. 根据实际情况调整后续计划：</span></span><br><span class="line"><span class="string">   - 如果发现需要补充新步骤，添加到计划中</span></span><br><span class="line"><span class="string">   - 如果发现某些步骤不再需要，从计划中移除</span></span><br><span class="line"><span class="string">   - 如果发现步骤顺序不合理，调整执行顺序</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">输出格式（必须严格遵守）：</span></span><br><span class="line"><span class="string">- 如果任务已完成：直接输出答案，不要使用列表格式</span></span><br><span class="line"><span class="string">- 如果还需继续：只输出步骤列表（每行一个，使用 "- " 开头）</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">注意：不要在步骤列表中混入解释性文字，只输出纯粹的步骤列表`</span></span><br></pre></td></tr></table></figure>
<p><strong>2. 执行节点（使用 ReAct Agent）</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;createReactAgent&#125; <span class="keyword">from</span> <span class="string">'@langchain/langgraph/prebuilt'</span></span><br><span class="line"><span class="keyword">import</span> &#123;ChatOpenAI&#125; <span class="keyword">from</span> <span class="string">'@langchain/openai'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建 LLM 实例</span></span><br><span class="line"><span class="keyword">const</span> llm = <span class="keyword">new</span> ChatOpenAI(&#123;</span><br><span class="line">  modelName: <span class="string">'gpt-4o'</span>,</span><br><span class="line">  apiKey: process.env.API_KEY || <span class="string">''</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建 ReAct Agent 作为执行器</span></span><br><span class="line"><span class="keyword">const</span> executeAgent = createReactAgent(&#123;</span><br><span class="line">  llm,</span><br><span class="line">  tools, <span class="comment">// 工具列表：getClosingPriceTool, calculatorTool 等</span></span><br><span class="line">  messageModifier: SYSTEM_PROMPT,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行节点：执行当前计划的第一步</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">executeStep</span>(<span class="params">state: <span class="keyword">typeof</span> PlanExecuteState.State</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> plan = state.plan</span><br><span class="line">  <span class="keyword">if</span> (!plan || plan.length === <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;pastSteps: []&#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 格式化任务描述</span></span><br><span class="line">  <span class="keyword">const</span> planStr = plan.map(<span class="function">(<span class="params">step, i</span>) =&gt;</span> <span class="string">`<span class="subst">$&#123;i + 1&#125;</span>. <span class="subst">$&#123;step&#125;</span>`</span>).join(<span class="string">'\n'</span>)</span><br><span class="line">  <span class="keyword">const</span> task = plan[<span class="number">0</span>]</span><br><span class="line">  <span class="keyword">const</span> taskFormatted = <span class="string">`计划有以下几个步骤:\n<span class="subst">$&#123;planStr&#125;</span>\n\n你需要执行 步骤1. <span class="subst">$&#123;task&#125;</span>.`</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 使用 ReAct Agent 执行</span></span><br><span class="line">  <span class="keyword">const</span> agentResponse = <span class="keyword">await</span> executeAgent.invoke(&#123;</span><br><span class="line">    messages: [[<span class="string">'user'</span>, taskFormatted]],</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 提取执行结果</span></span><br><span class="line">  <span class="keyword">const</span> lastMessage = agentResponse.messages[agentResponse.messages.length - <span class="number">1</span>]</span><br><span class="line">  <span class="keyword">const</span> result = lastMessage?.content <span class="keyword">as</span> <span class="built_in">string</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 记录到执行历史</span></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    pastSteps: [[task, result]] <span class="keyword">as</span> <span class="built_in">Array</span>&lt;[<span class="built_in">string</span>, <span class="built_in">string</span>]&gt;,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>3. 规划评估节点（核心：动态调整）</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 规划评估节点</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">planStep</span>(<span class="params">state: <span class="keyword">typeof</span> PlanExecuteState.State</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 格式化当前状态</span></span><br><span class="line">  <span class="keyword">const</span> planStr = state.plan.map(<span class="function">(<span class="params">step, i</span>) =&gt;</span> <span class="string">`<span class="subst">$&#123;i + 1&#125;</span>. <span class="subst">$&#123;step&#125;</span>`</span>).join(<span class="string">'\n'</span>)</span><br><span class="line">  <span class="keyword">const</span> pastStepsStr = state.pastSteps</span><br><span class="line">    .map(<span class="function">(<span class="params">[task, result]</span>) =&gt;</span> <span class="string">`- <span class="subst">$&#123;task&#125;</span>\n  结果: <span class="subst">$&#123;result&#125;</span>`</span>)</span><br><span class="line">    .join(<span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 构建评估提示词</span></span><br><span class="line">  <span class="keyword">const</span> prompt = PLAN_PROMPT.replace(<span class="string">'&#123;input&#125;'</span>, state.input)</span><br><span class="line">    .replace(<span class="string">'&#123;plan&#125;'</span>, planStr)</span><br><span class="line">    .replace(<span class="string">'&#123;past_steps&#125;'</span>, pastStepsStr || <span class="string">'无'</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取 LLM 评估结果</span></span><br><span class="line">  <span class="keyword">const</span> response = <span class="keyword">await</span> llm.invoke(prompt)</span><br><span class="line">  <span class="keyword">const</span> content = response.content <span class="keyword">as</span> <span class="built_in">string</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 先尝试提取步骤列表</span></span><br><span class="line">  <span class="keyword">const</span> newPlan = extractPlanFromResponse(content)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果提取到步骤，说明需要继续执行</span></span><br><span class="line">  <span class="keyword">if</span> (newPlan.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// 对比原计划，检测是否有调整</span></span><br><span class="line">    <span class="keyword">const</span> originalRemaining = state.plan.slice(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">JSON</span>.stringify(newPlan) !== <span class="built_in">JSON</span>.stringify(originalRemaining)) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'[计划调整] 检测到计划变更'</span>)</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'[原计划]'</span>, originalRemaining)</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'[调整后]'</span>, newPlan)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;plan: newPlan&#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 没有步骤列表，说明任务完成</span></span><br><span class="line">  <span class="keyword">return</span> &#123;response: content&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 辅助函数：从 LLM 响应中提取步骤列表</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">extractPlanFromResponse</span>(<span class="params">response: <span class="built_in">string</span></span>): <span class="title">string</span>[] </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> lines = response.split(<span class="string">'\n'</span>)</span><br><span class="line">  <span class="keyword">const</span> steps: <span class="built_in">string</span>[] = []</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> line of lines) &#123;</span><br><span class="line">    <span class="keyword">const</span> trimmed = line.trim()</span><br><span class="line">    <span class="comment">// 匹配 "- 步骤" 或 "1. 步骤" 格式</span></span><br><span class="line">    <span class="keyword">if</span> (trimmed.match(<span class="regexp">/^[-*]\s+(.+)$/</span>)) &#123;</span><br><span class="line">      <span class="keyword">const</span> step = trimmed.replace(<span class="regexp">/^[-*]\s+/</span>, <span class="string">''</span>).trim()</span><br><span class="line">      <span class="keyword">if</span> (step) steps.push(step)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (trimmed.match(<span class="regexp">/^\d+[\.)]\s+(.+)$/</span>)) &#123;</span><br><span class="line">      <span class="keyword">const</span> step = trimmed.replace(<span class="regexp">/^\d+[\.)]\s+/</span>, <span class="string">''</span>).trim()</span><br><span class="line">      <span class="keyword">if</span> (step) steps.push(step)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> steps</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>4. 构建 LangGraph 工作流</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;StateGraph, END&#125; <span class="keyword">from</span> <span class="string">'@langchain/langgraph'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 路由函数：决定继续还是结束</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">shouldEnd</span>(<span class="params">state: <span class="keyword">typeof</span> PlanExecuteState.State</span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> state.response ? END : <span class="string">'execute'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 构建工作流</span></span><br><span class="line"><span class="keyword">const</span> workflow = <span class="keyword">new</span> StateGraph(PlanExecuteState)</span><br><span class="line">  .addNode(<span class="string">'execute'</span>, executeStep) <span class="comment">// 执行节点</span></span><br><span class="line">  .addNode(<span class="string">'planstep'</span>, planStep) <span class="comment">// 规划节点</span></span><br><span class="line">  .addEdge(<span class="string">'__start__'</span>, <span class="string">'execute'</span>) <span class="comment">// 开始 → 执行</span></span><br><span class="line">  .addEdge(<span class="string">'execute'</span>, <span class="string">'planstep'</span>) <span class="comment">// 执行 → 规划</span></span><br><span class="line">  .addConditionalEdges(<span class="string">'planstep'</span>, shouldEnd, &#123;</span><br><span class="line">    execute: <span class="string">'execute'</span>, <span class="comment">// 继续执行</span></span><br><span class="line">    [END]: END, <span class="comment">// 结束</span></span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = workflow.compile()</span><br></pre></td></tr></table></figure>
<h2 id="运行示例（体现动态调整）"><a href="#运行示例（体现动态调整）" class="headerlink" title="运行示例（体现动态调整）"></a>运行示例（体现动态调整）</h2><p>故意给一个不完整的初始计划，让 Agent 根据中间结果动态补充步骤。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">[启动高级计划模式 Agent]</span><br><span class="line">[目标] 仅根据收盘价帮我分析一下青岛啤酒和贵州茅台的投资价值对比，低的更有价值</span><br><span class="line">[初始计划]</span><br><span class="line">  1. 获取青岛啤酒的股票收盘价</span><br><span class="line"></span><br><span class="line">[执行节点] 执行当前步骤...</span><br><span class="line">[任务]</span><br><span class="line">计划有以下几个步骤:</span><br><span class="line">1. 获取青岛啤酒的股票收盘价</span><br><span class="line"></span><br><span class="line">你需要执行 步骤1. 获取青岛啤酒的股票收盘价.</span><br><span class="line">[执行结果] 青岛啤酒的股票收盘价是67.92元。</span><br><span class="line"></span><br><span class="line">[规划节点] 评估并调整计划...</span><br><span class="line">[LLM 评估]</span><br><span class="line">- 获取贵州茅台的股票收盘价</span><br><span class="line">- 比较青岛啤酒和贵州茅台的股票收盘价</span><br><span class="line">- 分析投资价值并确定哪一个更有价值</span><br><span class="line"></span><br><span class="line">[计划调整] 检测到计划变更</span><br><span class="line">[原计划剩余步骤]</span><br><span class="line">[调整后的计划]</span><br><span class="line">  1. 获取贵州茅台的股票收盘价</span><br><span class="line">  2. 比较青岛啤酒和贵州茅台的股票收盘价</span><br><span class="line">  3. 分析投资价值并确定哪一个更有价值</span><br><span class="line"></span><br><span class="line">[执行节点] 执行当前步骤...</span><br><span class="line">[任务]</span><br><span class="line">计划有以下几个步骤:</span><br><span class="line">1. 获取贵州茅台的股票收盘价</span><br><span class="line">2. 比较青岛啤酒和贵州茅台的股票收盘价</span><br><span class="line">3. 分析投资价值并确定哪一个更有价值</span><br><span class="line"></span><br><span class="line">你需要执行 步骤1. 获取贵州茅台的股票收盘价.</span><br><span class="line">[执行结果] 贵州茅台的股票收盘价是1488.21。接下来需要进行比较和分析投资价值的步骤。</span><br><span class="line"></span><br><span class="line">[规划节点] 评估并调整计划...</span><br><span class="line">[LLM 评估]</span><br><span class="line">青岛啤酒的投资价值更高。</span><br><span class="line"></span><br><span class="line">[决策] 无后续步骤，任务完成</span><br><span class="line"></span><br><span class="line">[完成]</span><br><span class="line"></span><br><span class="line">[最终答案]</span><br><span class="line"> 青岛啤酒的投资价值更高。</span><br></pre></td></tr></table></figure>
<h2 id="3-5-适用场景"><a href="#3-5-适用场景" class="headerlink" title="3.5 适用场景"></a>3.5 适用场景</h2><p>计划模式最适合需求明确、步骤可预测的结构化任务。当任务目标清晰、可分解为多个具体步骤时，先制定计划再执行能够提供更好的可控性和可预测性。这种模式特别适合数据分析、报告生成、多步骤查询等场景。对于需要监控执行进度或预估完成时间的任务，计划模式的优势更加明显。同时，当需要优化执行顺序或并行处理某些步骤时，有了明确的计划更容易进行调度优化。</p>
<h2 id="3-6-注意事项"><a href="#3-6-注意事项" class="headerlink" title="3.6 注意事项"></a>3.6 注意事项</h2><p>使用计划模式需要权衡灵活性和可控性。如果任务的不确定性较高，初始计划可能不够准确，需要考虑引入动态调整机制（如高级计划模式）。计划生成的质量直接影响最终效果，需要精心设计计划生成的 Prompt，提供清晰的指导和示例。执行过程中可能遇到计划中未预见的情况，需要有合适的异常处理策略。此外，过于详细的计划可能限制 Agent 的灵活性，而过于粗略的计划又可能起不到指导作用，需要根据具体任务找到平衡点。</p>
<h1 id="四、反思模式（Reflection-Mode）"><a href="#四、反思模式（Reflection-Mode）" class="headerlink" title="四、反思模式（Reflection Mode）"></a>四、反思模式（Reflection Mode）</h1><h2 id="4-1-核心理念"><a href="#4-1-核心理念" class="headerlink" title="4.1 核心理念"></a>4.1 核心理念</h2><p>反思模式模拟人类”先写初稿，再反复修改”的创作过程，通过自我评估和迭代改进来提升输出质量。这种模式特别适合对输出质量要求较高的场景，通过引入一个独立的反思环节来审视当前方案的不足之处。</p>
<h2 id="4-2-工作流程"><a href="#4-2-工作流程" class="headerlink" title="4.2 工作流程"></a>4.2 工作流程</h2><p><img src="/2025/11/18/ai-patterns/reflection-workflow.png" alt="反思模式工作流程"></p>
<p>反思模式包含三个阶段的循环：生成阶段根据需求和反思建议生成方案，反思阶段多维度检查方案并提出改进建议，决策阶段判断是否继续优化。循环持续进行直到达到质量标准或迭代次数上限。</p>
<h2 id="4-3-核心代码"><a href="#4-3-核心代码" class="headerlink" title="4.3 核心代码"></a>4.3 核心代码</h2><p>反思模式的实现包含状态定义、Prompt 设计、生成节点、反思节点和决策函数几个关键部分。</p>
<p><strong>状态定义：</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> ReflectionState = Annotation.Root(&#123;</span><br><span class="line">  userQuery: Annotation&lt;<span class="built_in">string</span>&gt;(), <span class="comment">// 用户需求</span></span><br><span class="line">  bestCommand: Annotation&lt;<span class="built_in">string</span>&gt;(), <span class="comment">// 当前最优方案</span></span><br><span class="line">  reflection: Annotation&lt;<span class="built_in">string</span>&gt;(), <span class="comment">// 反思记录</span></span><br><span class="line">  iterations: Annotation&lt;<span class="built_in">number</span>&gt;(), <span class="comment">// 迭代次数</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><strong>Prompt 设计：</strong></p>
<p>反思模式的核心在于两个高质量的 Prompt。生成 Prompt 用于根据需求和反思建议生成或改进方案：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> COMMAND_PROMPT = <span class="string">`你是一个资深Linux运维专家，请根据用户需求生成最合适的Linux命令。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">要求：</span></span><br><span class="line"><span class="string">1. 只输出可直接执行的命令</span></span><br><span class="line"><span class="string">2. 优先使用性能最好的方案</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">用户需求：&#123;user_query&#125;</span></span><br><span class="line"><span class="string">当前方案：&#123;best_command&#125;</span></span><br><span class="line"><span class="string">改进建议：&#123;reflection&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">请按以下格式输出：</span></span><br><span class="line"><span class="string">命令：&lt;生成的命令&gt;`</span></span><br></pre></td></tr></table></figure>
<p>反思 Prompt 用于检查方案的合理性并提出改进建议：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> REFLECTION_PROMPT = <span class="string">`请严格检查以下Linux命令的合理性：</span></span><br><span class="line"><span class="string">&#123;command&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">检查维度：</span></span><br><span class="line"><span class="string">1. 是否符合POSIX标准</span></span><br><span class="line"><span class="string">2. 是否有更高效的替代方案</span></span><br><span class="line"><span class="string">3. 是否完全解决用户需求</span></span><br><span class="line"><span class="string">4. 是否好维护</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">用户原始需求：&#123;user_query&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">请返回结构化的检查结果：</span></span><br><span class="line"><span class="string">- needsImprovement: 是否需要改进（true/false）</span></span><br><span class="line"><span class="string">- suggestions: 改进建议（包含发现的问题和具体优化方向，如果无需改进则说明"已达最优"）`</span></span><br></pre></td></tr></table></figure>
<p><strong>结构化输出格式：</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;z&#125; <span class="keyword">from</span> <span class="string">'zod'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 反思结果的结构化输出</span></span><br><span class="line"><span class="keyword">const</span> ReflectionResultSchema = z.object(&#123;</span><br><span class="line">  needsImprovement: z.boolean().describe(<span class="string">'是否需要改进'</span>),</span><br><span class="line">  suggestions: z.string().describe(<span class="string">'改进建议，包含发现的问题和优化方向'</span>),</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><strong>生成节点：</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">generateCommand</span>(<span class="params">state: ReflectionStateType</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> iter = state.iterations</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`[生成] 第 <span class="subst">$&#123;iter + 1&#125;</span> 次命令生成`</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> prompt: <span class="built_in">string</span></span><br><span class="line">  <span class="keyword">if</span> (iter === <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// 第一次生成</span></span><br><span class="line">    prompt = COMMAND_PROMPT.replace(<span class="string">'&#123;user_query&#125;'</span>, state.userQuery)</span><br><span class="line">      .replace(<span class="string">'&#123;best_command&#125;'</span>, <span class="string">'无'</span>)</span><br><span class="line">      .replace(<span class="string">'&#123;reflection&#125;'</span>, <span class="string">'无'</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 根据反思结果改进</span></span><br><span class="line">    prompt = COMMAND_PROMPT.replace(<span class="string">'&#123;user_query&#125;'</span>, state.userQuery)</span><br><span class="line">      .replace(<span class="string">'&#123;best_command&#125;'</span>, state.bestCommand)</span><br><span class="line">      .replace(<span class="string">'&#123;reflection&#125;'</span>, state.reflection)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> response = <span class="keyword">await</span> llm.invoke(prompt)</span><br><span class="line">  <span class="keyword">const</span> content = response.content <span class="keyword">as</span> <span class="built_in">string</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 提取命令（处理"命令："前缀）</span></span><br><span class="line">  <span class="keyword">const</span> commandParts = content.split(<span class="string">'命令：'</span>)</span><br><span class="line">  <span class="keyword">const</span> command =</span><br><span class="line">    commandParts.length &gt; <span class="number">1</span></span><br><span class="line">      ? commandParts[<span class="number">1</span>]?.trim() || content.trim()</span><br><span class="line">      : content.trim()</span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`[命令] <span class="subst">$&#123;command&#125;</span>`</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    bestCommand: command,</span><br><span class="line">    iterations: iter + <span class="number">1</span>,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>反思节点：</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">reflectAndOptimize</span>(<span class="params">state: ReflectionStateType</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'[反思] 执行检查...'</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> prompt = REFLECTION_PROMPT.replace(</span><br><span class="line">    <span class="string">'&#123;command&#125;'</span>,</span><br><span class="line">    state.bestCommand</span><br><span class="line">  ).replace(<span class="string">'&#123;user_query&#125;'</span>, state.userQuery)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 使用结构化输出</span></span><br><span class="line">    <span class="keyword">const</span> structuredLlm = llm.withStructuredOutput(ReflectionResultSchema)</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> structuredLlm.invoke(prompt)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查是否需要改进</span></span><br><span class="line">    <span class="keyword">if</span> (!result.needsImprovement) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'[评估] 已经最优，无需改进'</span>)</span><br><span class="line">      <span class="keyword">return</span> &#123;reflection: <span class="string">'已经最优，无需优化'</span>&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`[建议] <span class="subst">$&#123;result.suggestions&#125;</span>`</span>)</span><br><span class="line">    <span class="keyword">return</span> &#123;reflection: result.suggestions&#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="built_in">console</span>.error(<span class="string">'[反思失败]'</span>, error)</span><br><span class="line">    <span class="keyword">return</span> &#123;reflection: <span class="string">'反思检查失败'</span>&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>决策函数：</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 停止标志：发现这些关键词时立即停止</span></span><br><span class="line"><span class="keyword">const</span> STOP_SIGNS = [<span class="string">'安全隐患'</span>, <span class="string">'木马'</span>, <span class="string">'攻击'</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkReflection</span>(<span class="params">state: ReflectionStateType</span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 1. 检查是否已最优</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    state.reflection.includes(<span class="string">'无建议'</span>) ||</span><br><span class="line">    state.reflection.includes(<span class="string">'无需优化'</span>)</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'\n[结束] 已达到最优方案'</span>)</span><br><span class="line">    <span class="keyword">return</span> END</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2. 检查停止标志（安全问题等）</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> stopSign of STOP_SIGNS) &#123;</span><br><span class="line">    <span class="keyword">if</span> (state.reflection.includes(stopSign)) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`\n[结束] 检测到停止标志: <span class="subst">$&#123;stopSign&#125;</span>`</span>)</span><br><span class="line">      <span class="keyword">return</span> END</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 3. 检查迭代次数上限</span></span><br><span class="line">  <span class="keyword">if</span> (state.iterations &gt;= <span class="number">3</span>) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'\n[结束] 达到最大迭代次数 (3次)'</span>)</span><br><span class="line">    <span class="keyword">return</span> END</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 4. 继续优化</span></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'[决策] 继续优化...'</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'generate'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>构建工作流：</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> workflow = <span class="keyword">new</span> StateGraph(ReflectionState)</span><br><span class="line">  .addNode(<span class="string">'generate'</span>, generateCommand)</span><br><span class="line">  .addNode(<span class="string">'reflect'</span>, reflectAndOptimize)</span><br><span class="line">  .addEdge(<span class="string">'__start__'</span>, <span class="string">'generate'</span>)</span><br><span class="line">  .addEdge(<span class="string">'generate'</span>, <span class="string">'reflect'</span>)</span><br><span class="line">  .addConditionalEdges(<span class="string">'reflect'</span>, checkReflection, &#123;</span><br><span class="line">    generate: <span class="string">'generate'</span>,</span><br><span class="line">    [END]: END,</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = workflow.compile()</span><br></pre></td></tr></table></figure>
<h2 id="4-4-运行示例"><a href="#4-4-运行示例" class="headerlink" title="4.4 运行示例"></a>4.4 运行示例</h2><p><strong>场景：生成 Docker 命令</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">[启动反思模式 Agent]</span><br><span class="line">[需求] 使用docker创建nginx容器，端口映射8080:80</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[生成] 第 1 次命令生成</span><br><span class="line">[命令] docker run -d -p 8080:80 nginx</span><br><span class="line"></span><br><span class="line">[反思] 执行检查...</span><br><span class="line">[建议] ### 检查结果：</span><br><span class="line"></span><br><span class="line">1. **是否符合POSIX标准**</span><br><span class="line">   - Docker命令本身不在POSIX标准的范围内。POSIX主要用于异类系统的兼容性与命令行工具，而Docker作为一个应用层次的技术，自成一套工具集。因此，此项不适用。</span><br><span class="line"></span><br><span class="line">2. **是否有更高效的替代方案**</span><br><span class="line">   - **问题**：缺少对容器生命周期管理的基础设置。</span><br><span class="line">   - **建议**：</span><br><span class="line">     - 使用容器名：便于管理和识别。</span><br><span class="line">       ```bash</span><br><span class="line">       docker run -d --name my_nginx -p 8080:80 nginx</span><br><span class="line">       ```</span><br><span class="line"></span><br><span class="line">3. **是否完全解决用户需求**</span><br><span class="line">   - **问题**：基本需求虽然实现，但缺少扩展性设置。</span><br><span class="line">   - **建议**：</span><br><span class="line">     - 定义具体的版本和配置映射：确保相同环境的一致性。</span><br><span class="line">       ```bash</span><br><span class="line">       docker run -d --name my_nginx -p 8080:80 -v /my/local/nginx.conf:/etc/nginx/nginx.conf nginx:1.21.6</span><br><span class="line">       ```</span><br><span class="line">     - 添加自动重启设置，提高容器的可用性。</span><br><span class="line">       ```bash</span><br><span class="line">       docker run -d --name my_nginx --restart unless-stopped -p 8080:80 nginx</span><br><span class="line">       ```</span><br><span class="line"></span><br><span class="line">4. **是否好维护**</span><br><span class="line">   - **问题**：需要通过容器ID执行维护命令，不利于日常操作。</span><br><span class="line">   - **建议**：</span><br><span class="line">     - 使用可识别的容器名称：简化运维。</span><br><span class="line">       ```bash</span><br><span class="line">       docker run -d --name my_nginx -p 8080:80 nginx</span><br><span class="line">       ```</span><br><span class="line">     - 考虑使用 Docker Compose 管理复杂项目，提升可维护性。</span><br><span class="line"></span><br><span class="line">### 综合结论：</span><br><span class="line">- **需要改进**：True</span><br><span class="line">- **改进建议**：通过增加容器名称、版本控制和配置映射等方式提高管理效率，增强容器运行的稳定性和可扩展性。同时，建议考虑使用 Docker Compose 简化多容器环境的管理。</span><br><span class="line">[决策] 继续优化...</span><br><span class="line"></span><br><span class="line">[生成] 第 2 次命令生成</span><br><span class="line">[命令] docker run -d --name my_nginx -p 8080:80 -v /my/local/nginx.conf:/etc/nginx/nginx.conf nginx:1.21.6</span><br><span class="line"></span><br><span class="line">[反思] 执行检查...</span><br><span class="line">[评估] 已经最优，无需改进</span><br><span class="line"></span><br><span class="line">[结束] 已达到最优方案</span><br><span class="line"></span><br><span class="line">[完成]</span><br><span class="line">最终命令: docker run -d --name my_nginx -p 8080:80 -v /my/local/nginx.conf:/etc/nginx/nginx.conf nginx:1.21.6</span><br></pre></td></tr></table></figure>
<h2 id="4-5-适用场景"><a href="#4-5-适用场景" class="headerlink" title="4.5 适用场景"></a>4.5 适用场景</h2><p>反思模式最适合对输出质量有较高要求的场景。当需要生成文档、代码、配置文件、命令等关键输出时，通过反思机制可以显著提升方案的完整性和可靠性。这种模式特别适合技术方案设计、代码审查、内容创作等需要经过多次打磨才能达到专业标准的任务。同时，对于那些有明确质量评估标准的任务，反思模式能够系统性地检查各个维度是否达标。</p>
<h2 id="4-6-注意事项"><a href="#4-6-注意事项" class="headerlink" title="4.6 注意事项"></a>4.6 注意事项</h2><p>使用反思模式时需要注意控制迭代次数，避免过度优化导致效率低下或陷入无限循环。建议设置合理的迭代上限（通常 2-3 次即可），并定义清晰的停止条件。反思 Prompt 的设计至关重要，需要明确具体的检查维度和评估标准，避免模糊的评价导致反思效果不佳。此外，反思模式会增加 LLM 调用次数和 Token 消耗，需要在质量和成本之间做好平衡。对于某些已经足够好的初始方案，过度的反思可能反而引入不必要的修改。</p>
<hr>
<h1 id="五、人机协作模式（Human-in-the-Loop）"><a href="#五、人机协作模式（Human-in-the-Loop）" class="headerlink" title="五、人机协作模式（Human-in-the-Loop）"></a>五、人机协作模式（Human-in-the-Loop）</h1><h2 id="5-1-核心理念"><a href="#5-1-核心理念" class="headerlink" title="5.1 核心理念"></a>5.1 核心理念</h2><p>人机协作模式将 Agent 的自动化能力与人类判断力相结合。适用于关键决策（高风险操作需人工确认）、信息补全（缺少参数时询问用户）和质量控制（重要输出需人工审核）等场景。通过在关键节点暂停执行、等待人工输入、然后恢复执行，实现效率与可控性的平衡。</p>
<h2 id="5-2-工作流程"><a href="#5-2-工作流程" class="headerlink" title="5.2 工作流程"></a>5.2 工作流程</h2><p><img src="/2025/11/18/ai-patterns/human-loop-workflow.png" alt="人机协作模式工作流程"></p>
<p>流程图展示了一个核心循环和三条分支路径：</p>
<p><strong>核心循环：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Input → LLM 推理 → 路由判断</span><br></pre></td></tr></table></figure>
<p><strong>分支 1：人工交互路径（橙色）</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">路由判断 → 暂停等待 → 用户输入 → LLM 推理（循环）</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>触发条件</strong>：LLM 调用 <code>ask_user</code> 工具</li>
<li><strong>核心机制</strong>：<code>interrupt()</code> 暂停，等待用户输入，<code>resume</code> 恢复</li>
<li><strong>应用场景</strong>：缺少参数、需要用户确认、多选项决策</li>
</ul>
<p><strong>分支 2：工具执行路径（紫色）</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">路由判断 → 工具执行 → LLM 推理（循环）</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>触发条件</strong>：LLM 调用普通工具</li>
<li><strong>核心机制</strong>：自动执行工具，结果反馈给 LLM</li>
<li><strong>应用场景</strong>：查询数据、计算处理、API 调用</li>
</ul>
<p><strong>分支 3：完成路径（绿色虚线）</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">路由判断 → Final Answer（结束）</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>触发条件</strong>：LLM 判断已获得足够信息</li>
<li><strong>核心机制</strong>：返回最终结果，结束执行</li>
<li><strong>应用场景</strong>：问题解决、任务完成</li>
</ul>
<p>实现依赖三个核心机制：中断机制通过 <code>interrupt()</code> 暂停执行并等待人工输入，状态保存机制使用 Checkpointer 保留所有上下文信息，恢复执行机制通过 <code>Command({ resume: userInput })</code> 从暂停点继续执行。</p>
<h2 id="5-3-实战案例：购物助手"><a href="#5-3-实战案例：购物助手" class="headerlink" title="5.3 实战案例：购物助手"></a>5.3 实战案例：购物助手</h2><p><strong>场景：</strong> 用户询问购买商品的总价，但没有说明数量，需要询问用户。</p>
<h2 id="核心代码实现-2"><a href="#核心代码实现-2" class="headerlink" title="核心代码实现"></a>核心代码实现</h2><p><strong>1. 工具定义</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;tool&#125; <span class="keyword">from</span> <span class="string">'@langchain/core/tools'</span></span><br><span class="line"><span class="keyword">import</span> &#123;z&#125; <span class="keyword">from</span> <span class="string">'zod'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 普通工具：获取商品价格</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getPriceTool = tool(</span><br><span class="line">  <span class="keyword">async</span> (input) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;product&#125; = input <span class="keyword">as</span> &#123;product: <span class="built_in">string</span>&#125;</span><br><span class="line">    <span class="keyword">const</span> price = (<span class="built_in">Math</span>.random() * <span class="number">90</span> + <span class="number">10</span>).toFixed(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`商品<span class="subst">$&#123;product&#125;</span>的价格为<span class="subst">$&#123;price&#125;</span>元`</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    name: <span class="string">'get_price'</span>,</span><br><span class="line">    description: <span class="string">'获取商品价格'</span>,</span><br><span class="line">    schema: z.object(&#123;</span><br><span class="line">      product: z.string().describe(<span class="string">'商品名称'</span>),</span><br><span class="line">    &#125;),</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 特殊工具：询问用户（触发人工介入）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> askUserTool = tool(</span><br><span class="line">  <span class="keyword">async</span> (input) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;question&#125; = input <span class="keyword">as</span> &#123;question: <span class="built_in">string</span>&#125;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'[需要询问用户]'</span>, question)</span><br><span class="line">    <span class="keyword">return</span> question</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    name: <span class="string">'ask_user'</span>,</span><br><span class="line">    description: <span class="string">'询问用户进一步的需求，如用户要多少件商品、要什么商品等'</span>,</span><br><span class="line">    schema: z.object(&#123;</span><br><span class="line">      question: z.string().describe(<span class="string">'需要询问用户的问题'</span>),</span><br><span class="line">    &#125;),</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p><strong>关键点：</strong></p>
<ul>
<li><code>ask_user</code> 是一个特殊工具，用于触发人工介入</li>
<li>LLM 会在需要用户信息时自动调用这个工具</li>
</ul>
<p><strong>2. 人工节点（核心）</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;interrupt, Command&#125; <span class="keyword">from</span> <span class="string">'@langchain/langgraph'</span></span><br><span class="line"><span class="keyword">import</span> &#123;ToolMessage&#125; <span class="keyword">from</span> <span class="string">'@langchain/core/messages'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">humanNode</span>(<span class="params">state: HumanLoopStateType</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> lastMessage = state.messages[state.messages.length - <span class="number">1</span>]</span><br><span class="line">  <span class="keyword">const</span> toolCall = lastMessage.tool_calls?.[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 使用 interrupt 暂停执行，等待用户输入</span></span><br><span class="line">  <span class="keyword">const</span> userInput = interrupt(toolCall.args)</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'[用户输入]'</span>, userInput)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 将用户输入作为工具执行结果返回</span></span><br><span class="line">  <span class="keyword">const</span> toolMessage = <span class="keyword">new</span> ToolMessage(&#123;</span><br><span class="line">    tool_call_id: toolCall.id,</span><br><span class="line">    content: <span class="built_in">String</span>(userInput),</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;messages: [toolMessage]&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>关键点：</strong></p>
<ul>
<li><code>interrupt()</code> 会暂停整个工作流的执行</li>
<li>返回的值会在恢复执行时作为 <code>resume</code> 参数传入</li>
<li>用户输入被封装成 <code>ToolMessage</code> 返回给 LLM</li>
</ul>
<p><strong>3. 路由函数（识别触发时机）</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">enterTools</span>(<span class="params">state: HumanLoopStateType</span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> lastMessage = state.messages[state.messages.length - <span class="number">1</span>]</span><br><span class="line">  <span class="keyword">const</span> toolCalls = lastMessage.tool_calls</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!toolCalls || toolCalls.length === <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> END</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> toolName = toolCalls[<span class="number">0</span>].name</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果是 ask_user，进入人工节点</span></span><br><span class="line">  <span class="keyword">if</span> (toolName === <span class="string">'ask_user'</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'humanNode'</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 否则进入工具节点</span></span><br><span class="line">  <span class="keyword">return</span> <span class="string">'toolNode'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>4. 构建 LangGraph（必须使用 Checkpointer）</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;StateGraph, START, END&#125; <span class="keyword">from</span> <span class="string">'@langchain/langgraph'</span></span><br><span class="line"><span class="keyword">import</span> &#123;MemorySaver&#125; <span class="keyword">from</span> <span class="string">'@langchain/langgraph'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">buildHumanLoopGraph</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> workflow = <span class="keyword">new</span> StateGraph(HumanLoopState)</span><br><span class="line">    .addNode(<span class="string">'llmNode'</span>, llmNode)</span><br><span class="line">    .addNode(<span class="string">'humanNode'</span>, humanNode)</span><br><span class="line">    .addNode(<span class="string">'toolNode'</span>, toolNode)</span><br><span class="line">    .addEdge(START, <span class="string">'llmNode'</span>)</span><br><span class="line">    .addConditionalEdges(<span class="string">'llmNode'</span>, enterTools, &#123;</span><br><span class="line">      humanNode: <span class="string">'humanNode'</span>,</span><br><span class="line">      toolNode: <span class="string">'toolNode'</span>,</span><br><span class="line">      [END]: END,</span><br><span class="line">    &#125;)</span><br><span class="line">    .addEdge(<span class="string">'toolNode'</span>, <span class="string">'llmNode'</span>)</span><br><span class="line">    .addEdge(<span class="string">'humanNode'</span>, <span class="string">'llmNode'</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 必须使用 checkpointer 来保存状态</span></span><br><span class="line">  <span class="keyword">const</span> memory = <span class="keyword">new</span> MemorySaver()</span><br><span class="line">  <span class="keyword">return</span> workflow.compile(&#123;checkpointer: memory&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>关键点：</strong></p>
<ul>
<li>人机协作模式<strong>必须</strong>配置 <code>checkpointer</code></li>
<li><code>MemorySaver</code> 将状态保存在内存中（生产环境可用数据库）</li>
</ul>
<p><strong>5. 运行 Agent（两阶段执行）</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">runHumanLoopAgent</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  query: <span class="built_in">string</span>,</span></span></span><br><span class="line">  getUserInput: () =&gt; Promise&lt;string&gt;</span><br><span class="line">): <span class="built_in">Promise</span>&lt;<span class="built_in">string</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> app = buildHumanLoopGraph()</span><br><span class="line">  <span class="keyword">const</span> threadConfig = &#123;configurable: &#123;thread_id: <span class="string">'123'</span>&#125;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 第一次启动</span></span><br><span class="line">  <span class="keyword">let</span> result = <span class="keyword">await</span> app.invoke(&#123;query, messages: []&#125;, threadConfig)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 检查是否需要人工输入</span></span><br><span class="line">  <span class="keyword">const</span> lastMessage = result.messages[result.messages.length - <span class="number">1</span>]</span><br><span class="line">  <span class="keyword">if</span> (lastMessage.tool_calls?.[<span class="number">0</span>]?.name === <span class="string">'ask_user'</span>) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'\n[等待用户输入...]'</span>)</span><br><span class="line">    <span class="keyword">const</span> userInput = <span class="keyword">await</span> getUserInput()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 恢复执行（关键：使用 Command + resume）</span></span><br><span class="line">    result = <span class="keyword">await</span> app.invoke(<span class="keyword">new</span> Command(&#123;resume: userInput&#125;), threadConfig)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result.messages[result.messages.length - <span class="number">1</span>].content</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>关键点：</strong></p>
<ol>
<li>第一次 <code>invoke</code> 会执行到 <code>interrupt</code> 处暂停</li>
<li>获取用户输入后，通过 <code>Command({ resume: userInput })</code> 恢复</li>
<li><strong>必须使用相同的 <code>threadConfig</code></strong> 才能恢复到正确的状态</li>
</ol>
<h2 id="运行效果-2"><a href="#运行效果-2" class="headerlink" title="运行效果"></a>运行效果</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[启动人机协作模式 Agent]</span><br><span class="line">[用户问题] 我想买一些苹果，总共需要多少钱</span><br><span class="line"></span><br><span class="line">[LLM 分析] 需要知道用户要买多少苹果</span><br><span class="line">[进入工具] ask_user</span><br><span class="line">[参数] &#123;question: &apos;您想购买多少个苹果？&apos;&#125;</span><br><span class="line"></span><br><span class="line">[需要询问用户] 您想购买多少个苹果？</span><br><span class="line">[等待用户输入...]</span><br><span class="line"></span><br><span class="line">请输入: 5个</span><br><span class="line"></span><br><span class="line">[用户输入] 5个</span><br><span class="line">[用户回答] 5个</span><br><span class="line"></span><br><span class="line">[调用工具] get_price &#123;product: &apos;苹果&apos;&#125;</span><br><span class="line">→ 商品苹果的价格为52.30元</span><br><span class="line"></span><br><span class="line">[LLM 计算] 5个 × 52.30元 = 261.50元</span><br><span class="line"></span><br><span class="line">[完成]</span><br><span class="line">[最终答案] 您想购买5个苹果，总共需要261.50元</span><br></pre></td></tr></table></figure>
<h2 id="5-4-适用场景"><a href="#5-4-适用场景" class="headerlink" title="5.4 适用场景"></a>5.4 适用场景</h2><p>人机协作模式在多种场景下都能发挥重要作用。对于敏感操作，比如删除数据、修改配置、执行系统命令等高风险动作，在执行前需要用户明确确认。可以通过定义 <code>confirm_operation</code> 工具，在执行前暂停并向用户展示即将执行的操作内容，等待用户审核通过后再继续。</p>
<p>在信息补全场景中，当 Agent 发现缺少必需参数、需要用户在多个选项中选择、或参数含义不明确时，可以暂停执行并向用户询问。这种交互式的信息收集方式比让 Agent 自行猜测要可靠得多。</p>
<p>质量控制是另一个重要应用场景。当 Agent 生成文档、代码、方案等内容后，可以暂停执行让用户审核输出质量。在关键决策点，人工判断往往比 LLM 的判断更可靠。此外，对于重要结果，在使用前进行人工验证可以避免潜在风险。</p>
<p>异常处理场景也很常见。当 Agent 遇到无法自动处理的情况时，与其直接失败不如暂停并请求人工帮助。用户可以提供额外信息、调整策略或从多个备选方案中选择，然后 Agent 继续执行。</p>
<h2 id="5-5-高级用法"><a href="#5-5-高级用法" class="headerlink" title="5.5 高级用法"></a>5.5 高级用法</h2><p><strong>1. 支持多轮人工介入</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">runWithMultipleInterrupts</span>(<span class="params">query: <span class="built_in">string</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> app = buildHumanLoopGraph()</span><br><span class="line">  <span class="keyword">const</span> config = &#123;configurable: &#123;thread_id: <span class="string">'123'</span>&#125;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> input: <span class="built_in">any</span> = &#123;query, messages: []&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> app.invoke(input, config)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查是否完成</span></span><br><span class="line">    <span class="keyword">if</span> (!needsHumanInput(result)) &#123;</span><br><span class="line">      <span class="keyword">return</span> result.messages[result.messages.length - <span class="number">1</span>].content</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取用户输入</span></span><br><span class="line">    <span class="keyword">const</span> userInput = <span class="keyword">await</span> getUserInput()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 准备下一次调用</span></span><br><span class="line">    input = <span class="keyword">new</span> Command(&#123;resume: userInput&#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>2. 支持用户取消</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> userInput = <span class="keyword">await</span> getUserInput()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (userInput === <span class="string">'cancel'</span> || userInput === <span class="string">'取消'</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'操作已取消'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">result = <span class="keyword">await</span> app.invoke(<span class="keyword">new</span> Command(&#123;resume: userInput&#125;), config)</span><br></pre></td></tr></table></figure>
<p><strong>3. 添加超时处理</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> timeout = <span class="function">(<span class="params">ms: <span class="built_in">number</span></span>) =&gt;</span></span><br><span class="line">  <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">_, reject</span>) =&gt;</span> setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Timeout'</span>)), ms))</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> userInput = <span class="keyword">await</span> <span class="built_in">Promise</span>.race([</span><br><span class="line">    getUserInput(),</span><br><span class="line">    timeout(<span class="number">60000</span>), <span class="comment">// 60秒超时</span></span><br><span class="line">  ])</span><br><span class="line"></span><br><span class="line">  result = <span class="keyword">await</span> app.invoke(<span class="keyword">new</span> Command(&#123;resume: userInput&#125;), config)</span><br><span class="line">&#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'等待超时，操作已取消'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="5-6-注意事项"><a href="#5-6-注意事项" class="headerlink" title="5.6 注意事项"></a>5.6 注意事项</h2><p>实现人机协作模式时需要注意几个关键点。首先，必须配置 Checkpointer 来保存状态，这是整个模式的技术基础。可以选择 <code>MemorySaver</code> 用于开发和简单场景，或使用 <code>SqliteSaver</code> 等持久化方案用于生产环境。</p>
<p>Thread ID 的一致性至关重要。恢复执行时必须使用与暂停时相同的 <code>thread_id</code>，否则会导致状态丢失。在多用户场景下，务必为每个用户会话分配独立的 <code>thread_id</code> 以隔离状态，避免数据混淆。</p>
<p>输入验证不可忽视。用户可能输入无效内容、格式错误或超出预期范围的数据，需要实现完善的验证和错误处理机制。同时，应该设置合理的超时机制，避免 Agent 无限期等待用户输入。提供取消操作的选项也很重要，让用户可以随时中止流程。</p>
<h1 id="六、总结"><a href="#六、总结" class="headerlink" title="六、总结"></a>六、总结</h1><p>五种 Agent 设计模式各有侧重。ReAct 通过推理-行动循环适合处理需要外部工具的任务，CodeAct 通过代码生成解决复杂计算问题。计划模式提供结构化执行路径，简单版适合明确任务，高级版支持动态调整。反思模式通过迭代优化提升输出质量，人机协作模式在关键节点引入人工判断确保可控性。</p>
<p>实际应用中往往需要组合使用。建议从简单模式开始验证核心逻辑，逐步引入高级特性。根据任务特点权衡性能与准确性，同时做好日志监控和安全防护。通过理解这些模式的特点和适用场景，你可以构建高效可靠的 Agent 系统。</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/ai/" rel="tag"># ai</a>
          
            <a href="/tags/agent/" rel="tag"># agent</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2025/06/19/ai-auto-test-midscene/" rel="next" title="体验一下 Midscene.js，基于 AI 的 UI 自动化测试工具">
                <i class="fa fa-chevron-left"></i> 体验一下 Midscene.js，基于 AI 的 UI 自动化测试工具
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2025/11/20/ai-deep-research/" rel="prev" title="AI Agent Deep Research 实战">
                AI Agent Deep Research 实战 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


            </div>
            


            

  
    <div class="comments" id="comments">
      <div id="lv-container" data-id="city" data-uid="MTAyMC8zODAwNS8xNDUzNQ=="></div>
    </div>

  



          </div>
          
            
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Ayou</p>
              <p class="site-description motion-element" itemprop="description">一名转行的菜鸡程序员</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">207</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">21</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">87</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#一、ReAct-模式"><span class="nav-number">2.</span> <span class="nav-text">一、ReAct 模式</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-什么是-ReAct"><span class="nav-number">2.1.</span> <span class="nav-text">1.1 什么是 ReAct</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-工作流程"><span class="nav-number">2.2.</span> <span class="nav-text">1.2 工作流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3-实战案例"><span class="nav-number">2.3.</span> <span class="nav-text">1.3 实战案例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#案例：比较两个股票的收盘价"><span class="nav-number">2.4.</span> <span class="nav-text">案例：比较两个股票的收盘价</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#核心代码实现"><span class="nav-number">2.5.</span> <span class="nav-text">核心代码实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#运行结果示例"><span class="nav-number">2.6.</span> <span class="nav-text">运行结果示例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-4-使用-Function-Call-来实现"><span class="nav-number">2.7.</span> <span class="nav-text">1.4 使用 Function Call 来实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#核心代码实现-1"><span class="nav-number">2.8.</span> <span class="nav-text">核心代码实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-5-使用-LangGraph-实现"><span class="nav-number">2.9.</span> <span class="nav-text">1.5 使用 LangGraph 实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#核心代码"><span class="nav-number">2.10.</span> <span class="nav-text">核心代码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-6-适用场景"><span class="nav-number">2.11.</span> <span class="nav-text">1.6 适用场景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-7-注意事项"><span class="nav-number">2.12.</span> <span class="nav-text">1.7 注意事项</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#二、CodeAct-模式"><span class="nav-number">3.</span> <span class="nav-text">二、CodeAct 模式</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-核心理念"><span class="nav-number">3.1.</span> <span class="nav-text">2.1 核心理念</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-工作流程"><span class="nav-number">3.2.</span> <span class="nav-text">2.2 工作流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-实战案例"><span class="nav-number">3.3.</span> <span class="nav-text">2.3 实战案例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#核心代码-1"><span class="nav-number">3.4.</span> <span class="nav-text">核心代码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#运行效果"><span class="nav-number">3.5.</span> <span class="nav-text">运行效果</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-4-适用场景"><span class="nav-number">3.6.</span> <span class="nav-text">2.4 适用场景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-5-注意事项"><span class="nav-number">3.7.</span> <span class="nav-text">2.5 注意事项</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#三、计划模式（Plan-Mode）"><span class="nav-number">4.</span> <span class="nav-text">三、计划模式（Plan Mode）</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-核心理念"><span class="nav-number">4.1.</span> <span class="nav-text">3.1 核心理念</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-工作流程"><span class="nav-number">4.2.</span> <span class="nav-text">3.2 工作流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-实战案例-简单计划模式"><span class="nav-number">4.3.</span> <span class="nav-text">3.3 实战案例:简单计划模式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#核心代码-2"><span class="nav-number">4.4.</span> <span class="nav-text">核心代码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#运行效果-1"><span class="nav-number">4.5.</span> <span class="nav-text">运行效果</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-4-高级计划模式：动态调整"><span class="nav-number">4.6.</span> <span class="nav-text">3.4 高级计划模式：动态调整</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#工作流程"><span class="nav-number">4.7.</span> <span class="nav-text">工作流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#代码示例"><span class="nav-number">4.8.</span> <span class="nav-text">代码示例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#运行示例（体现动态调整）"><span class="nav-number">4.9.</span> <span class="nav-text">运行示例（体现动态调整）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-5-适用场景"><span class="nav-number">4.10.</span> <span class="nav-text">3.5 适用场景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-6-注意事项"><span class="nav-number">4.11.</span> <span class="nav-text">3.6 注意事项</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#四、反思模式（Reflection-Mode）"><span class="nav-number">5.</span> <span class="nav-text">四、反思模式（Reflection Mode）</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1-核心理念"><span class="nav-number">5.1.</span> <span class="nav-text">4.1 核心理念</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-工作流程"><span class="nav-number">5.2.</span> <span class="nav-text">4.2 工作流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-3-核心代码"><span class="nav-number">5.3.</span> <span class="nav-text">4.3 核心代码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-4-运行示例"><span class="nav-number">5.4.</span> <span class="nav-text">4.4 运行示例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-5-适用场景"><span class="nav-number">5.5.</span> <span class="nav-text">4.5 适用场景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-6-注意事项"><span class="nav-number">5.6.</span> <span class="nav-text">4.6 注意事项</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#五、人机协作模式（Human-in-the-Loop）"><span class="nav-number">6.</span> <span class="nav-text">五、人机协作模式（Human-in-the-Loop）</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#5-1-核心理念"><span class="nav-number">6.1.</span> <span class="nav-text">5.1 核心理念</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-2-工作流程"><span class="nav-number">6.2.</span> <span class="nav-text">5.2 工作流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-3-实战案例：购物助手"><span class="nav-number">6.3.</span> <span class="nav-text">5.3 实战案例：购物助手</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#核心代码实现-2"><span class="nav-number">6.4.</span> <span class="nav-text">核心代码实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#运行效果-2"><span class="nav-number">6.5.</span> <span class="nav-text">运行效果</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-4-适用场景"><span class="nav-number">6.6.</span> <span class="nav-text">5.4 适用场景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-5-高级用法"><span class="nav-number">6.7.</span> <span class="nav-text">5.5 高级用法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-6-注意事项"><span class="nav-number">6.8.</span> <span class="nav-text">5.6 注意事项</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#六、总结"><span class="nav-number">7.</span> <span class="nav-text">六、总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


          
        </div>
      </main>

      <footer id="footer" class="footer">
        <div class="footer-inner">
          <div class="copyright">&copy; <span itemprop="copyrightYear">2026</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ayou</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




          







          
        </div>
      </footer>

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
        </div>
      

      
    
  
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  












  





  

  

  

  
  

  

  

  

  
</body>
</html>
