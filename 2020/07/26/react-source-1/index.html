<!DOCTYPE html>




<html class="theme-next mist" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />


<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />





  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="react," />










<meta name="description" content="React 源码解读的第一篇文章，介绍首次渲染的流程">
<meta name="keywords" content="react">
<meta property="og:type" content="article">
<meta property="og:title" content="React 源码解读之一首次渲染流程">
<meta property="og:url" content="http://www.paradeto.com/2020/07/26/react-source-1/index.html">
<meta property="og:site_name" content="Ayou">
<meta property="og:description" content="React 源码解读的第一篇文章，介绍首次渲染的流程">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://www.paradeto.com/2020/07/26/react-source-1/1.png">
<meta property="og:image" content="http://www.paradeto.com/2020/07/26/react-source-1/2.png">
<meta property="og:image" content="http://www.paradeto.com/2020/07/26/react-source-1/3.png">
<meta property="og:image" content="http://www.paradeto.com/2020/07/26/react-source-1/4.png">
<meta property="og:image" content="http://www.paradeto.com/2020/07/26/react-source-1/5.png">
<meta property="og:image" content="http://www.paradeto.com/2020/07/26/react-source-1/6.png">
<meta property="og:image" content="http://www.paradeto.com/2020/07/26/react-source-1/7.png">
<meta property="og:image" content="http://www.paradeto.com/2020/07/26/react-source-1/9.png">
<meta property="og:image" content="http://www.paradeto.com/2020/07/26/react-source-1/10.png">
<meta property="og:image" content="http://www.paradeto.com/2020/07/26/react-source-1/11.png">
<meta property="og:image" content="http://www.paradeto.com/2020/07/26/react-source-1/12.png">
<meta property="og:updated_time" content="2020-10-21T10:10:05.231Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="React 源码解读之一首次渲染流程">
<meta name="twitter:description" content="React 源码解读的第一篇文章，介绍首次渲染的流程">
<meta name="twitter:image" content="http://www.paradeto.com/2020/07/26/react-source-1/1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>





  <link rel="canonical" href="http://www.paradeto.com/2020/07/26/react-source-1/"/>






  <title>React 源码解读之一首次渲染流程 | Ayou</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?6a0c6a11d4daa051d62442b432fb279d";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
    
    
      
    

    <div class="container sidebar-position-left page-post-detail">
      <div class="headband"></div>

      <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
        <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Ayou</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Good Good Study, Day Day Up!</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-demo">
          <a href="/demo/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Demo
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/resume" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            About
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
      </header>

      <main id="main" class="main">
        <div class="main-inner">
          <div class="content-wrap">
            <div id="content" class="content">
              

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.paradeto.com/2020/07/26/react-source-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ayou">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ayou">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">React 源码解读之一首次渲染流程</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-07-26T09:39:30+08:00">
                2020-07-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/javascript/" itemprop="url" rel="index">
                    <span itemprop="name">javascript</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          
              <div class="post-description">
                  React 源码解读的第一篇文章，介绍首次渲染的流程
              </div>
          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <blockquote>
<p>说明：本文结论均基于 React 16.13.1 得出，若有出入请参考对应版本源码</p>
</blockquote>
<h1 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h1><p>在开始进行源码分析前，我们先来看几个题目：</p>
<p>题目一：</p>
<p>渲染下面的组件，打印顺序是什么？</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">const</span> channel = <span class="keyword">new</span> MessageChannel()</span><br><span class="line"></span><br><span class="line"><span class="comment">// onmessage 是一个宏任务</span></span><br><span class="line">channel.port1.onmessage = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'1 message channel'</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  React.useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'2 use effect'</span>)</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Promise</span>.resolve().then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'3 promise'</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  React.useLayoutEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'4 use layout effect'</span>)</span><br><span class="line">    channel.port2.postMessage(<span class="string">''</span>)</span><br><span class="line">  &#125;, [])</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>App<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>答案：4 3 2 1</p>
<p>题目二：</p>
<p>点击 <code>p</code> 标签后，下面事件发生的顺序</p>
<ol>
<li>页面显示 xingzhi</li>
<li>console.log(‘useLayoutEffect ayou’)</li>
<li>console.log(‘useLayoutEffect xingzhi’)</li>
<li>console.log(‘useEffect ayou’)</li>
<li>console.log(‘useEffect xingzhi’)</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> &#123;useState&#125; <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Name</span>(<span class="params">&#123;name&#125;</span>) </span>&#123;</span><br><span class="line">  React.useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`useEffect <span class="subst">$&#123;name&#125;</span>`</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`useEffect destroy <span class="subst">$&#123;name&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [name])</span><br><span class="line"></span><br><span class="line">  React.useLayoutEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`useLayoutEffect <span class="subst">$&#123;name&#125;</span>`</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`useLayoutEffect destroy <span class="subst">$&#123;name&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [name])</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;name&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 点击后，下面事件发生的顺序</span></span><br><span class="line"><span class="comment">// 1. 页面显示 xingzhi</span></span><br><span class="line"><span class="comment">// 2. console.log('useLayoutEffect ayou')</span></span><br><span class="line"><span class="comment">// 3. console.log('useLayoutEffect xingzhi')</span></span><br><span class="line"><span class="comment">// 4. console.log('useEffect ayou')</span></span><br><span class="line"><span class="comment">// 5. console.log('useEffect xingzhi')</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [name, setName] = useState(<span class="string">'ayou'</span>)</span><br><span class="line">  <span class="keyword">const</span> onClick = React.useCallback(<span class="function"><span class="params">()</span> =&gt;</span> setName(<span class="string">'xingzhi'</span>), [])</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;Name name=&#123;name&#125; /&gt;</span><br><span class="line">      &lt;p onClick=&#123;onClick&#125;&gt;I am <span class="number">18</span>&lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>答案：1 2 3 4 5</p>
<p>你是不是都答对了呢？</p>
<h1 id="首次渲染流程"><a href="#首次渲染流程" class="headerlink" title="首次渲染流程"></a>首次渲染流程</h1><p>我们以下面这个例子来阐述下首次渲染的流程：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Name</span>(<span class="params">&#123;name&#125;</span>) </span>&#123;</span><br><span class="line">  React.useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`useEffect <span class="subst">$&#123;name&#125;</span>`</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'useEffect destroy'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [name])</span><br><span class="line"></span><br><span class="line">  React.useLayoutEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`useLayoutEffect <span class="subst">$&#123;name&#125;</span>`</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'useLayoutEffect destroy'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [name])</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;name&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Gender</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">i</span>&gt;</span>Male<span class="tag">&lt;/<span class="name">i</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [name, setName] = useState(<span class="string">'ayou'</span>)</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;Name name=&#123;name&#125; /&gt;</span><br><span class="line">      &lt;p onClick=&#123;() =&gt; setName(<span class="string">'xingzhi'</span>)&#125;&gt;I am <span class="number">18</span>&lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp">      &lt;Gender /</span>&gt;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp">...</span></span><br><span class="line"><span class="regexp">ReactDOM.render(&lt;App /</span>&gt;, <span class="built_in">document</span>.getElementById(<span class="string">'root'</span>))</span><br></pre></td></tr></table></figure>
<p>首先，我们看看 <code>render</code>，它是从 <code>ReactDOMLegacy</code> 中导出的，并最后调用了 <code>legacyRenderSubtreeIntoContainer</code>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">legacyRenderSubtreeIntoContainer</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  parentComponent: ?React$Component&lt;any, any&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  children: ReactNodeList,</span></span></span><br><span class="line"><span class="function"><span class="params">  container: Container,</span></span></span><br><span class="line"><span class="function"><span class="params">  forceHydrate: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params">  callback: ?Function</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> Without `any` type, Flow says "Property cannot be accessed on any</span></span><br><span class="line">  <span class="comment">// member of intersection type." Whyyyyyy.</span></span><br><span class="line">  <span class="keyword">let</span> root: RootType = (container._reactRootContainer: any)</span><br><span class="line">  <span class="keyword">let</span> fiberRoot</span><br><span class="line">  <span class="keyword">if</span> (!root) &#123;</span><br><span class="line">    <span class="comment">// 首次渲染</span></span><br><span class="line">    root = container._reactRootContainer = legacyCreateRootFromDOMContainer(</span><br><span class="line">      container,</span><br><span class="line">      forceHydrate</span><br><span class="line">    )</span><br><span class="line">    fiberRoot = root._internalRoot</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> callback === <span class="string">'function'</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> originalCallback = callback</span><br><span class="line">      callback = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> instance = getPublicRootInstance(fiberRoot)</span><br><span class="line">        originalCallback.call(instance)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Initial mount should not be batched.</span></span><br><span class="line">    unbatchedUpdates(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      updateContainer(children, fiberRoot, parentComponent, callback)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 更新</span></span><br><span class="line">    fiberRoot = root._internalRoot</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> callback === <span class="string">'function'</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> originalCallback = callback</span><br><span class="line">      callback = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> instance = getPublicRootInstance(fiberRoot)</span><br><span class="line">        originalCallback.call(instance)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    updateContainer(children, fiberRoot, parentComponent, callback)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> getPublicRootInstance(fiberRoot)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首次渲染时，经过下面这一系列的操作，会初始化一些东西：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">ReactDOMLegacy.js</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">legacyCreateRootFromDOMContainer</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  container: Container,</span></span></span><br><span class="line"><span class="function"><span class="params">  forceHydrate: boolean</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">RootType</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">return</span> createLegacyRoot(</span><br><span class="line">    container,</span><br><span class="line">    shouldHydrate</span><br><span class="line">      ? &#123;</span><br><span class="line">          hydrate: <span class="literal">true</span>,</span><br><span class="line">        &#125;</span><br><span class="line">      : <span class="literal">undefined</span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ReactDOMRoot.js</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createLegacyRoot</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  container: Container,</span></span></span><br><span class="line"><span class="function"><span class="params">  options?: RootOptions,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">RootType</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> ReactDOMBlockingRoot(container, LegacyRoot, options);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ReactDOMBlockingRoot</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  container: Container,</span></span></span><br><span class="line"><span class="function"><span class="params">  tag: RootTag,</span></span></span><br><span class="line"><span class="function"><span class="params">  options: void | RootOptions,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>._internalRoot = createRootImpl(container, tag, options);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createRootImpl</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  container: Container,</span></span></span><br><span class="line"><span class="function"><span class="params">  tag: RootTag,</span></span></span><br><span class="line"><span class="function"><span class="params">  options: void | RootOptions,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">const</span> root = createContainer(container, tag, hydrate, hydrationCallbacks)</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ReactFiberReconciler.old.js</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createContainer</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  containerInfo: Container,</span></span></span><br><span class="line"><span class="function"><span class="params">  tag: RootTag,</span></span></span><br><span class="line"><span class="function"><span class="params">  hydrate: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params">  hydrationCallbacks: null | SuspenseHydrationCallbacks,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">OpaqueRoot</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> createFiberRoot(containerInfo, tag, hydrate, hydrationCallbacks);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ReactFiberRoot.old.js</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createFiberRoot</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  containerInfo: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  tag: RootTag,</span></span></span><br><span class="line"><span class="function"><span class="params">  hydrate: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params">  hydrationCallbacks: null | SuspenseHydrationCallbacks,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">FiberRoot</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">const</span> root: FiberRoot = (<span class="keyword">new</span> FiberRootNode(containerInfo, tag, hydrate): any)</span><br><span class="line">  <span class="keyword">const</span> uninitializedFiber = createHostRootFiber(tag)</span><br><span class="line">  root.current = uninitializedFiber</span><br><span class="line">  uninitializedFiber.stateNode = root</span><br><span class="line">  initializeUpdateQueue(uninitializedFiber)</span><br><span class="line">  <span class="keyword">return</span> root</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>经过这一系列的操作以后，会形成如下的数据结构：</p>
<p><img src="/2020/07/26/react-source-1/1.png" alt=""></p>
<p>然后，会来到：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">unbatchedUpdates(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 这里的 children 是 App 对应的这个 ReactElement</span></span><br><span class="line">  updateContainer(children, fiberRoot, parentComponent, callback)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>这里 <code>unbatchedUpdates</code> 会设置当前的 <code>executionContext</code>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">unbatchedUpdates</span>&lt;<span class="title">A</span>, <span class="title">R</span>&gt;(<span class="params">fn: (a: A</span>) =&gt; <span class="title">R</span>, <span class="title">a</span>: <span class="title">A</span>): <span class="title">R</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> prevExecutionContext = executionContext</span><br><span class="line">  <span class="comment">// 去掉 BatchedContext</span></span><br><span class="line">  executionContext &amp;= ~BatchedContext</span><br><span class="line">  <span class="comment">// 加上 LegacyUnbatchedContext</span></span><br><span class="line">  executionContext |= LegacyUnbatchedContext</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> fn(a)</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    executionContext = prevExecutionContext</span><br><span class="line">    <span class="keyword">if</span> (executionContext === NoContext) &#123;</span><br><span class="line">      <span class="comment">// Flush the immediate callbacks that were scheduled during this batch</span></span><br><span class="line">      flushSyncCallbackQueue()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后执行 <code>updateContainer</code>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">updateContainer</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  element: ReactNodeList,</span></span></span><br><span class="line"><span class="function"><span class="params">  container: OpaqueRoot,</span></span></span><br><span class="line"><span class="function"><span class="params">  parentComponent: ?React$Component&lt;any, any&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  callback: ?Function</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">ExpirationTime</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> current = container.current</span><br><span class="line">  <span class="keyword">const</span> currentTime = requestCurrentTimeForUpdate()</span><br><span class="line">  <span class="keyword">const</span> suspenseConfig = requestCurrentSuspenseConfig()</span><br><span class="line">  <span class="keyword">const</span> expirationTime = computeExpirationForFiber(</span><br><span class="line">    currentTime,</span><br><span class="line">    current,</span><br><span class="line">    suspenseConfig</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> context = getContextForSubtree(parentComponent)</span><br><span class="line">  <span class="keyword">if</span> (container.context === <span class="literal">null</span>) &#123;</span><br><span class="line">    container.context = context</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    container.pendingContext = context</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> update = createUpdate(expirationTime, suspenseConfig)</span><br><span class="line">  <span class="comment">// Caution: React DevTools currently depends on this property</span></span><br><span class="line">  <span class="comment">// being called "element".</span></span><br><span class="line">  update.payload = &#123;element&#125;</span><br><span class="line"></span><br><span class="line">  callback = callback === <span class="literal">undefined</span> ? <span class="literal">null</span> : callback</span><br><span class="line">  <span class="keyword">if</span> (callback !== <span class="literal">null</span>) &#123;</span><br><span class="line">    update.callback = callback</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  enqueueUpdate(current, update)</span><br><span class="line">  scheduleUpdateOnFiber(current, expirationTime)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> expirationTime</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里，会创建一个 <code>update</code>，然后入队，我们的数据结构会变成这样：</p>
<p><img src="/2020/07/26/react-source-1/2.png" alt=""></p>
<p>接下来就到了 <code>scheduleUpdateOnFiber</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">scheduleUpdateOnFiber</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  fiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  expirationTime: ExpirationTime</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  checkForNestedUpdates()</span><br><span class="line">  warnAboutRenderPhaseUpdatesInDEV(fiber)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> root = markUpdateTimeFromFiberToRoot(fiber, expirationTime)</span><br><span class="line">  <span class="keyword">if</span> (root === <span class="literal">null</span>) &#123;</span><br><span class="line">    warnAboutUpdateOnUnmountedFiberInDEV(fiber)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> computeExpirationForFiber also reads the priority. Pass the</span></span><br><span class="line">  <span class="comment">// priority as an argument to that function and this one.</span></span><br><span class="line">  <span class="keyword">const</span> priorityLevel = getCurrentPriorityLevel()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (expirationTime === Sync) &#123;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      <span class="comment">// Check if we're inside unbatchedUpdates</span></span><br><span class="line">      (executionContext &amp; LegacyUnbatchedContext) !== NoContext &amp;&amp;</span><br><span class="line">      <span class="comment">// Check if we're not already rendering</span></span><br><span class="line">      (executionContext &amp; (RenderContext | CommitContext)) === NoContext</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="comment">// Register pending interactions on the root to avoid losing traced interaction data.</span></span><br><span class="line">      schedulePendingInteractions(root, expirationTime)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// This is a legacy edge case. The initial mount of a ReactDOM.render-ed</span></span><br><span class="line">      <span class="comment">// root inside of batchedUpdates should be synchronous, but layout updates</span></span><br><span class="line">      <span class="comment">// should be deferred until the end of the batch.</span></span><br><span class="line">      performSyncWorkOnRoot(root)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 暂时不看</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 暂时不看</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后走到了 <code>performSyncWorkOnRoot</code>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">performSyncWorkOnRoot</span>(<span class="params">root</span>) </span>&#123;</span><br><span class="line">  invariant(</span><br><span class="line">    (executionContext &amp; (RenderContext | CommitContext)) === NoContext,</span><br><span class="line">    <span class="string">'Should not already be working.'</span></span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  flushPassiveEffects()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> lastExpiredTime = root.lastExpiredTime</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> expirationTime</span><br><span class="line">  <span class="keyword">if</span> (lastExpiredTime !== NoWork) &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// There's no expired work. This must be a new, synchronous render.</span></span><br><span class="line">    expirationTime = Sync</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> exitStatus = renderRootSync(root, expirationTime)</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">const</span> finishedWork: Fiber = (root.current.alternate: any);</span><br><span class="line">  root.finishedWork = finishedWork;</span><br><span class="line">  root.finishedExpirationTime = expirationTime;</span><br><span class="line">  root.nextKnownPendingLevel = getRemainingExpirationTime(finishedWork);</span><br><span class="line">  commitRoot(root);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里，可以分为两个大的步骤：</p>
<ol>
<li><code>render</code></li>
<li><code>commit</code></li>
</ol>
<h2 id="render"><a href="#render" class="headerlink" title="render"></a>render</h2><p>首先看看 <code>renderRootSync</code>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">renderRootSync</span>(<span class="params">root, expirationTime</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> prevExecutionContext = executionContext</span><br><span class="line">  executionContext |= RenderContext</span><br><span class="line">  <span class="keyword">const</span> prevDispatcher = pushDispatcher(root)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If the root or expiration time have changed, throw out the existing stack</span></span><br><span class="line">  <span class="comment">// and prepare a fresh one. Otherwise we'll continue where we left off.</span></span><br><span class="line">  <span class="keyword">if</span> (root !== workInProgressRoot || expirationTime !== renderExpirationTime) &#123;</span><br><span class="line">    <span class="comment">// 主要是给 workInProgress 赋值</span></span><br><span class="line">    prepareFreshStack(root, expirationTime)</span><br><span class="line">    startWorkOnPendingInteractions(root, expirationTime)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> prevInteractions = pushInteractions(root)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      workLoopSync()</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (thrownValue) &#123;</span><br><span class="line">      handleError(root, thrownValue)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">  resetContextDependencies()</span><br><span class="line">  <span class="keyword">if</span> (enableSchedulerTracing) &#123;</span><br><span class="line">    popInteractions(((prevInteractions: any): <span class="built_in">Set</span>&lt;Interaction&gt;))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  executionContext = prevExecutionContext</span><br><span class="line">  popDispatcher(prevDispatcher)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (workInProgress !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// This is a sync render, so we should have finished the whole tree.</span></span><br><span class="line">    invariant(</span><br><span class="line">      <span class="literal">false</span>,</span><br><span class="line">      <span class="string">'Cannot commit an incomplete root. This error is likely caused by a '</span> +</span><br><span class="line">        <span class="string">'bug in React. Please file an issue.'</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Set this to null to indicate there's no in-progress render.</span></span><br><span class="line">  workInProgressRoot = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> workInProgressRootExitStatus</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里首先调用 <code>prepareFreshStack(root, expirationTime)</code>，这一句主要是通过 <code>root.current</code> 来创建 <code>workInProgress</code>。调用后，数据结构成了这样：</p>
<p><img src="/2020/07/26/react-source-1/3.png" alt=""></p>
<p>跳过中间的一些语句，我们来到 <code>workLoopSync</code>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">workLoopSync</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Already timed out, so perform work without checking if we need to yield.</span></span><br><span class="line">  <span class="keyword">while</span> (workInProgress !== <span class="literal">null</span>) &#123;</span><br><span class="line">    performUnitOfWork(workInProgress)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">performUnitOfWork</span>(<span class="params">unitOfWork: Fiber</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="comment">// The current, flushed, state of this fiber is the alternate. Ideally</span></span><br><span class="line">  <span class="comment">// nothing should rely on this, but relying on it here means that we don't</span></span><br><span class="line">  <span class="comment">// need an additional field on the work in progress.</span></span><br><span class="line">  <span class="keyword">const</span> current = unitOfWork.alternate</span><br><span class="line">  setCurrentDebugFiberInDEV(unitOfWork)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> next</span><br><span class="line">  <span class="keyword">if</span> (enableProfilerTimer &amp;&amp; (unitOfWork.mode &amp; ProfileMode) !== NoMode) &#123;</span><br><span class="line">    startProfilerTimer(unitOfWork)</span><br><span class="line">    next = beginWork(current, unitOfWork, renderExpirationTime)</span><br><span class="line">    stopProfilerTimerIfRunningAndRecordDelta(unitOfWork, <span class="literal">true</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    next = beginWork(current, unitOfWork, renderExpirationTime)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  resetCurrentDebugFiberInDEV()</span><br><span class="line">  unitOfWork.memoizedProps = unitOfWork.pendingProps</span><br><span class="line">  <span class="keyword">if</span> (next === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// If this doesn't spawn new work, complete the current work.</span></span><br><span class="line">    completeUnitOfWork(unitOfWork)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    workInProgress = next</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ReactCurrentOwner.current = <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里又分为两个步骤：</p>
<ol>
<li><code>beginWork</code>，传入当前 <code>Fiber</code> 节点，创建子 <code>Fiber</code> 节点。</li>
<li><code>completeUnitOfWork</code>，通过 <code>Fiber</code> 节点创建真实 DOM 节点。</li>
</ol>
<p>这两个步骤会交替的执行，其目标是：</p>
<ul>
<li>构建出新的 Fiber 树</li>
<li>与旧 Fiber 比较得到 effect 链表（插入、更新、删除、useEffect 等都会产生 effect）</li>
</ul>
<h3 id="beginWork"><a href="#beginWork" class="headerlink" title="beginWork"></a>beginWork</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">beginWork</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  current: Fiber | null,</span></span></span><br><span class="line"><span class="function"><span class="params">  workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  renderExpirationTime: ExpirationTime</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Fiber</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> updateExpirationTime = workInProgress.expirationTime</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> oldProps = current.memoizedProps</span><br><span class="line">    <span class="keyword">const</span> newProps = workInProgress.pendingProps</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      oldProps !== newProps ||</span><br><span class="line">      hasLegacyContextChanged() ||</span><br><span class="line">      <span class="comment">// Force a re-render if the implementation changed due to hot reload:</span></span><br><span class="line">      (__DEV__ ? workInProgress.type !== current.type : <span class="literal">false</span>)</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="comment">// 略</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (updateExpirationTime &lt; renderExpirationTime) &#123;</span><br><span class="line">      <span class="comment">// 略</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// An update was scheduled on this fiber, but there are no new props</span></span><br><span class="line">      <span class="comment">// nor legacy context. Set this to false. If an update queue or context</span></span><br><span class="line">      <span class="comment">// consumer produces a changed value, it will set this to true. Otherwise,</span></span><br><span class="line">      <span class="comment">// the component will assume the children have not changed and bail out.</span></span><br><span class="line">      didReceiveUpdate = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    didReceiveUpdate = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Before entering the begin phase, clear pending update priority.</span></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> This assumes that we're about to evaluate the component and process</span></span><br><span class="line">  <span class="comment">// the update queue. However, there's an exception: SimpleMemoComponent</span></span><br><span class="line">  <span class="comment">// sometimes bails out later in the begin phase. This indicates that we should</span></span><br><span class="line">  <span class="comment">// move this assignment out of the common path and into each branch.</span></span><br><span class="line">  workInProgress.expirationTime = NoWork</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (workInProgress.tag) &#123;</span><br><span class="line">    <span class="keyword">case</span> IndeterminateComponent:</span><br><span class="line">    <span class="comment">// ...省略</span></span><br><span class="line">    <span class="keyword">case</span> LazyComponent:</span><br><span class="line">    <span class="comment">// ...省略</span></span><br><span class="line">    <span class="keyword">case</span> FunctionComponent:</span><br><span class="line">    <span class="comment">// ...省略</span></span><br><span class="line">    <span class="keyword">case</span> ClassComponent:</span><br><span class="line">    <span class="comment">// ...省略</span></span><br><span class="line">    <span class="keyword">case</span> HostRoot:</span><br><span class="line">      <span class="keyword">return</span> updateHostRoot(current, workInProgress, renderExpirationTime)</span><br><span class="line">    <span class="keyword">case</span> HostComponent:</span><br><span class="line">    <span class="comment">// ...省略</span></span><br><span class="line">    <span class="keyword">case</span> HostText:</span><br><span class="line">    <span class="comment">// ...省略</span></span><br><span class="line">    <span class="comment">// ...省略其他类型</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里因为是 <code>rootFiber</code>，所以会走到 <code>updateHostRoot</code>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateHostRoot</span>(<span class="params">current, workInProgress, renderExpirationTime</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 暂时不看</span></span><br><span class="line">  pushHostRootContext(workInProgress)</span><br><span class="line">  <span class="keyword">const</span> updateQueue = workInProgress.updateQueue</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> nextProps = workInProgress.pendingProps</span><br><span class="line">  <span class="keyword">const</span> prevState = workInProgress.memoizedState</span><br><span class="line">  <span class="keyword">const</span> prevChildren = prevState !== <span class="literal">null</span> ? prevState.element : <span class="literal">null</span></span><br><span class="line">  cloneUpdateQueue(current, workInProgress)</span><br><span class="line">  processUpdateQueue(workInProgress, nextProps, <span class="literal">null</span>, renderExpirationTime)</span><br><span class="line">  <span class="keyword">const</span> nextState = workInProgress.memoizedState</span><br><span class="line">  <span class="comment">// Caution: React DevTools currently depends on this property</span></span><br><span class="line">  <span class="comment">// being called "element".</span></span><br><span class="line">  <span class="keyword">const</span> nextChildren = nextState.element</span><br><span class="line">  <span class="keyword">if</span> (nextChildren === prevChildren) &#123;</span><br><span class="line">    <span class="comment">// 省略</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> root: FiberRoot = workInProgress.stateNode</span><br><span class="line">  <span class="keyword">if</span> (root.hydrate &amp;&amp; enterHydrationState(workInProgress)) &#123;</span><br><span class="line">    <span class="comment">// 省略</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 给 rootFiber 生成子 fiber</span></span><br><span class="line">    reconcileChildren(</span><br><span class="line">      current,</span><br><span class="line">      workInProgress,</span><br><span class="line">      nextChildren,</span><br><span class="line">      renderExpirationTime</span><br><span class="line">    )</span><br><span class="line">    resetHydrationState()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> workInProgress.child</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>经过 <code>updateHostRoot</code> 后，会返回 <code>workInProgress.child</code> 作为下一个 <code>workInProgress</code>，最后的数据结构如下（这里先忽略 <code>reconcileChildren</code> 这个比较复杂的函数）：</p>
<p><img src="/2020/07/26/react-source-1/4.png" alt=""></p>
<p>接着会继续进行 <code>beginWork</code>，这次会来到 <code>mountIndeterminateComponent</code> （暂时忽略）。总之，经过不断的 <code>beginWork</code> 后，我们会得到如下的一个结构：</p>
<p><img src="/2020/07/26/react-source-1/5.png" alt=""></p>
<p>此时 <code>next</code> 为空，我们会走到：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (next === <span class="literal">null</span>) &#123;</span><br><span class="line">  <span class="comment">// If this doesn't spawn new work, complete the current work.</span></span><br><span class="line">  completeUnitOfWork(unitOfWork)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="completeUnitOfWork"><a href="#completeUnitOfWork" class="headerlink" title="completeUnitOfWork"></a>completeUnitOfWork</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">completeUnitOfWork</span>(<span class="params">unitOfWork: Fiber</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Attempt to complete the current unit of work, then move to the next</span></span><br><span class="line">  <span class="comment">// sibling. If there are no more siblings, return to the parent fiber.</span></span><br><span class="line">  <span class="keyword">let</span> completedWork = unitOfWork</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="comment">// The current, flushed, state of this fiber is the alternate. Ideally</span></span><br><span class="line">    <span class="comment">// nothing should rely on this, but relying on it here means that we don't</span></span><br><span class="line">    <span class="comment">// need an additional field on the work in progress.</span></span><br><span class="line">    <span class="keyword">const</span> current = completedWork.alternate</span><br><span class="line">    <span class="keyword">const</span> returnFiber = completedWork.return</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check if the work completed or if something threw.</span></span><br><span class="line">    <span class="keyword">if</span> ((completedWork.effectTag &amp; Incomplete) === NoEffect) &#123;</span><br><span class="line">      setCurrentDebugFiberInDEV(completedWork)</span><br><span class="line">      <span class="keyword">let</span> next</span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        !enableProfilerTimer ||</span><br><span class="line">        (completedWork.mode &amp; ProfileMode) === NoMode</span><br><span class="line">      ) &#123;</span><br><span class="line">        next = completeWork(current, completedWork, renderExpirationTime)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        startProfilerTimer(completedWork)</span><br><span class="line">        next = completeWork(current, completedWork, renderExpirationTime)</span><br><span class="line">        <span class="comment">// Update render duration assuming we didn't error.</span></span><br><span class="line">        stopProfilerTimerIfRunningAndRecordDelta(completedWork, <span class="literal">false</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      resetCurrentDebugFiberInDEV()</span><br><span class="line">      resetChildExpirationTime(completedWork)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (next !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Completing this fiber spawned new work. Work on that next.</span></span><br><span class="line">        workInProgress = next</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        returnFiber !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">        <span class="comment">// Do not append effects to parents if a sibling failed to complete</span></span><br><span class="line">        (returnFiber.effectTag &amp; Incomplete) === NoEffect</span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="comment">// Append all the effects of the subtree and this fiber onto the effect</span></span><br><span class="line">        <span class="comment">// list of the parent. The completion order of the children affects the</span></span><br><span class="line">        <span class="comment">// side-effect order.</span></span><br><span class="line">        <span class="keyword">if</span> (returnFiber.firstEffect === <span class="literal">null</span>) &#123;</span><br><span class="line">          returnFiber.firstEffect = completedWork.firstEffect</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (completedWork.lastEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (returnFiber.lastEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">            returnFiber.lastEffect.nextEffect = completedWork.firstEffect</span><br><span class="line">          &#125;</span><br><span class="line">          returnFiber.lastEffect = completedWork.lastEffect</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If this fiber had side-effects, we append it AFTER the children's</span></span><br><span class="line">        <span class="comment">// side-effects. We can perform certain side-effects earlier if needed,</span></span><br><span class="line">        <span class="comment">// by doing multiple passes over the effect list. We don't want to</span></span><br><span class="line">        <span class="comment">// schedule our own side-effect on our own list because if end up</span></span><br><span class="line">        <span class="comment">// reusing children we'll schedule this effect onto itself since we're</span></span><br><span class="line">        <span class="comment">// at the end.</span></span><br><span class="line">        <span class="keyword">const</span> effectTag = completedWork.effectTag</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Skip both NoWork and PerformedWork tags when creating the effect</span></span><br><span class="line">        <span class="comment">// list. PerformedWork effect is read by React DevTools but shouldn't be</span></span><br><span class="line">        <span class="comment">// committed.</span></span><br><span class="line">        <span class="keyword">if</span> (effectTag &gt; PerformedWork) &#123;</span><br><span class="line">          <span class="keyword">if</span> (returnFiber.lastEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">            returnFiber.lastEffect.nextEffect = completedWork</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            returnFiber.firstEffect = completedWork</span><br><span class="line">          &#125;</span><br><span class="line">          returnFiber.lastEffect = completedWork</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// This fiber did not complete because something threw. Pop values off</span></span><br><span class="line">      <span class="comment">// the stack without entering the complete phase. If this is a boundary,</span></span><br><span class="line">      <span class="comment">// capture values if possible.</span></span><br><span class="line">      <span class="keyword">const</span> next = unwindWork(completedWork, renderExpirationTime)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Because this fiber did not complete, don't reset its expiration time.</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        enableProfilerTimer &amp;&amp;</span><br><span class="line">        (completedWork.mode &amp; ProfileMode) !== NoMode</span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="comment">// Record the render duration for the fiber that errored.</span></span><br><span class="line">        stopProfilerTimerIfRunningAndRecordDelta(completedWork, <span class="literal">false</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Include the time spent working on failed children before continuing.</span></span><br><span class="line">        <span class="keyword">let</span> actualDuration = completedWork.actualDuration</span><br><span class="line">        <span class="keyword">let</span> child = completedWork.child</span><br><span class="line">        <span class="keyword">while</span> (child !== <span class="literal">null</span>) &#123;</span><br><span class="line">          actualDuration += child.actualDuration</span><br><span class="line">          child = child.sibling</span><br><span class="line">        &#125;</span><br><span class="line">        completedWork.actualDuration = actualDuration</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (next !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// If completing this work spawned new work, do that next. We'll come</span></span><br><span class="line">        <span class="comment">// back here again.</span></span><br><span class="line">        <span class="comment">// Since we're restarting, remove anything that is not a host effect</span></span><br><span class="line">        <span class="comment">// from the effect tag.</span></span><br><span class="line">        next.effectTag &amp;= HostEffectMask</span><br><span class="line">        workInProgress = next</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (returnFiber !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Mark the parent fiber as incomplete and clear its effect list.</span></span><br><span class="line">        returnFiber.firstEffect = returnFiber.lastEffect = <span class="literal">null</span></span><br><span class="line">        returnFiber.effectTag |= Incomplete</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> siblingFiber = completedWork.sibling</span><br><span class="line">    <span class="keyword">if</span> (siblingFiber !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// If there is more work to do in this returnFiber, do that next.</span></span><br><span class="line">      workInProgress = siblingFiber</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Otherwise, return to the parent</span></span><br><span class="line">    completedWork = returnFiber</span><br><span class="line">    <span class="comment">// Update the next thing we're working on in case something throws.</span></span><br><span class="line">    workInProgress = completedWork</span><br><span class="line">  &#125; <span class="keyword">while</span> (completedWork !== <span class="literal">null</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// We've reached the root.</span></span><br><span class="line">  <span class="keyword">if</span> (workInProgressRootExitStatus === RootIncomplete) &#123;</span><br><span class="line">    workInProgressRootExitStatus = RootCompleted</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此时这里的 <code>unitOfWork</code> 是 <code>span</code> 对应的 <code>fiber</code>。从函数头部的注释我们可以大致知道该函数的功能：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Attempt to complete the current unit of work, then move to the next</span></span><br><span class="line"><span class="comment">// sibling. If there are no more siblings, return to the parent fiber.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 尝试去完成当前的工作单元，然后处理下一个 sibling。如果没有 sibling 了，就返回去完成父 fiber</span></span><br></pre></td></tr></table></figure>
<p>这里一路走下去最后会来到 <code>completeWork</code> 这里 ：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> HostComponent:</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// 会调用 ReactDOMComponent.js 中的 createELement 方法创建 span 标签</span></span><br><span class="line">  <span class="keyword">const</span> instance = createInstance(</span><br><span class="line">    type,</span><br><span class="line">    newProps,</span><br><span class="line">    rootContainerInstance,</span><br><span class="line">    currentHostContext,</span><br><span class="line">    workInProgress</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 将子元素 append 到 instance 中</span></span><br><span class="line">  appendAllChildren(instance, workInProgress, <span class="literal">false</span>, <span class="literal">false</span>)</span><br><span class="line"></span><br><span class="line">  workInProgress.stateNode = instance;</span><br></pre></td></tr></table></figure>
<p>执行完后，我们的结构如下所示（我们用绿色的圆来表示真实 dom）：</p>
<p><img src="/2020/07/26/react-source-1/6.png" alt=""></p>
<p>此时 <code>next</code> 将会是 <code>null</code>，我们需要往上找到下一个 <code>completedWork</code>，即 <code>Name</code>，因为 <code>Name</code> 是一个 <code>FunctionComponent</code>，所以在 <code>completeWork</code> 中直接返回了 <code>null</code>。又因为它有 <code>sibling</code>，所以会将它的 <code>sibling</code> 赋值给 <code>workInProgress</code>，并返回对其进行 <code>beginWork</code>。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> siblingFiber = completedWork.sibling</span><br><span class="line"><span class="keyword">if</span> (siblingFiber !== <span class="literal">null</span>) &#123;</span><br><span class="line">  <span class="comment">// If there is more work to do in this returnFiber, do that next.</span></span><br><span class="line">  <span class="comment">// workInProgress 更新为 sibling</span></span><br><span class="line">  workInProgress = siblingFiber</span><br><span class="line">  <span class="comment">// 直接返回，回到了 performUnitOfWork</span></span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">performUnitOfWork</span>(<span class="params">unitOfWork: Fiber</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">if</span> (next === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// If this doesn't spawn new work, complete the current work.</span></span><br><span class="line">    <span class="comment">// 上面的代码回到了这里</span></span><br><span class="line">    completeUnitOfWork(unitOfWork)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    workInProgress = next</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ReactCurrentOwner.current = <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样 <code>beginWork</code> 和 <code>completeWork</code> 不断交替的执行，当我们执行到 <code>div</code> 的时候，我们的结构如下所示：</p>
<p><img src="/2020/07/26/react-source-1/7.png" alt=""></p>
<p>之所以要额外的分析 <code>div</code> 的 <code>complete</code> 过程，是因为这个例子方便我们分析 <code>appendAllChildren</code>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">appendAllChildren = <span class="function"><span class="keyword">function</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  parent: Instance,</span></span></span><br><span class="line"><span class="function"><span class="params">  workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  needsVisibilityToggle: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params">  isHidden: boolean</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// We only have the top Fiber that was created but we need recurse down its</span></span><br><span class="line">  <span class="comment">// children to find all the terminal nodes.</span></span><br><span class="line">  <span class="keyword">let</span> node = workInProgress.child</span><br><span class="line">  <span class="keyword">while</span> (node !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (node.tag === HostComponent || node.tag === HostText) &#123;</span><br><span class="line">      appendInitialChild(parent, node.stateNode)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (enableFundamentalAPI &amp;&amp; node.tag === FundamentalComponent) &#123;</span><br><span class="line">      appendInitialChild(parent, node.stateNode.instance)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (node.tag === HostPortal) &#123;</span><br><span class="line">      <span class="comment">// If we have a portal child, then we don't want to traverse</span></span><br><span class="line">      <span class="comment">// down its children. Instead, we'll get insertions from each child in</span></span><br><span class="line">      <span class="comment">// the portal directly.</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (node.child !== <span class="literal">null</span>) &#123;</span><br><span class="line">      node.child.return = node</span><br><span class="line">      node = node.child</span><br><span class="line">      <span class="keyword">continue</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (node === workInProgress) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (node.sibling === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (node.return === <span class="literal">null</span> || node.return === workInProgress) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      node = node.return</span><br><span class="line">    &#125;</span><br><span class="line">    node.sibling.return = node.return</span><br><span class="line">    node = node.sibling</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于 <code>workInProgress</code> 指向 <code>div</code> 这个 <code>fiber</code>，他的 <code>child</code> 是 <code>Name</code>，会进入 <code>else if (node.child !== null)</code> 这个条件分支。然后继续下一个循环，此时 <code>node</code> 为 <code>span</code> 这个 <code>fiber</code>，会进入第一个分支，将 <code>span</code> 对应的 <code>dom</code> 元素插入到 <code>parent</code> 之中。</p>
<p>这样不停的循环，最后会执行到 <code>if (node === workInProgress)</code> 退出，此时所有的子元素都 append 到了 <code>parent</code> 之中：<br><img src="/2020/07/26/react-source-1/9.png" alt=""></p>
<p>然后继续 <code>beginWork</code> 和 <code>completeWork</code>，最后会来到 <code>rootFiber</code>。不同的是，该节点的 <code>alternate</code> 并不为空，且该节点 <code>tag</code> 为 <code>HootRoot</code>，所以 <code>completeWork</code> 时会来到这里：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> HostRoot: &#123;</span><br><span class="line">  ...</span><br><span class="line">  updateHostContainer(workInProgress);</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">updateHostContainer = <span class="function"><span class="keyword">function</span> (<span class="params">workInProgress: Fiber</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Noop</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看来几乎没有做什么事情，到这我们的 <code>render</code> 阶段就结束了，最后的结构如下所示：<br><img src="/2020/07/26/react-source-1/10.png" alt=""></p>
<p>其中蓝色表示是有 effect 的 Fiber 节点，他们组成了一个链表，方便 commit 过程进行遍历。</p>
<p>点击<a href="/react-render/">这里</a>，可以查看 <code>render</code> 过程动画</p>
<h2 id="commit"><a href="#commit" class="headerlink" title="commit"></a>commit</h2><p><code>commit</code> 大致可分为以下过程：</p>
<ul>
<li>准备阶段</li>
<li>before mutation 阶段（执行 DOM 操作前）</li>
<li>mutation 阶段（执行 DOM 操作）</li>
<li>切换 Fiber Tree</li>
<li>layout 阶段（执行 DOM 操作后）</li>
<li>收尾阶段</li>
</ul>
<h3 id="准备阶段"><a href="#准备阶段" class="headerlink" title="准备阶段"></a>准备阶段</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">  <span class="comment">// 触发useEffect回调与其他同步任务。由于这些任务可能触发新的渲染，所以这里要一直遍历执行直到没有任务</span></span><br><span class="line">  flushPassiveEffects()</span><br><span class="line">  <span class="comment">// 暂时没有复现出 rootWithPendingPassiveEffects !== null 的情景</span></span><br><span class="line">  <span class="comment">// 首次渲染 rootWithPendingPassiveEffects 为 null</span></span><br><span class="line">&#125; <span class="keyword">while</span> (rootWithPendingPassiveEffects !== <span class="literal">null</span>)</span><br><span class="line"><span class="comment">// finishedWork 就是正在工作的 rootFiber</span></span><br><span class="line"><span class="keyword">const</span> finishedWork = root.</span><br><span class="line"><span class="comment">// 优先级相关暂时不看</span></span><br><span class="line"><span class="keyword">const</span> expirationTime = root.finishedExpirationTime</span><br><span class="line"><span class="keyword">if</span> (finishedWork === <span class="literal">null</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">&#125;</span><br><span class="line">root.finishedWork = <span class="literal">null</span></span><br><span class="line">root.finishedExpirationTime = NoWork</span><br><span class="line"></span><br><span class="line">root.callbackNode = <span class="literal">null</span></span><br><span class="line">root.callbackExpirationTime = NoWork</span><br><span class="line">root.callbackPriority_old = NoPriority</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> remainingExpirationTimeBeforeCommit = getRemainingExpirationTime(</span><br><span class="line">  finishedWork</span><br><span class="line">)</span><br><span class="line">markRootFinishedAtTime(</span><br><span class="line">  root,</span><br><span class="line">  expirationTime,</span><br><span class="line">  remainingExpirationTimeBeforeCommit</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (rootsWithPendingDiscreteUpdates !== <span class="literal">null</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> lastDiscreteTime = rootsWithPendingDiscreteUpdates.get(root)</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    lastDiscreteTime !== <span class="literal">undefined</span> &amp;&amp;</span><br><span class="line">    remainingExpirationTimeBeforeCommit &lt; lastDiscreteTime</span><br><span class="line">  ) &#123;</span><br><span class="line">    rootsWithPendingDiscreteUpdates.delete(root)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (root === workInProgressRoot) &#123;</span><br><span class="line">  workInProgressRoot = <span class="literal">null</span></span><br><span class="line">  workInProgress = <span class="literal">null</span></span><br><span class="line">  renderExpirationTime = NoWork</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将effectList赋值给firstEffect</span></span><br><span class="line"><span class="comment">// 由于每个fiber的effectList只包含他的子孙节点</span></span><br><span class="line"><span class="comment">// 所以根节点如果有effectTag则不会被包含进来</span></span><br><span class="line"><span class="comment">// 所以这里将有effectTag的根节点插入到effectList尾部</span></span><br><span class="line"><span class="comment">// 这样才能保证有effect的fiber都在effectList中</span></span><br><span class="line"><span class="keyword">let</span> firstEffect</span><br><span class="line"><span class="keyword">if</span> (finishedWork.effectTag &gt; PerformedWork) &#123;</span><br><span class="line">  <span class="keyword">if</span> (finishedWork.lastEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    finishedWork.lastEffect.nextEffect = finishedWork</span><br><span class="line">    firstEffect = finishedWork.firstEffect</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    firstEffect = finishedWork</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  firstEffect = finishedWork.firstEffect</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>准备阶段主要是确定 <code>firstEffect</code>，我们的例子中就是 <code>Name</code> 这个 <code>fiber</code>。</p>
<h3 id="before-mutation-阶段"><a href="#before-mutation-阶段" class="headerlink" title="before mutation 阶段"></a>before mutation 阶段</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> prevExecutionContext = executionContext</span><br><span class="line">executionContext |= CommitContext</span><br><span class="line"><span class="keyword">const</span> prevInteractions = pushInteractions(root)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Reset this to null before calling lifecycles</span></span><br><span class="line">ReactCurrentOwner.current = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// The commit phase is broken into several sub-phases. We do a separate pass</span></span><br><span class="line"><span class="comment">// of the effect list for each phase: all mutation effects come before all</span></span><br><span class="line"><span class="comment">// layout effects, and so on.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// The first phase a "before mutation" phase. We use this phase to read the</span></span><br><span class="line"><span class="comment">// state of the host tree right before we mutate it. This is where</span></span><br><span class="line"><span class="comment">// getSnapshotBeforeUpdate is called.</span></span><br><span class="line">focusedInstanceHandle = prepareForCommit(root.containerInfo)</span><br><span class="line">shouldFireAfterActiveInstanceBlur = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">nextEffect = firstEffect</span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      commitBeforeMutationEffects()</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      invariant(nextEffect !== <span class="literal">null</span>, <span class="string">'Should be working on an effect.'</span>)</span><br><span class="line">      captureCommitPhaseError(nextEffect, error)</span><br><span class="line">      nextEffect = nextEffect.nextEffect</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// We no longer need to track the active instance fiber</span></span><br><span class="line">focusedInstanceHandle = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (enableProfilerTimer) &#123;</span><br><span class="line">  <span class="comment">// Mark the current commit time to be shared by all Profilers in this</span></span><br><span class="line">  <span class="comment">// batch. This enables them to be grouped later.</span></span><br><span class="line">  recordCommitTime()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>before mutation</code> 阶段主要是调用了 <code>commitBeforeMutationEffects</code> 方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitBeforeMutationEffects</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      !shouldFireAfterActiveInstanceBlur &amp;&amp;</span><br><span class="line">      focusedInstanceHandle !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">      isFiberHiddenOrDeletedAndContains(nextEffect, focusedInstanceHandle)</span><br><span class="line">    ) &#123;</span><br><span class="line">      shouldFireAfterActiveInstanceBlur = <span class="literal">true</span></span><br><span class="line">      beforeActiveInstanceBlur()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> effectTag = nextEffect.effectTag</span><br><span class="line">    <span class="keyword">if</span> ((effectTag &amp; Snapshot) !== NoEffect) &#123;</span><br><span class="line">      setCurrentDebugFiberInDEV(nextEffect)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> current = nextEffect.alternate</span><br><span class="line">      <span class="comment">// 调用getSnapshotBeforeUpdate</span></span><br><span class="line">      commitBeforeMutationEffectOnFiber(current, nextEffect)</span><br><span class="line"></span><br><span class="line">      resetCurrentDebugFiberInDEV()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((effectTag &amp; Passive) !== NoEffect) &#123;</span><br><span class="line">      <span class="comment">// If there are passive effects, schedule a callback to flush at</span></span><br><span class="line">      <span class="comment">// the earliest opportunity.</span></span><br><span class="line">      <span class="keyword">if</span> (!rootDoesHavePassiveEffects) &#123;</span><br><span class="line">        rootDoesHavePassiveEffects = <span class="literal">true</span></span><br><span class="line">        scheduleCallback(NormalPriority, () =&gt; &#123;</span><br><span class="line">          flushPassiveEffects()</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    nextEffect = nextEffect.nextEffect</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为 <code>Name</code>  中 <code>effectTag</code> 包括了 <code>Passive</code>，所以这里会执行：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">scheduleCallback(NormalPriority, () =&gt; &#123;</span><br><span class="line">  flushPassiveEffects()</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>这里主要是对 <code>useEffect</code> 中的任务进行异步调用，最终会在下个事件循环中执行 <code>commitPassiveHookEffects</code>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">commitPassiveHookEffects</span>(<span class="params">finishedWork: Fiber</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ((finishedWork.effectTag &amp; Passive) !== NoEffect) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (finishedWork.tag) &#123;</span><br><span class="line">      <span class="keyword">case</span> FunctionComponent:</span><br><span class="line">      <span class="keyword">case</span> ForwardRef:</span><br><span class="line">      <span class="keyword">case</span> SimpleMemoComponent:</span><br><span class="line">      <span class="keyword">case</span> Block: &#123;</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">          enableProfilerTimer &amp;&amp;</span><br><span class="line">          enableProfilerCommitHooks &amp;&amp;</span><br><span class="line">          finishedWork.mode &amp; ProfileMode</span><br><span class="line">        ) &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            startPassiveEffectTimer();</span><br><span class="line">            commitHookEffectListUnmount(</span><br><span class="line">              HookPassive | HookHasEffect,</span><br><span class="line">              finishedWork,</span><br><span class="line">            );</span><br><span class="line">            commitHookEffectListMount(</span><br><span class="line">              HookPassive | HookHasEffect,</span><br><span class="line">              finishedWork,</span><br><span class="line">            );</span><br><span class="line">          &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            recordPassiveEffectDuration(finishedWork);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          commitHookEffectListUnmount(</span><br><span class="line">            HookPassive | HookHasEffect,</span><br><span class="line">            finishedWork,</span><br><span class="line">          );</span><br><span class="line">          commitHookEffectListMount(HookPassive | HookHasEffect, finishedWork);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitHookEffectListUnmount</span>(<span class="params">tag: number, finishedWork: Fiber</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> updateQueue: FunctionComponentUpdateQueue | <span class="literal">null</span> = (finishedWork.updateQueue: any);</span><br><span class="line">  <span class="keyword">const</span> lastEffect = updateQueue !== <span class="literal">null</span> ? updateQueue.lastEffect : <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">if</span> (lastEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> firstEffect = lastEffect.next;</span><br><span class="line">    <span class="keyword">let</span> effect = firstEffect;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> ((effect.tag &amp; tag) === tag) &#123;</span><br><span class="line">        <span class="comment">// Unmount</span></span><br><span class="line">        <span class="keyword">const</span> destroy = effect.destroy;</span><br><span class="line">        effect.destroy = <span class="literal">undefined</span>;</span><br><span class="line">        <span class="keyword">if</span> (destroy !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">          destroy();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      effect = effect.next;</span><br><span class="line">    &#125; <span class="keyword">while</span> (effect !== firstEffect);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitHookEffectListMount</span>(<span class="params">tag: number, finishedWork: Fiber</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> updateQueue: FunctionComponentUpdateQueue | <span class="literal">null</span> = (finishedWork.updateQueue: any);</span><br><span class="line">  <span class="keyword">const</span> lastEffect = updateQueue !== <span class="literal">null</span> ? updateQueue.lastEffect : <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">if</span> (lastEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> firstEffect = lastEffect.next;</span><br><span class="line">    <span class="keyword">let</span> effect = firstEffect;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> ((effect.tag &amp; tag) === tag) &#123;</span><br><span class="line">        <span class="comment">// Mount</span></span><br><span class="line">        <span class="keyword">const</span> create = effect.create;</span><br><span class="line">        effect.destroy = create();</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">      &#125;</span><br><span class="line">      effect = effect.next;</span><br><span class="line">    &#125; <span class="keyword">while</span> (effect !== firstEffect);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中，<code>commitHookEffectListUnmount</code> 会执行 <code>useEffect</code> 上次渲染返回的 <code>destroy</code> 方法，<code>commitHookEffectListMount</code> 会执行 <code>useEffect</code> 本次渲染的 <code>create</code> 方法。具体到我们的例子：</p>
<p><img src="/2020/07/26/react-source-1/11.png" alt=""></p>
<p>因为是首次渲染，所以 <code>destroy</code> 都是 undefined，所以只会打印 <code>useEffect ayou</code>。</p>
<h3 id="mutation-阶段"><a href="#mutation-阶段" class="headerlink" title="mutation 阶段"></a>mutation 阶段</h3><p><code>mutation</code> 阶段主要是执行了 <code>commitMutationEffects</code> 这个方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitMutationEffects</span>(<span class="params">root: FiberRoot, renderPriorityLevel</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> Should probably move the bulk of this function to commitWork.</span></span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    setCurrentDebugFiberInDEV(nextEffect)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> effectTag = nextEffect.effectTag</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The following switch statement is only concerned about placement,</span></span><br><span class="line">    <span class="comment">// updates, and deletions. To avoid needing to add a case for every possible</span></span><br><span class="line">    <span class="comment">// bitmap value, we remove the secondary effects from the effect tag and</span></span><br><span class="line">    <span class="comment">// switch on that value.</span></span><br><span class="line">    <span class="keyword">const</span> primaryEffectTag =</span><br><span class="line">      effectTag &amp; (Placement | Update | Deletion | Hydrating)</span><br><span class="line">    <span class="keyword">switch</span> (primaryEffectTag) &#123;</span><br><span class="line">     <span class="keyword">case</span> Placement: &#123;</span><br><span class="line">        commitPlacement(nextEffect);</span><br><span class="line">        <span class="comment">// Clear the "placement" from effect tag so that we know that this is</span></span><br><span class="line">        <span class="comment">// inserted, before any life-cycles like componentDidMount gets called.</span></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> findDOMNode doesn't rely on this any more but isMounted does</span></span><br><span class="line">        <span class="comment">// and isMounted is deprecated anyway so we should be able to kill this.</span></span><br><span class="line">        nextEffect.effectTag &amp;= ~Placement;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> PlacementAndUpdate: &#123;</span><br><span class="line">        <span class="comment">// Placement</span></span><br><span class="line">        commitPlacement(nextEffect);</span><br><span class="line">        <span class="comment">// Clear the "placement" from effect tag so that we know that this is</span></span><br><span class="line">        <span class="comment">// inserted, before any life-cycles like componentDidMount gets called.</span></span><br><span class="line">        nextEffect.effectTag &amp;= ~Placement;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Update</span></span><br><span class="line">        <span class="keyword">const</span> current = nextEffect.alternate;</span><br><span class="line">        commitWork(current, nextEffect);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> Hydrating: &#123;</span><br><span class="line">        nextEffect.effectTag &amp;= ~Hydrating;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> HydratingAndUpdate: &#123;</span><br><span class="line">        nextEffect.effectTag &amp;= ~Hydrating;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Update</span></span><br><span class="line">        <span class="keyword">const</span> current = nextEffect.alternate;</span><br><span class="line">        commitWork(current, nextEffect);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> Update: &#123;</span><br><span class="line">        <span class="keyword">const</span> current = nextEffect.alternate;</span><br><span class="line">        commitWork(current, nextEffect);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> Deletion: &#123;</span><br><span class="line">        commitDeletion(root, nextEffect, renderPriorityLevel);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中，<code>Name</code> 会走 <code>Update</code> 这个分支，执行 <code>commitWork</code>，最终会执行到 <code>commitHookEffectListUnmount</code>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitHookEffectListUnmount</span>(<span class="params">tag: number, finishedWork: Fiber</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> updateQueue: FunctionComponentUpdateQueue | <span class="literal">null</span> = (finishedWork.updateQueue: any);</span><br><span class="line">  <span class="keyword">const</span> lastEffect = updateQueue !== <span class="literal">null</span> ? updateQueue.lastEffect : <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">if</span> (lastEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> firstEffect = lastEffect.next;</span><br><span class="line">    <span class="keyword">let</span> effect = firstEffect;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> ((effect.tag &amp; tag) === tag) &#123;</span><br><span class="line">        <span class="comment">// Unmount</span></span><br><span class="line">        <span class="keyword">const</span> destroy = effect.destroy;</span><br><span class="line">        effect.destroy = <span class="literal">undefined</span>;</span><br><span class="line">        <span class="keyword">if</span> (destroy !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">          destroy();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      effect = effect.next;</span><br><span class="line">    &#125; <span class="keyword">while</span> (effect !== firstEffect);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里会执行 <code>useLayoutEffect</code> 上次渲染返回的 <code>destroy</code> 方法，我们的例子里是 undefined。</p>
<p>而 <code>App</code> 会走到 <code>Placement</code> 这个分支，执行 <code>commitPlacement</code>，这里的主要工作是把整棵 dom 树插入到了 <code>&lt;div id=&#39;root&#39;&gt;&lt;/div&gt;</code> 之中。</p>
<h3 id="切换-Fiber-Tree"><a href="#切换-Fiber-Tree" class="headerlink" title="切换 Fiber Tree"></a>切换 Fiber Tree</h3><p><code>mutation 阶段完成后</code>，会执行：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root.current = finishedWork</span><br></pre></td></tr></table></figure>
<p>完成后， <code>fiberRoot</code> 会指向 <code>current Fiber</code> 树。</p>
<p><img src="/2020/07/26/react-source-1/12.png" alt=""></p>
<h3 id="layout-阶段"><a href="#layout-阶段" class="headerlink" title="layout 阶段"></a>layout 阶段</h3><p>对应到我们的例子，layout 阶段主要是<strong>同步</strong>执行 <code>useLayoutEffect</code> 中的 <code>create</code> 函数，所以这里会打印 <code>useLayoutEffect ayou</code>。</p>
<h1 id="题目解析"><a href="#题目解析" class="headerlink" title="题目解析"></a>题目解析</h1><p>现在，我们来分析下文章开始的两个题目：</p>
<p>题目一：</p>
<p>渲染下面的组件，打印顺序是什么？</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">const</span> channel = <span class="keyword">new</span> MessageChannel()</span><br><span class="line"></span><br><span class="line"><span class="comment">// onmessage 是一个宏任务</span></span><br><span class="line">channel.port1.onmessage = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'1 message channel'</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  React.useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'2 use effect'</span>)</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Promise</span>.resolve().then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'3 promise'</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  React.useLayoutEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'4 use layout effect'</span>)</span><br><span class="line">    channel.port2.postMessage(<span class="string">''</span>)</span><br><span class="line">  &#125;, [])</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>App<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>解析：</p>
<ol>
<li><p><code>useLayoutEffect</code> 中的任务会跟随渲染过程同步执行，所以先打印 4</p>
</li>
<li><p><code>Promise</code> 对象 <code>then</code> 中的任务是一个微任务，所以在 4 后面执行，打印 3</p>
</li>
<li><p><code>console.log(&#39;1 message channel&#39;)</code> 和 <code>console.log(&#39;2 use effect&#39;)</code> 都会在宏任务中执行，执行顺序就看谁先生成，这里 2 比 1 先，所以先打印 2，再打印 1。</p>
</li>
</ol>
<p>题目二：</p>
<p>点击 <code>p</code> 标签后，下面事件发生的顺序</p>
<ol>
<li>页面显示 xingzhi</li>
<li>console.log(‘useLayoutEffect ayou’)</li>
<li>console.log(‘useLayoutEffect xingzhi’)</li>
<li>console.log(‘useEffect ayou’)</li>
<li>console.log(‘useEffect xingzhi’)</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> &#123;useState&#125; <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Name</span>(<span class="params">&#123;name&#125;</span>) </span>&#123;</span><br><span class="line">  React.useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`useEffect <span class="subst">$&#123;name&#125;</span>`</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`useEffect destroy <span class="subst">$&#123;name&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [name])</span><br><span class="line"></span><br><span class="line">  React.useLayoutEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`useLayoutEffect <span class="subst">$&#123;name&#125;</span>`</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`useLayoutEffect destroy <span class="subst">$&#123;name&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [name])</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;name&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 点击后，下面事件发生的顺序</span></span><br><span class="line"><span class="comment">// 1. 页面显示 xingzhi</span></span><br><span class="line"><span class="comment">// 2. console.log('useLayoutEffect destroy ayou')</span></span><br><span class="line"><span class="comment">// 3. console.log(`useLayoutEffect xingzhi`)</span></span><br><span class="line"><span class="comment">// 4. console.log('useEffect destroy ayou')</span></span><br><span class="line"><span class="comment">// 5. console.log(`useEffect xingzhi`)</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [name, setName] = useState(<span class="string">'ayou'</span>)</span><br><span class="line">  <span class="keyword">const</span> onClick = React.useCallback(<span class="function"><span class="params">()</span> =&gt;</span> setName(<span class="string">'xingzhi'</span>), [])</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;Name name=&#123;name&#125; /&gt;</span><br><span class="line">      &lt;p onClick=&#123;onClick&#125;&gt;I am <span class="number">18</span>&lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>解析：</p>
<ol>
<li><p>span 这个 Fiber 位于 effect 链表的首部，在 commitMutations 中会先处理，所以页面先显示 xingzhi。</p>
</li>
<li><p>Name 这个 Fiber 位于 span 之后，所以 useLayoutEffect 中上一次的 destroy 紧接着其执行。打印 useLayoutEffect ayou。</p>
</li>
<li><p>commitLayoutEffects 中执行 useLayoutEffect 这一次的 create。打印 useLayoutEffect xingzhi。</p>
</li>
<li><p>useEffect 在下一个宏任务中执行，先执行上一次的 destroy，再执行这一次的 create。所以先打印 useEffect ayou，再打印 useEffect xingzhi。</p>
</li>
</ol>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>本文大部分内容都参考自 <a href="https://react.iamkasong.com/" target="_blank" rel="noopener">React 技术揭秘</a>，通过举例及画图走读了一遍首次渲染流程，加深了下自己的理解。</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/react/" rel="tag"># react</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/07/12/modify-code-with-babel/" rel="next" title="使用 babel 修改 js 代码">
                <i class="fa fa-chevron-left"></i> 使用 babel 修改 js 代码
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/08/20/react-event/" rel="prev" title="通过例子来理解 React 事件系统">
                通过例子来理解 React 事件系统 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


            </div>
            


            

  
    <div class="comments" id="comments">
      <div id="lv-container" data-id="city" data-uid="MTAyMC8zODAwNS8xNDUzNQ=="></div>
    </div>

  



          </div>
          
            
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Ayou</p>
              <p class="site-description motion-element" itemprop="description">一名转行的菜鸡程序员</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">111</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">16</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">58</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#题目"><span class="nav-number">1.</span> <span class="nav-text">题目</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#首次渲染流程"><span class="nav-number">2.</span> <span class="nav-text">首次渲染流程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#render"><span class="nav-number">2.1.</span> <span class="nav-text">render</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#beginWork"><span class="nav-number">2.1.1.</span> <span class="nav-text">beginWork</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#completeUnitOfWork"><span class="nav-number">2.1.2.</span> <span class="nav-text">completeUnitOfWork</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#commit"><span class="nav-number">2.2.</span> <span class="nav-text">commit</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#准备阶段"><span class="nav-number">2.2.1.</span> <span class="nav-text">准备阶段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#before-mutation-阶段"><span class="nav-number">2.2.2.</span> <span class="nav-text">before mutation 阶段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mutation-阶段"><span class="nav-number">2.2.3.</span> <span class="nav-text">mutation 阶段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#切换-Fiber-Tree"><span class="nav-number">2.2.4.</span> <span class="nav-text">切换 Fiber Tree</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#layout-阶段"><span class="nav-number">2.2.5.</span> <span class="nav-text">layout 阶段</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#题目解析"><span class="nav-number">3.</span> <span class="nav-text">题目解析</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#总结"><span class="nav-number">4.</span> <span class="nav-text">总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


          
        </div>
      </main>

      <footer id="footer" class="footer">
        <div class="footer-inner">
          <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ayou</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




          







          
        </div>
      </footer>

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
        </div>
      

      
    
  
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  












  





  

  

  

  
  

  

  

  

  
</body>
</html>
