<!DOCTYPE html>




<html class="theme-next mist" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />


<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />





  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="nodejs,grayscale," />










<meta name="description" content="本文介绍了实现了灰度发布的几个方案，并针对一个进行详细的讨论（This article introduce some solutions of implementing grayscale release and discuss one in detail）">
<meta name="keywords" content="nodejs,grayscale">
<meta property="og:type" content="article">
<meta property="og:title" content="实战 - Node.js 服务实现灰度发布（Grayscale Release for Node.js Server in Practice）">
<meta property="og:url" content="http://www.paradeto.com/2024/01/16/nodejs-grayscale/index.html">
<meta property="og:site_name" content="Ayou">
<meta property="og:description" content="本文介绍了实现了灰度发布的几个方案，并针对一个进行详细的讨论（This article introduce some solutions of implementing grayscale release and discuss one in detail）">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://www.paradeto.com/2024/01/16/nodejs-grayscale/1.png">
<meta property="og:image" content="http://www.paradeto.com/2024/01/16/nodejs-grayscale/2.png">
<meta property="og:image" content="http://www.paradeto.com/2024/01/16/nodejs-grayscale/3.png">
<meta property="og:image" content="http://www.paradeto.com/2024/01/16/nodejs-grayscale/4.png">
<meta property="og:image" content="http://www.paradeto.com/2024/01/16/nodejs-grayscale/5.png">
<meta property="og:updated_time" content="2024-01-19T03:54:25.933Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="实战 - Node.js 服务实现灰度发布（Grayscale Release for Node.js Server in Practice）">
<meta name="twitter:description" content="本文介绍了实现了灰度发布的几个方案，并针对一个进行详细的讨论（This article introduce some solutions of implementing grayscale release and discuss one in detail）">
<meta name="twitter:image" content="http://www.paradeto.com/2024/01/16/nodejs-grayscale/1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>







  <link rel="canonical" href="http://www.paradeto.com/2024/01/16/nodejs-grayscale/"/>






  <title>实战 - Node.js 服务实现灰度发布（Grayscale Release for Node.js Server in Practice） | Ayou</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?6a0c6a11d4daa051d62442b432fb279d";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
    
    
      
    

    <div class="container sidebar-position-left page-post-detail">
      <div class="headband"></div>

      <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
        <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Ayou</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Good Good Study, Day Day Up!</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-demo">
          <a href="/demo/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Demo
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/resume" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            About
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
      </header>

      <main id="main" class="main">
        <div class="main-inner">
          <div class="content-wrap">
            <div id="content" class="content">
              

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.paradeto.com/2024/01/16/nodejs-grayscale/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ayou">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ayou">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">实战 - Node.js 服务实现灰度发布（Grayscale Release for Node.js Server in Practice）</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2024-01-16T17:20:04+08:00">
                2024-01-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/nodejs/" itemprop="url" rel="index">
                    <span itemprop="name">nodejs</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          
              <div class="post-description">
                  本文介绍了实现了灰度发布的几个方案，并针对一个进行详细的讨论（This article introduce some solutions of implementing grayscale release and discuss one in detail）
              </div>
          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="前言-Preface"><a href="#前言-Preface" class="headerlink" title="前言 - Preface"></a>前言 - Preface</h1><p>所谓灰度发布（本文特指金丝雀发布），就是线上同时存在两个版本，这里我们把新发布的版本称作金丝雀版，旧版称作稳定版，根据一定的策略让部分用户访问金丝雀版，部分用户访问稳定版。同时还需要根据线上两个版本的监控数据来调整流量比例。通过这种方式可以，我们可以：</p>
<ul>
<li>在不影响太多用户的前提下，帮助我们提前发现软件中潜在的问题</li>
<li>方便我们在同一时期在两个版本之间进行一些对比</li>
</ul>
<p>所以，实现灰度发布还是比较有意义的一件事情。</p>
<p>Grayscale release(In this article we refer to the canary release specifically) is to make there are two versions online at the same time(Here, we refer to the new version as Canary, and the old version as Stable). Then according to a specific strategy, we can expose the Canary to a portion of users, and expose the Stable to others.<br>At the same time, we need to adjust the traffic ratio based on the two versions’ behavior. In this way, we can:</p>
<ul>
<li>Help us identify potential problems in advance without affecting many users</li>
<li>Help us easily compare new and old versions during the same period</li>
</ul>
<p>So building a grayscale release system is significant.</p>
<h1 id="可选方案-Solutions"><a href="#可选方案-Solutions" class="headerlink" title="可选方案 - Solutions"></a>可选方案 - Solutions</h1><p>一般情况下，我们的 Node.js 服务都会按照如下的架构运行：</p>
<p>Generally, a Node.js server will run under the follow architecture:</p>
<p><img src="/2024/01/16/nodejs-grayscale/1.png" alt=""></p>
<p>用户访问先到达网关层，网关层采用负载均衡策略把流量分发到各个容器，容器中通过 PM2 集群模式运行 Node.js 服务，主进程接收连接并分发到子进程（关于 Node.js cluster 模块可以看<a href="/2022/12/15/nodejs-cluster-principle/">这篇文章</a>）。</p>
<p>The request reaches to the gateway, then the gateway will distribute the traffic to containers according to loading balance strategy. In a container, a Node.js server will be deployed in cluster mode using PM2. The master process will receive the connection and distribute among child processed. Refer to <a href="/2022/12/15/nodejs-cluster-principle/">this article</a> to learn more about Node.js cluster.</p>
<p>所以，我们可以从不同的层面来实现灰度发布。</p>
<p>So, we can implement grayscale release from different levels.</p>
<h2 id="基于容器-Containers-Based"><a href="#基于容器-Containers-Based" class="headerlink" title="基于容器 - Containers Based"></a>基于容器 - Containers Based</h2><p><img src="/2024/01/16/nodejs-grayscale/2.png" alt=""></p>
<p>优点：</p>
<ul>
<li>对服务代码 0 侵入</li>
<li>不同版本之间完全隔离</li>
<li>借助现成的容器管理相关工具，可以比较方便地实现</li>
</ul>
<p>缺点：</p>
<ul>
<li>灵活性较差，比如如果我们需要根据用户的一些特征来进行流量分发的话需要在网关层写一些代码，但是网关层一般是通用的，不一定能支持。</li>
</ul>
<p>Pros:</p>
<ul>
<li>No need to modify server code.</li>
<li>Complete isolation between two version.</li>
<li>It is convenient to realize with some containers management tools like K8s.</li>
</ul>
<p>Cons:</p>
<ul>
<li>Bad flexibility, ad the gateway is generic, it may not support customization like distribute traffic according to users’ characteristics.</li>
</ul>
<h2 id="基于进程-Processes-Based"><a href="#基于进程-Processes-Based" class="headerlink" title="基于进程 - Processes Based"></a>基于进程 - Processes Based</h2><p><img src="/2024/01/16/nodejs-grayscale/3.png" alt=""></p>
<p>优点：</p>
<ul>
<li>非常灵活，可以在主进程中按照业务需求来实现各种策略的流量分发。</li>
<li>对服务代码侵入小</li>
<li>版本间通过进程来进行隔离，还是比较安全的。目前能够想到的一种会导致灰度发布系统不能正常工作的场景是：某个版本的代码运行抢占了大部分的资源，从而导致另一个版本无法提供服务。</li>
</ul>
<p>缺点：</p>
<ul>
<li>需要自己实现主进程并进行进程管理，无法复用 PM2 的 cluster 模式。且主进程如果出现了比较严重的问题，整个灰度发布系统也会瘫痪。</li>
</ul>
<p>Pros:</p>
<ul>
<li>Flexible, you can customize the traffic distribution strategy in master process.</li>
<li>Need very few changes to server code.</li>
<li>The isolation between versions is implemented by multi-processes, and it is safe enough. There is a scenario that may make grayscale release system cannot work properly is that the resources are exhausted</li>
</ul>
<p>Cons:</p>
<ul>
<li>Need to implement master process and manage processes by yourself, cannot use PM2 cluster mode to deploy. If something seriously goes wrong with the master process, the whole grayscale system will go down.</li>
</ul>
<h2 id="基于模块-Modules-Based"><a href="#基于模块-Modules-Based" class="headerlink" title="基于模块 - Modules Based"></a>基于模块 - Modules Based</h2><p><img src="/2024/01/16/nodejs-grayscale/4.png" alt=""></p>
<p>以 koa 为例，基于模块的方式，用代码表示大概就是这样：</p>
<p>Taking koa as an example, the modules based approach will be like this:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// canary.js or stable.js</span></span><br><span class="line"><span class="keyword">const</span> koa = <span class="built_in">require</span>(<span class="string">'koa'</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa()</span><br><span class="line">app.use(<span class="keyword">async</span> <span class="function"><span class="keyword">function</span>(<span class="params">ctx</span>) </span>&#123;</span><br><span class="line">  ctx.body = <span class="string">'canary'</span> <span class="comment">// or stable</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="built_in">module</span>.exports = app</span><br><span class="line"></span><br><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>)</span><br><span class="line"><span class="keyword">const</span> canaryApp = <span class="built_in">require</span>(<span class="string">'./canary'</span>)</span><br><span class="line"><span class="keyword">const</span> stableApp = <span class="built_in">require</span>(<span class="string">'./stable'</span>)</span><br><span class="line"></span><br><span class="line">http.createServer(<span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="comment">/* Canary */</span>) &#123;</span><br><span class="line">    canaryApp.callback()(req, res)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    stableApp.callback()(req, res)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;).listen(<span class="number">8080</span>)</span><br></pre></td></tr></table></figure>
<p>优点：</p>
<ul>
<li>同样可以非常灵活地实现各种策略的流量分发</li>
<li>相比基于进程的方式，不需要自己实现主进程及进程管理相关逻辑，可以复用 PM2</li>
</ul>
<p>缺点：</p>
<ul>
<li>不同版本运行在同一个上下文，版本间的隔离性非常依赖程序员的技术水平。比如，如果代码中有修改全局变量的操作，两者之间会互相影响。</li>
</ul>
<p>Pros:</p>
<ul>
<li>It is also very flexible</li>
<li>Compared to processed based way, it don’t need to implement master process and process management logic and we can still use PM2 cluster mode to deploy.</li>
</ul>
<p>Cons:</p>
<ul>
<li>It is very dependent on developers’ skill levels to achieve a good level of isolation between two versions as they run in the same context. Fox example, if the server has the code that changes global variable, the two versions will affect each other.</li>
</ul>
<p>考虑到我们的需求一：需要可以灵活制定流量分发策略，排除基于容器的方案。又由于我们的服务中确实有修改全局变量的操作，且重构起来有比较大的风险，所以不得已只好采取方案 2，即基于进程的方式。</p>
<p>Considering our requirement one: need to support customizing traffic distribution strategy flexibly, we ruled out solution which is based on container. Since our server indeed contains the operation of changing global variable, and refactoring is risky, we have to choose option two, which is processes based.</p>
<h1 id="实现基于进程的灰度发布-Implement-Grayscale-Release-Based-on-Processes"><a href="#实现基于进程的灰度发布-Implement-Grayscale-Release-Based-on-Processes" class="headerlink" title="实现基于进程的灰度发布 - Implement Grayscale Release Based on Processes"></a>实现基于进程的灰度发布 - Implement Grayscale Release Based on Processes</h1><p><img src="/2024/01/16/nodejs-grayscale/5.png" alt=""></p>
<p>系统架构图如上，我们需要开发一个 Traffic Distribution(TD) 服务，当它启动时会根据流量比例 fork 出 canary 和 stable 作为它的子进程。TD 维护两个进程池来管理这些子进程，进程池主要功能包括负载均衡，端口的管理（避免子进程启动时出现端口冲突），扩缩容等。TD 同时作为 HTTP 请求代理，上游对接用户请求，下游对接子进程。TD 对接配置服务，支持实时修改流量分发策略。具体实现代码有点多就不贴出来了。</p>
<p>We need to implement a Traffic Distribution(TD) server, when it is started, it will fork out some canary and stable child processes. TD will use two process pools to manage these processes by group, the process pool’s functions include: load balance, port management, scale/shrink etc. TD will act as a HTTP proxy between users and child processes. TD will connect to configuration server to support update strategy in real time.</p>
<p>看起来还不错，但是总感觉奇奇怪怪是怎么回事呢？系统不仅多了一次 HTTP 调用，而且还得小心地进行端口处理来避免多个进程监听同一个端口。能不能做到像 PM2 那么丝滑呢？仔细想了想，其实没法做到。我们知道，PM2 的 cluster 模式是通过进程间句柄传递来实现的，关于这个可以看<a href="/2022/12/15/nodejs-cluster-principle/">这篇文章</a>，如果模仿它，简单的实现方式如下所示：</p>
<p>Looks good, but a bit strange. It add an extra HTTP calling, and need to manage the port carefully to avoid port conflict. Can we implement like PM2? The answer is no. As we al know that the PM2 cluster mode is implemented by passing handle, refer to this <a href="/2022/12/15/nodejs-cluster-principle/">article</a>. A simple mock demo is like this:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// master.js</span></span><br><span class="line"><span class="keyword">const</span> cp = <span class="built_in">require</span>(<span class="string">'child_process'</span>)</span><br><span class="line"><span class="keyword">const</span> child1 = cp.fork(<span class="string">'child.js'</span>)</span><br><span class="line"><span class="keyword">const</span> child2 = cp.fork(<span class="string">'child.js'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> tcpServer = <span class="built_in">require</span>(<span class="string">'net'</span>).createServer()</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> processes = [child1, child2]</span><br><span class="line"></span><br><span class="line">tcpServer.on(<span class="string">'connection'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">socket</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> child = processes.pop()</span><br><span class="line">  child1.send(<span class="string">'socket'</span>, socket)</span><br><span class="line">  processes.unshift(child)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">tcpServer.listen(<span class="number">8081</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// child.js</span></span><br><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> httpServer = http.createServer(<span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  res.writeHead(<span class="number">200</span>, &#123;<span class="string">'Content-Type'</span>: <span class="string">'text/plain'</span>&#125;)</span><br><span class="line">  res.end(<span class="string">'handled by child, pid is '</span> + process.pid + <span class="string">'\n'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">process.on(<span class="string">'message'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">m, socket</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (m === <span class="string">'socket'</span>) &#123;</span><br><span class="line">    httpServer.emit(<span class="string">'connection'</span>, socket)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>上图代码表示的大概意思是，主进程建立好连接后把 handle 传递给子进程，交给子进程进行后续的处理。显然，主进程中此时是无法获取到任何应用层相关的信息的，如果流量分发策略仅跟用户 IP 地址相关的话是没问题的，因为 socket 里面有相关信息：</p>
<p>From the code above, we can learn that the master process cannot access anything infomation of application layer, if the strategy is only related with IP address, it is ok. As the socket contains these information:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(socket.remoteAddress, socket.remotePort)</span><br></pre></td></tr></table></figure>
<p>但是如果是跟 HTTP 中的内容如 cookie 等相关的话，就无法实现了。</p>
<p>But if the strategy is related with the content of HTTP like cookie, it cannot achieve.</p>
<p>那有没有可能 master 和 child 之间的数据传输用别的更快的方式来实现呢？理论上是可以的，比如使用 IPC 的方式，下面是一个简单的例子：</p>
<p>Is it possible to pass data more effectively between master and child? Of course yes, for example by IPC, here is a simple demo:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// master.js</span></span><br><span class="line"><span class="keyword">const</span> child = <span class="built_in">require</span>(<span class="string">'child_process'</span>).fork(<span class="string">'./child.js'</span>)</span><br><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>)</span><br><span class="line"><span class="keyword">const</span> net = <span class="built_in">require</span>(<span class="string">'net'</span>)</span><br><span class="line"><span class="keyword">const</span> url = <span class="built_in">require</span>(<span class="string">'url'</span>)</span><br><span class="line"></span><br><span class="line">child.on(<span class="string">'message'</span>, (msg) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (msg.cmd === <span class="string">'ipc_ready'</span>) &#123;</span><br><span class="line">    http</span><br><span class="line">      .createServer(<span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'0000'</span>)</span><br><span class="line">        <span class="keyword">const</span> &#123;pathname&#125; = url.parse(req.url)</span><br><span class="line">        <span class="keyword">const</span> reqNeedToSerialize = &#123;</span><br><span class="line">          host: <span class="string">'localhost'</span>,</span><br><span class="line">          port: <span class="number">3001</span>,</span><br><span class="line">          path: pathname,</span><br><span class="line">          method: req.method,</span><br><span class="line">          headers: req.headers,</span><br><span class="line">          url: pathname,</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> socket = net.createConnection(&#123;<span class="attr">path</span>: msg.ipcPath&#125;)</span><br><span class="line">        socket.write(<span class="built_in">JSON</span>.stringify(&#123;<span class="attr">req</span>: reqNeedToSerialize&#125;))</span><br><span class="line">        socket.pipe(res)</span><br><span class="line">      &#125;)</span><br><span class="line">      .listen(<span class="number">8080</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// child.js</span></span><br><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>)</span><br><span class="line"><span class="keyword">const</span> Router = <span class="built_in">require</span>(<span class="string">'koa-router'</span>)</span><br><span class="line"><span class="keyword">const</span> net = <span class="built_in">require</span>(<span class="string">'net'</span>)</span><br><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">'crypto'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa()</span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> Router()</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">'/'</span>, (ctx) =&gt; &#123;</span><br><span class="line">  ctx.body = <span class="string">'hello world'</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.use(router.routes())</span><br><span class="line"></span><br><span class="line">app.on(<span class="string">'error'</span>, <span class="built_in">console</span>.log)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ipcPrefix =</span><br><span class="line">  (process.platform != <span class="string">'win32'</span> ? <span class="string">'/tmp/'</span> : <span class="string">'\\\\.\\pipe\\'</span>) +</span><br><span class="line">  crypto.randomBytes(<span class="number">8</span>).toString(<span class="string">'hex'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ipcPath = <span class="string">`<span class="subst">$&#123;ipcPrefix&#125;</span><span class="subst">$&#123;process.pid&#125;</span>`</span></span><br><span class="line"></span><br><span class="line">net</span><br><span class="line">  .createServer() <span class="comment">// the IPC server</span></span><br><span class="line">  .listen(ipcPath, () =&gt; process.send(&#123;<span class="attr">cmd</span>: <span class="string">'ipc_ready'</span>, ipcPath&#125;))</span><br><span class="line">  .on(<span class="string">'connection'</span>, (socket) =&gt; &#123;</span><br><span class="line">    socket.on(<span class="string">'data'</span>, (chunk) =&gt; &#123;</span><br><span class="line">      <span class="keyword">const</span> msg = <span class="built_in">JSON</span>.parse(chunk.toString())</span><br><span class="line">      <span class="keyword">if</span> (msg.req) &#123;</span><br><span class="line">        socket.setHeader = <span class="function"><span class="params">()</span> =&gt;</span> &#123;&#125;</span><br><span class="line">        app.callback()(msg.req, socket)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>
<p>可以看到我们把 <code>msg.req</code> 和 <code>socket</code> 分别当做了 native 的 <code>http.IncomingMessage</code> 和 <code>http.ServerResponse</code> 传给了 koa app 去处理。但是这两个东西都是我们 mock 出来的，缺失了很多属性和方法，所以目前这个 demo 也只能处理一些非常简单的请求，要想实现完整的功能可能还需要做很多工作。</p>
<p>You can see that we pass <code>msg.req</code> and <code>socket</code> as native <code>http.IncomingMessage</code> and <code>http.ServerResponse</code> to koa app to handle. But these two object is simulated by us, and they lack lots of properties and functions. So the demo can only handle some very simple requests right now. There is still a lot to do if we want to implement full functionality.</p>
<p>可见，使用 HTTP 代理的方式目前是不得已的。</p>
<p>As you can see, using HTTP proxy is currently a last resort.</p>
<h1 id="总结-Summary"><a href="#总结-Summary" class="headerlink" title="总结 - Summary"></a>总结 - Summary</h1><p>本文从三个层面介绍了实现灰度发布的方式：基于容器、基于进程、基于模块。然后着重讨论了基于进程的方案，并分析了为什么采用 HTTP 代理的方式。</p>
<p>This article introduced how to implement grayscale release from three levels: Containers Based, Processes Based, Modules Based. Then discussed emphatically the solution of Processes Based, and why it need to use HTTP proxy.</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/nodejs/" rel="tag"># nodejs</a>
          
            <a href="/tags/grayscale/" rel="tag"># grayscale</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2023/11/16/chrome-plugin-parallel-translate-2/" rel="next" title="Chrome 插件开发实战：实现一个对照翻译插件（二）翻译部分">
                <i class="fa fa-chevron-left"></i> Chrome 插件开发实战：实现一个对照翻译插件（二）翻译部分
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2024/01/22/nodejs-http-agent/" rel="prev" title="在 Node.js 中使用 HTTP Agent 实现 keep-alive (To request with keep-alive using HTTP agent in Node.js)">
                在 Node.js 中使用 HTTP Agent 实现 keep-alive (To request with keep-alive using HTTP agent in Node.js) <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


            </div>
            


            

  
    <div class="comments" id="comments">
      <div id="lv-container" data-id="city" data-uid="MTAyMC8zODAwNS8xNDUzNQ=="></div>
    </div>

  



          </div>
          
            
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Ayou</p>
              <p class="site-description motion-element" itemprop="description">一名转行的菜鸡程序员</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">160</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">19</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">82</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#前言-Preface"><span class="nav-number">1.</span> <span class="nav-text">前言 - Preface</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#可选方案-Solutions"><span class="nav-number">2.</span> <span class="nav-text">可选方案 - Solutions</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#基于容器-Containers-Based"><span class="nav-number">2.1.</span> <span class="nav-text">基于容器 - Containers Based</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#基于进程-Processes-Based"><span class="nav-number">2.2.</span> <span class="nav-text">基于进程 - Processes Based</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#基于模块-Modules-Based"><span class="nav-number">2.3.</span> <span class="nav-text">基于模块 - Modules Based</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#实现基于进程的灰度发布-Implement-Grayscale-Release-Based-on-Processes"><span class="nav-number">3.</span> <span class="nav-text">实现基于进程的灰度发布 - Implement Grayscale Release Based on Processes</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#总结-Summary"><span class="nav-number">4.</span> <span class="nav-text">总结 - Summary</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


          
        </div>
      </main>

      <footer id="footer" class="footer">
        <div class="footer-inner">
          <div class="copyright">&copy; <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ayou</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




          







          
        </div>
      </footer>

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
        </div>
      

      
    
  
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  












  





  

  

  

  
  

  

  

  

  
</body>
</html>
