<!DOCTYPE html>




<html class="theme-next mist" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />


<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />





  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="react,wasm," />










<meta name="description" content="模仿 big-react，使用 Rust 和 WebAssembly，从零实现 React v18 的核心功能。深入理解 React 源码的同时，还锻炼了 Rust 的技能，简直赢麻了！ 代码地址：https://github.com/ParadeTo/big-react-wasm 本文对应 tag：v13   Based on big-react，I am going to implement">
<meta name="keywords" content="react,wasm">
<meta property="og:type" content="article">
<meta property="og:title" content="从零实现 React v18，但 WASM 版 - [13] 引入 Lane 模型，实现 Batch Update">
<meta property="og:url" content="http://www.paradeto.com/2024/05/11/big-react-wasm-13/index.html">
<meta property="og:site_name" content="Ayou">
<meta property="og:description" content="模仿 big-react，使用 Rust 和 WebAssembly，从零实现 React v18 的核心功能。深入理解 React 源码的同时，还锻炼了 Rust 的技能，简直赢麻了！ 代码地址：https://github.com/ParadeTo/big-react-wasm 本文对应 tag：v13   Based on big-react，I am going to implement">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2024-05-17T07:13:25.747Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="从零实现 React v18，但 WASM 版 - [13] 引入 Lane 模型，实现 Batch Update">
<meta name="twitter:description" content="模仿 big-react，使用 Rust 和 WebAssembly，从零实现 React v18 的核心功能。深入理解 React 源码的同时，还锻炼了 Rust 的技能，简直赢麻了！ 代码地址：https://github.com/ParadeTo/big-react-wasm 本文对应 tag：v13   Based on big-react，I am going to implement">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>







  <link rel="canonical" href="http://www.paradeto.com/2024/05/11/big-react-wasm-13/"/>






  <title>从零实现 React v18，但 WASM 版 - [13] 引入 Lane 模型，实现 Batch Update | Ayou</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?6a0c6a11d4daa051d62442b432fb279d";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
    
    
      
    

    <div class="container sidebar-position-left page-post-detail">
      <div class="headband"></div>

      <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
        <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Ayou</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Good Good Study, Day Day Up!</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-demo">
          <a href="/demo/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Demo
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/resume" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            About
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
      </header>

      <main id="main" class="main">
        <div class="main-inner">
          <div class="content-wrap">
            <div id="content" class="content">
              

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.paradeto.com/2024/05/11/big-react-wasm-13/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ayou">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ayou">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">从零实现 React v18，但 WASM 版 - [13] 引入 Lane 模型，实现 Batch Update</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2024-05-11T09:17:13+08:00">
                2024-05-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/rust/" itemprop="url" rel="index">
                    <span itemprop="name">rust</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <blockquote>
<p>模仿 <a href="https://github.com/BetaSu/big-react" target="_blank" rel="noopener">big-react</a>，使用 Rust 和 WebAssembly，从零实现 React v18 的核心功能。深入理解 React 源码的同时，还锻炼了 Rust 的技能，简直赢麻了！</p>
<p>代码地址：<a href="https://github.com/ParadeTo/big-react-wasm" target="_blank" rel="noopener">https://github.com/ParadeTo/big-react-wasm</a></p>
<p>本文对应 tag：<a href="https://github.com/ParadeTo/big-react-wasm/tree/v13" target="_blank" rel="noopener">v13</a></p>
</blockquote>
<blockquote>
<p>Based on <a href="https://github.com/BetaSu/big-react" target="_blank" rel="noopener">big-react</a>，I am going to implement React v18 core features from scratch using WASM and Rust.</p>
<p>Code Repository：<a href="https://github.com/ParadeTo/big-react-wasm" target="_blank" rel="noopener">https://github.com/ParadeTo/big-react-wasm</a></p>
<p>The tag related to this article：<a href="https://github.com/ParadeTo/big-react-wasm/tree/v13" target="_blank" rel="noopener">v13</a></p>
</blockquote>
<p>我们知道，React 从 v17 开始使用 Lane 模型来替代之前的 Expiration Time 。为什么会有这种变化呢？我们先来看看之前的 Expiration Time 模型是怎么工作的。</p>
<p>We know that starting from v17, React has been using the Lane model to replace the previous Expiration Time model. Why was this change made? Let’s first take a look at how the former Expiration Time model worked.</p>
<p>每次触发更新，会产生一个 <code>update</code> 的数据结构，该结构上有个 <code>expirationTime</code> 的字段用来表示优先级。顾名思义，<code>expirationTimes</code> 是过期时间的意思，按照我们的惯例这个值越小表示越快过期，优先级应该越高。但它的值并不是简单的用当前时间加上一个常数得到的，而是经过了一系列的算法，最终的效果就是值越大优先级越高。一个 Fiber Tree 的 <code>FiberNode</code> 可能存在多个 <code>update</code>。</p>
<p>Each time an update is triggered, an <code>update</code> data structure is created, which has an <code>expirationTime</code> field to represent its priority. As the name implies, <code>expirationTimes</code> means the time after which the update is considered stale. According to our convention, the smaller the value, the sooner it expires, and the higher the priority should be. However, its value is not simply determined by adding a constant to the current time; it is the result of a series of algorithms, which ultimately mean that a larger value indicates a higher priority. A Fiber Tree’s <code>FiberNode</code> may have multiple <code>updates</code>.</p>
<p>每次 React 调度更新时，会在所有 <code>FiberNode</code> 节点的所有 <code>update.expirationTime</code> 中选择一个 <code>expirationTime</code> 作为本次更新的 <code>renderExpirationTime</code>，如果 <code>FiberNode</code> 中的 <code>update.expirationTime</code> &lt; <code>renderExpirationTime</code>，则该 <code>update</code> 会被跳过：</p>
<p>Every time React schedules an update, it selects an <code>expirationTime</code> from all the <code>update.expirationTimes</code> in all the <code>FiberNode</code> nodes to be the <code>renderExpirationTime</code> for this update. If the <code>update.expirationTime</code> in a <code>FiberNode</code> is less than the <code>renderExpirationTime</code>, then that <code>update</code> will be skipped:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/facebook/react/blob/v16.10.0/packages/react-reconciler/src/ReactUpdateQueue.js#L516-L518</span></span><br><span class="line"><span class="keyword">const</span> updateExpirationTime = update.expirationTime;</span><br><span class="line">    <span class="keyword">if</span> (updateExpirationTime &lt; renderExpirationTime) &#123;</span><br><span class="line">      <span class="comment">// This update does not have sufficient priority. Skip it.</span></span><br></pre></td></tr></table></figure>
<p>可以看到，使用 Expiration Time 这种模型时，如果想要判断当前更新任务是否包含在某个更新批次中，我们可以这样比较他们的优先级：</p>
<p>It can be seen that when using the Expiration Time model, if we want to determine whether a current update task is included in a certain batch of updates, we can compare their priorities like this:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> isTaskIncludedInBatch = priorityOfTask &gt;= priorityOfBatch</span><br></pre></td></tr></table></figure>
<p>这种方式的结果就是低优先级的任务不能单独拧出来处理。比如给定优先级 A &gt; B &gt; C，你不能在不处理 A 的情况下处理 B；同样，你不能在不同时处理 B 和 A 的情况下处理 C。</p>
<p>The result of this method is that tasks with lower priority cannot be processed individually. For example, given priorities A &gt; B &gt; C, you cannot process B without handling A; similarly, you cannot handle C without also handling B and A at the same time.</p>
<p>在 <code>Suspense</code> 出现之前，这样做是合理的。但是，当你引入了 IO 任务（即 Suspense），你可能会遇到一个情况，即一个高优先级的 IO 任务阻止了一个低优先级的 CPU 任务，但实际情况我们期望低优先级的 CPU 任务先完成。</p>
<p>Before the introduction of <code>Suspense</code>, this was reasonable. However, when you introduce IO tasks (i.e., Suspense), you might encounter a situation where a high-priority IO task prevents a low-priority CPU task from executing, while in reality, we would prefer the low-priority CPU task to complete first.</p>
<p>考虑如下代码：</p>
<p>Consider the following code:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> App = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = useState(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> t = setInterval(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      setCount(<span class="function">(<span class="params">count</span>) =&gt;</span> count + <span class="number">1</span>)</span><br><span class="line">    &#125;, <span class="number">1000</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> clearInterval(t)</span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;&gt;</span><br><span class="line">      &lt;Suspense fallback=&#123;&lt;div&gt;loading...&lt;<span class="regexp">/div&gt;&#125;&gt;</span></span><br><span class="line"><span class="regexp">        &lt;Comp /</span>&gt;</span><br><span class="line">      &lt;<span class="regexp">/Suspense&gt;</span></span><br><span class="line"><span class="regexp">      &lt;div&gt;count is &#123;count&#125;&lt;/</span>div&gt;</span><br><span class="line">    &lt;<span class="regexp">/&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<p>其中：</p>
<ul>
<li><code>Comp</code> 中会发起异步请求（假设 2 秒后才返回），请求返回前会一直显示 loading</li>
<li>每隔 1 秒将 count 加一</li>
</ul>
<p>则看到的效果应该是这样：</p>
<p>Within this scenario:</p>
<ul>
<li><code>Comp</code> initiates an asynchronous request (assuming it takes 2 seconds to return), and it will continuously show loading until the request returns.</li>
<li>The count is incremented by one every second.</li>
</ul>
<p>The observed effect should be as follows:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span>loading...<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span>count is 0<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">=&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span>loading...<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span>count is 1<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">=&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span>loading...<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span>count is 2<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">=&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span>I am comp, request successfully<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span>count is 3<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>但是如果按照 Expiration Time 模型的规则，由于 <code>Suspense</code> 对应的高优 IO 更新会阻止低优先级的 CPU 更新，所以看到的内容会是下面这样：</p>
<p>However, if we follow the rules of the Expiration Time model, since the high-priority IO update corresponding to <code>Suspense</code> will block the low-priority CPU update, the content observed would be as follows:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span>loading...<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span>count is 0<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">=&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span>loading...<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span>count is 0<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">=&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span>loading...<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span>count is 0<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">=&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span>I am comp, request successfully<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span>count is 3<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>Expiration Time 的另一个缺陷是在表示多个优先级组的方式上受到限制。使用 <code>Set</code> 的话在内存或计算上都不实际，因为要处理的计算非常普遍，所以需要尽可能快速并且使用尽可能少的内存。</p>
<p>作为妥协，我们通常会做的是维护一个优先级范围：</p>
<p>Another flaw of the Expiration Time model is its limitation in representing multiple groups of priorities. Using a <code>Set</code> is impractical both in terms of memory and computation, because the calculations to be handled are very common, so they need to be as fast as possible and use as little memory as possible.</p>
<p>As a compromise, what we would typically do is maintain a range of priorities:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> isTaskIncludedInBatch =</span><br><span class="line">  taskPriority &lt;= highestPriorityInRange &amp;&amp;</span><br><span class="line">  taskPriority &gt;= lowestPriorityInRange</span><br></pre></td></tr></table></figure>
<p>如果是多个不连续的范围那代码写起来就比较繁琐了。</p>
<p>而换成 Lane 模型的话，计算起来就变得非常简单了：</p>
<p>If there are multiple discontinuous ranges, then the code becomes quite cumbersome to write.</p>
<p>However, with the Lane model, the calculation becomes very simple:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> isTaskIncludedInBatch = (task &amp; batchOfTasks) !== <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>简单介绍了下 Lane 模型，接下来看具体怎么实现。</p>
<p>这次的目标是实现 Batch Update，比如下面的例子，多次更新只会触发一次渲染：</p>
<p>Having briefly introduced the Lane model, let’s look at how it is implemented specifically.</p>
<p>The goal this time is to implement Batch Update, where, as in the following example, multiple updates will only trigger a single render:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [num, updateNum] = useState(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;ul</span><br><span class="line">      onClick=&#123;(e) =&gt; &#123;</span><br><span class="line">        updateNum(<span class="function">(<span class="params">num: number</span>) =&gt;</span> num + <span class="number">1</span>)</span><br><span class="line">        updateNum(<span class="function">(<span class="params">num: number</span>) =&gt;</span> num + <span class="number">2</span>)</span><br><span class="line">        updateNum(<span class="function">(<span class="params">num: number</span>) =&gt;</span> num + <span class="number">3</span>)</span><br><span class="line">        updateNum(<span class="function">(<span class="params">num: number</span>) =&gt;</span> num + <span class="number">4</span>)</span><br><span class="line">      &#125;&#125;&gt;</span><br><span class="line">      num值为：&#123;num&#125;</span><br><span class="line">    &lt;<span class="regexp">/ul&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<p>首先，我们定义好 Lane 以及相关的处理函数，目前只有两种 Lane:</p>
<p>Firstly, we define the Lanes and the related handling functions; currently, there are only two types of Lanes:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> bitflags::bitflags;</span><br><span class="line"></span><br><span class="line"><span class="built_in">bitflags!</span> &#123;</span><br><span class="line">    <span class="meta">#[derive(Debug, Clone, PartialEq, Eq)]</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">Lane</span></span>: <span class="built_in">u8</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> NoLane = <span class="number">0b0000000000000000000000000000000</span>;</span><br><span class="line">        <span class="keyword">const</span> SyncLane = <span class="number">0b0000000000000000000000000000001</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">get_highest_priority</span></span>(lanes: Lane) -&gt; Lane &#123;</span><br><span class="line">    <span class="keyword">let</span> lanes = lanes.bits();</span><br><span class="line">    <span class="keyword">let</span> highest_priority = lanes &amp; (lanes.wrapping_neg());</span><br><span class="line">    Lane::from_bits_truncate(highest_priority)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">merge_lanes</span></span>(lane_a: Lane, lane_b: Lane) -&gt; Lane &#123;</span><br><span class="line">    lane_a | lane_b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">request_update_lane</span></span>() -&gt; Lane &#123;</span><br><span class="line">    Lane::SyncLane</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>每当在 <code>FiberNode</code> 上触发更新时，会将更新的 Lane 冒泡到根节点 <code>root</code>，并同 <code>root.pendingLanes</code> 进行合并：</p>
<p>Whenever an update is triggered on a <code>FiberNode</code>, the update’s Lane is bubbled up to the root node <code>root</code> and merged with <code>root.pendingLanes</code>:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">mark_root_updated</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, lane: Lane) &#123;</span><br><span class="line">    <span class="keyword">self</span>.pending_lanes = merge_lanes(<span class="keyword">self</span>.pending_lanes.clone(), lane)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后，根节点选出优先级最高的 Lane，并开启一轮渲染流程：</p>
<p>Subsequently, the root node selects the highest priority Lane and begins a round of the rendering process:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">ensure_root_is_scheduled</span></span>(root: Rc&lt;RefCell&lt;FiberRootNode&gt;&gt;) &#123;</span><br><span class="line">    <span class="keyword">let</span> root_cloned = root.clone();</span><br><span class="line">    <span class="keyword">let</span> update_lane = get_highest_priority(root.borrow().pending_lanes.clone());</span><br><span class="line">    <span class="keyword">if</span> update_lane == Lane::NoLane &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    schedule_sync_callback(<span class="built_in">Box</span>::new(<span class="keyword">move</span> || &#123;</span><br><span class="line">        perform_sync_work_on_root(root_cloned.clone(), update_lane.clone());</span><br><span class="line">    &#125;));</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        HOST_CONFIG.as_ref().unwrap()</span><br><span class="line">            .schedule_microtask(<span class="built_in">Box</span>::new(|| flush_sync_callbacks()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而这里并没有直接执行 <code>perform_sync_work_on_root</code>，而是通过闭包把任务放到了一个队列中，然后在下一个宏任务或者微任务中一起处理：</p>
<p>Instead of directly executing <code>perform_sync_work_on_root</code>, the task is placed into a queue through a closure, and then processed together in the next macro-task or micro-task:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/react-reconciler/src/sync_task_queue.rs</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">mut</span> SYNC_QUEUE: <span class="built_in">Vec</span>&lt;<span class="built_in">Box</span>&lt;dyn <span class="built_in">FnMut</span>()&gt;&gt; = <span class="built_in">vec!</span>[];</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">mut</span> IS_FLUSHING_SYNC_QUEUE: <span class="built_in">bool</span> = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">schedule_sync_callback</span></span>(callback: <span class="built_in">Box</span>&lt;dyn <span class="built_in">FnMut</span>()&gt;) &#123;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123; SYNC_QUEUE.push(callback) &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">flush_sync_callbacks</span></span>() &#123;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> !IS_FLUSHING_SYNC_QUEUE &amp;&amp; !SYNC_QUEUE.is_empty() &#123;</span><br><span class="line">            IS_FLUSHING_SYNC_QUEUE = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">for</span> callback <span class="keyword">in</span> SYNC_QUEUE.iter_mut() &#123;</span><br><span class="line">                callback();</span><br><span class="line">            &#125;</span><br><span class="line">            SYNC_QUEUE = <span class="built_in">vec!</span>[];</span><br><span class="line">            IS_FLUSHING_SYNC_QUEUE = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// packages/react-reconciler/src/work_loop.rs</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">ensure_root_is_scheduled</span></span>(root: Rc&lt;RefCell&lt;FiberRootNode&gt;&gt;) &#123;</span><br><span class="line">  ...</span><br><span class="line">  schedule_sync_callback(<span class="built_in">Box</span>::new(<span class="keyword">move</span> || &#123;</span><br><span class="line">      perform_sync_work_on_root(root_cloned.clone(), update_lane.clone());</span><br><span class="line">  &#125;));</span><br><span class="line">  <span class="keyword">unsafe</span> &#123;</span><br><span class="line">      HOST_CONFIG.as_ref().unwrap()</span><br><span class="line">          .schedule_microtask(<span class="built_in">Box</span>::new(|| flush_sync_callbacks()));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>schedule_microtask</code> 我们按照 <code>queueMicrotask -&gt; Promise -&gt; setTimeout</code> 的顺序来选择合适的宏任务或者微任务 API。</p>
<p>In <code>schedule_microtask</code>, we choose the appropriate macro-task or micro-task API in the order of <code>queueMicrotask -&gt; Promise -&gt; setTimeout</code>.</p>
<p>执行 <code>perform_sync_work_on_root</code> 时，会按照 <code>update_lane</code> 的优先级来进行渲染，commit 完成后，会把 <code>update_lane</code> 从 <code>pending_lanes</code> 中剔除：</p>
<p>When executing <code>perform_sync_work_on_root</code>, rendering is carried out according to the priority of <code>update_lane</code>. After the commit is complete, <code>update_lane</code> is removed from <code>pending_lanes</code>:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">mark_root_finished</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, lane: Lane) &#123;</span><br><span class="line">    <span class="keyword">self</span>.pending_lanes &amp;= !lane;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样，当下一个 <code>perform_sync_work_on_root</code> 再次执行时，由于得到的最高优先级为 <code>NoLane</code>，就不会继续后面的流程了。</p>
<p>In this way, when <code>perform_sync_work_on_root</code> is executed again, since the highest priority obtained is <code>NoLane</code>, the subsequent process will not continue.</p>
<p>本次更新详见<a href="https://github.com/ParadeTo/big-react-wasm/pull/12" target="_blank" rel="noopener">这里</a>。</p>
<p>For more details on this update, see <a href="https://github.com/ParadeTo/big-react-wasm/pull/12" target="_blank" rel="noopener">here</a>.</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/react/" rel="tag"># react</a>
          
            <a href="/tags/wasm/" rel="tag"># wasm</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2024/05/07/big-react-wasm-12/" rel="next" title="从零实现 React v18，但 WASM 版 - [12] 实现多节点更新流程">
                <i class="fa fa-chevron-left"></i> 从零实现 React v18，但 WASM 版 - [12] 实现多节点更新流程
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2024/05/16/big-react-wasm-14/" rel="prev" title="从零实现 React v18，但 WASM 版 - [14] 实现 Scheduler">
                从零实现 React v18，但 WASM 版 - [14] 实现 Scheduler <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


            </div>
            


            

  
    <div class="comments" id="comments">
      <div id="lv-container" data-id="city" data-uid="MTAyMC8zODAwNS8xNDUzNQ=="></div>
    </div>

  



          </div>
          
            
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Ayou</p>
              <p class="site-description motion-element" itemprop="description">一名转行的菜鸡程序员</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">190</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">19</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">83</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


          
        </div>
      </main>

      <footer id="footer" class="footer">
        <div class="footer-inner">
          <div class="copyright">&copy; <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ayou</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




          







          
        </div>
      </footer>

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
        </div>
      

      
    
  
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  












  





  

  

  

  
  

  

  

  

  
</body>
</html>
