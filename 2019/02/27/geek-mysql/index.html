<!DOCTYPE html>




<html class="theme-next mist" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />


<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />





  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="mysql," />










<meta name="description" content="极客时间mysql笔记">
<meta name="keywords" content="mysql">
<meta property="og:type" content="article">
<meta property="og:title" content="极客时间mysql">
<meta property="og:url" content="http://www.paradeto.com/2019/02/27/geek-mysql/index.html">
<meta property="og:site_name" content="Ayou">
<meta property="og:description" content="极客时间mysql笔记">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://www.paradeto.com/2019/02/27/geek-mysql/1.png">
<meta property="og:image" content="http://www.paradeto.com/2019/02/27/geek-mysql/2.png">
<meta property="og:image" content="http://www.paradeto.com/2019/02/27/geek-mysql/3.png">
<meta property="og:image" content="http://www.paradeto.com/2019/02/27/geek-mysql/4.png">
<meta property="og:image" content="http://www.paradeto.com/2019/02/27/geek-mysql/5.png">
<meta property="og:image" content="http://www.paradeto.com/2019/02/27/geek-mysql/6.png">
<meta property="og:image" content="http://www.paradeto.com/2019/02/27/geek-mysql/7.jpg">
<meta property="og:image" content="http://www.paradeto.com/2019/02/27/geek-mysql/8.jpg">
<meta property="og:image" content="http://www.paradeto.com/2019/02/27/geek-mysql/9.jpg">
<meta property="og:image" content="http://www.paradeto.com/2019/02/27/geek-mysql/10.png">
<meta property="og:image" content="http://www.paradeto.com/2019/02/27/geek-mysql/11.png">
<meta property="og:updated_time" content="2019-04-02T03:44:42.806Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="极客时间mysql">
<meta name="twitter:description" content="极客时间mysql笔记">
<meta name="twitter:image" content="http://www.paradeto.com/2019/02/27/geek-mysql/1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>







  <link rel="canonical" href="http://www.paradeto.com/2019/02/27/geek-mysql/"/>






  <title>极客时间mysql | Ayou</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?6a0c6a11d4daa051d62442b432fb279d";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
    
    
      
    

    <div class="container sidebar-position-left page-post-detail">
      <div class="headband"></div>

      <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
        <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Ayou</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Good Good Study, Day Day Up!</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-demo">
          <a href="/demo/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Demo
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/resume" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            About
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
      </header>

      <main id="main" class="main">
        <div class="main-inner">
          <div class="content-wrap">
            <div id="content" class="content">
              

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.paradeto.com/2019/02/27/geek-mysql/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ayou">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ayou">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">极客时间mysql</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-02-27T20:42:52+08:00">
                2019-02-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/读书笔记/" itemprop="url" rel="index">
                    <span itemprop="name">读书笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          
              <div class="post-description">
                  极客时间mysql笔记
              </div>
          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="基础架构：一条-SQL-查询语句是如何执行的？"><a href="#基础架构：一条-SQL-查询语句是如何执行的？" class="headerlink" title="基础架构：一条 SQL 查询语句是如何执行的？"></a>基础架构：一条 SQL 查询语句是如何执行的？</h1><h2 id="基本架构图"><a href="#基本架构图" class="headerlink" title="基本架构图"></a>基本架构图</h2><p><img src="/2019/02/27/geek-mysql/1.png" alt=""></p>
<p>总体来说，分为<strong>Server层</strong>和<strong>存储引擎层</strong>两部分。</p>
<p>Server 层：</p>
<ul>
<li>连接器</li>
<li>查询缓存</li>
<li>分析器</li>
<li>优化器</li>
<li>执行器</li>
<li>所有内置函数</li>
<li>跨存储引擎的功能（存储过程、触发器、视图）</li>
</ul>
<p>存储引擎层：</p>
<ul>
<li>数据的存储和提取</li>
<li>默认 InnoDB</li>
</ul>
<h2 id="连接器"><a href="#连接器" class="headerlink" title="连接器"></a>连接器</h2><ul>
<li><p>一个用户成功建立连接后，即使你用管理员账号对这个用户的权限做了修改，也不会影响已经存在连接的权限。修改完成后，只有再新建的连接才会使用新的权限设置。</p>
</li>
<li><p>wait_timeout 控制连接时间</p>
</li>
<li><p>长连接、短连接，是否使用长连接和短连接是由客户端来决定的，服务端不会主动断开连接，除非到达了 wait_timeout 的时间</p>
</li>
</ul>
<h2 id="查询缓存"><a href="#查询缓存" class="headerlink" title="查询缓存"></a>查询缓存</h2><ul>
<li>只要有更新操作，缓存就会被清空</li>
<li>8.0 去掉了该功能</li>
</ul>
<h2 id="分析器"><a href="#分析器" class="headerlink" title="分析器"></a>分析器</h2><ul>
<li>词法分析，比如，判断列名是否正确</li>
<li>语法分析，语句是否合法</li>
</ul>
<h2 id="优化器"><a href="#优化器" class="headerlink" title="优化器"></a>优化器</h2><ul>
<li>决定索引的使用</li>
<li>决定 join 的顺序</li>
</ul>
<h2 id="执行器"><a href="#执行器" class="headerlink" title="执行器"></a>执行器</h2><ul>
<li>判断权限。为什么之前不先做？因为 sql 要操作的表不只是 sql 上的那些，比如有个触发器，得在执行器阶段才能确定。</li>
<li>调取引擎的接口获取数据</li>
</ul>
<h1 id="日志系统：一条-SQL-更新语句是如何执行的？"><a href="#日志系统：一条-SQL-更新语句是如何执行的？" class="headerlink" title="日志系统：一条 SQL 更新语句是如何执行的？"></a>日志系统：一条 SQL 更新语句是如何执行的？</h1><h2 id="redo-log"><a href="#redo-log" class="headerlink" title="redo log"></a>redo log</h2><ul>
<li>InnoDB 引擎特有</li>
<li>WAL 技术（Write-Ahead Logging），先写日志，再写磁盘。</li>
<li>write pos 当前写的位置</li>
<li>checkpoint 是当前擦除的位置，write pos 到它之间的空间是可以写入的</li>
<li>innodb_flush_log_at_trx_commit 设置为 1 表示每次事务的 redo log 都直接持久化到磁盘</li>
</ul>
<h2 id="binlog"><a href="#binlog" class="headerlink" title="binlog"></a>binlog</h2><ul>
<li>有两种格式：statement 格式的记 sql 语句，row 格式记录行的更新前后</li>
<li>sync_binlog 设置为 1 表示每次事务的 binlog 都持久化到磁盘</li>
<li>server 层</li>
<li>与 redo log 比较：<ul>
<li>redo log 是 InnoDB 引擎特有，binlog 是 MySQL 的 Server 层实现的，所有引擎都可使用</li>
<li>redo log 是物理日志，记录的是“在某个数据页上做了什么修改”，binlog 是逻辑日志，记录的是这个语句的原始逻辑，比如“给 id = 2 这一行的 c 字段加 1”</li>
<li>redo log 是循环写的，空间固定会用完；binlog 是可以追加写入的。“追加写”是指 binlog 文件写到一定大小后会切换到下一个，并不会覆盖以前的日志。</li>
</ul>
</li>
</ul>
<h2 id="更新数据流程"><a href="#更新数据流程" class="headerlink" title="更新数据流程"></a>更新数据流程</h2><p>以该更新语句为例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update T set c=c+1 where ID=2;</span><br></pre></td></tr></table></figure></p>
<p>更新流程为：</p>
<p><img src="/2019/02/27/geek-mysql/2.png" alt=""></p>
<h2 id="两阶段提交"><a href="#两阶段提交" class="headerlink" title="两阶段提交"></a>两阶段提交</h2><p>这里将 redo log 的写入拆成了两个步骤：prepare 和 commit，即“两阶段提交”。</p>
<p>为什么需要两阶段提交？</p>
<ol>
<li>假设先写 redo log，再写 binlog。。假设在 redo log 写完，binlog 还没有写完的时候，MySQL 进程异常重启。由于我们前面说过的，redo log 写完之后，系统即使崩溃，仍然能够把数据恢复回来，所以恢复后这一行 c 的值是 1。而 binlog 里面没有这个数据，以后如果需要使用 binlog 来恢复数据的时候，就会少了这一次更新</li>
<li>先写 binlog 后写 redo log。如果在 binlog 写完之后 crash，由于 redo log 还没写，崩溃恢复以后这个事务无效，所以这一行 c 的值是 0。但是 binlog 里面已经记录了“把 c 从 0 改成 1”这个日志。所以，在之后用 binlog 来恢复的时候就多了一个事务出来，恢复出来的这一行 c 的值就是 1，与原库的值不同。</li>
</ol>
<p><strong>如果提交事务那一步奔溃了怎么办？</strong><br>利用 redo log 进行恢复的时候会根据事务 id 去检查 binlog 是否完整，如果完整会接受这个事务并自动提交。但是这样一来是不是都不用两阶段提交了，我每次恢复的时候都去检查就行了。个人认为这可能是一种优化吧，如果每次都去检查 binlog 就太低效率，而加上两阶段提交的步骤，进行恢复的时候只有当 redo log 没有提交的时候需要去检查 binlog。</p>
<h1 id="事务隔离：为什么你改了我还看不见？"><a href="#事务隔离：为什么你改了我还看不见？" class="headerlink" title="事务隔离：为什么你改了我还看不见？"></a>事务隔离：为什么你改了我还看不见？</h1><h2 id="隔离级别"><a href="#隔离级别" class="headerlink" title="隔离级别"></a>隔离级别</h2><ul>
<li>读未提交（read uncommitted）：一个事务还没提交，它做的变更就能被别的事务看到</li>
<li>读提交（read committed）：一个事务提交后，它做的变更才会被其他事务看到</li>
<li>可重复读（repeatable read）：一个事务执行过程中的数据总是一致的。</li>
<li>串行化（serializable）：对于同一行记录，读写都会加锁。后面的事务必须等待前面一个事务完成。</li>
</ul>
<h2 id="隔离级别举例说明"><a href="#隔离级别举例说明" class="headerlink" title="隔离级别举例说明"></a>隔离级别举例说明</h2><table>
<thead>
<tr>
<th style="text-align:center">事务A</th>
<th style="text-align:center">事务B</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">启动事务查询得到值1</td>
<td style="text-align:center">启动事务</td>
</tr>
<tr>
<td style="text-align:center">-</td>
<td style="text-align:center">查询得到值1</td>
</tr>
<tr>
<td style="text-align:center">-</td>
<td style="text-align:center">将1改成2</td>
</tr>
<tr>
<td style="text-align:center">查询得到值V1</td>
<td style="text-align:center">-</td>
</tr>
<tr>
<td style="text-align:center">-</td>
<td style="text-align:center">提交事务B</td>
</tr>
<tr>
<td style="text-align:center">查询得到值V2</td>
<td style="text-align:center">-</td>
</tr>
<tr>
<td style="text-align:center">提交事务A</td>
<td style="text-align:center">-</td>
</tr>
<tr>
<td style="text-align:center">查询得到值V3</td>
<td style="text-align:center">-</td>
</tr>
</tbody>
</table>
<ul>
<li>读未提交：V1 的值为2。V2, V3 为2。</li>
<li>读提交：V1 的值为1。V2, V3 为2。</li>
<li>可重复读：V1, V2 的值为1。V3 为2。</li>
<li>串行化：V1、V2 值是 1，V3 的值是 2。</li>
</ul>
<h2 id="隔离级别实现"><a href="#隔离级别实现" class="headerlink" title="隔离级别实现"></a>隔离级别实现</h2><p>在实现上，数据库里面会创建一个视图，访问的时候以视图的逻辑结果为准。</p>
<p>在“可重复读”隔离级别下，这个视图是在事务启动时创建的，整个事务存在期间都用这个视图。<br>在“读提交”隔离级别下，这个视图是在每个 SQL 语句开始执行的时候创建的。<br>“读未提交”隔离级别下直接返回记录上的最新值，没有视图概念<br>而“串行化”隔离级别下直接用加锁的方式来避免并行访问。</p>
<p>不同时刻启动的事务会有不同的视图，如下图所示，对于视图 A，要得到 1，就必须将当前值依次执行图中的回滚操作得到。<br><img src="/2019/02/27/geek-mysql/3.png" alt=""></p>
<p>要避免使用长事务，从而导致回滚记录过多。</p>
<h2 id="如何避免长事务对业务的影响？"><a href="#如何避免长事务对业务的影响？" class="headerlink" title="如何避免长事务对业务的影响？"></a>如何避免长事务对业务的影响？</h2><p>从应用开发端来看：</p>
<ol>
<li>确认是否使用了 set autocommit=0。这个确认工作可以在测试环境中开展，把 MySQL 的 general_log 开起来，然后随便跑一个业务逻辑，通过 general_log 的日志来确认。一般框架如果会设置这个值，也就会提供参数来控制行为，你的目标就是把它改成 1。</li>
<li>确认是否有不必要的只读事务。有些框架会习惯不管什么语句先用 begin/commit 框起来。我见过有些是业务并没有这个需要，但是也把好几个 select 语句放到了事务中。这种只读事务可以去掉。</li>
<li>业务连接数据库的时候，根据业务本身的预估，通过 SET MAX_EXECUTION_TIME 命令，来控制每个语句执行的最长时间，避免单个语句意外执行太长时间。（为什么会意外？在后续的文章中会提到这类案例）</li>
</ol>
<p>从服务端来看：</p>
<ol>
<li>监控 information_schema.Innodb_trx 表，设置长事务阈值，超过就报警 / 或者 kill；</li>
<li>Percona 的 pt-kill 这个工具不错，推荐使用；</li>
<li>在业务功能测试阶段要求输出所有的 general_log，分析日志行为提前发现问题；</li>
<li>如果使用的是 MySQL  5.6 或者更新版本，把 innodb_undo_tablespaces 设置成 2（或更大的值）。如果真的出现大事务导致回滚段过大，这样设置后清理起来更方便。</li>
</ol>
<h2 id="启动方式"><a href="#启动方式" class="headerlink" title="启动方式"></a>启动方式</h2><ol>
<li>显式启动事务语句， begin 或 start transaction。配套的提交语句是 commit，回滚语句是 rollback。</li>
<li>set autocommit=1。注意 set autocommit=0，这个命令会将这个线程的自动提交关掉。意味着如果你只执行一个 select 语句，这个事务就启动了，而且并不会自动提交。这个事务持续存在直到你主动执行 commit 或 rollback 语句，或者断开连接。</li>
</ol>
<h1 id="深入浅出索引"><a href="#深入浅出索引" class="headerlink" title="深入浅出索引"></a>深入浅出索引</h1><h2 id="常见类型"><a href="#常见类型" class="headerlink" title="常见类型"></a>常见类型</h2><ul>
<li>哈希表<br><strong>只适合等值查询</strong><br><img src="/2019/02/27/geek-mysql/4.png" alt=""></li>
<li>有序数组<br>支持二分法快速查找<br>支持范围查询<br>但是更新数据比较麻烦，所以只适合数据不经常变换的场景</li>
<li>二叉搜索树<br>查询和更新都能保证 O(logn) 的复杂度<br>一般用多叉，为了保证一个节点的大小刚好为一个数据块的大小</li>
</ul>
<h2 id="InnoDB-的索引模型"><a href="#InnoDB-的索引模型" class="headerlink" title="InnoDB 的索引模型"></a>InnoDB 的索引模型</h2><p><img src="/2019/02/27/geek-mysql/5.png" alt=""></p>
<p>如上图所示，两棵树分别表示主键 ID 的索引和字段 k 的索引。<br>主键索引的叶子节点存的是整行数据。<br>非主键索引的叶子节点内容是主键的值，即如果使用该索引查询数据，需要回表。</p>
<h3 id="索引维护"><a href="#索引维护" class="headerlink" title="索引维护"></a>索引维护</h3><p>如果插入的数据是递增的，则维护操作比较简单，往后追加即可。<br>如果插入的数据非递增，则还涉及到分页等操作。<br>所以这就是为什么推荐使用递增主键。另外主键长度越小，普通索引的叶子节点也越小，占用的空间也小。</p>
<h2 id="重建索引"><a href="#重建索引" class="headerlink" title="重建索引"></a>重建索引</h2><p>为什么要重建索引，因为索引可能在维护过程中导致数据数据页有空洞，重建索引会创建一个全新的索引，把数据按顺序插入，使得页面的利用率最高，索引更紧凑、更省空间。<br>对于上面的例子，重建索引可以这样写：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">alter table T drop index k;</span><br><span class="line">alter table T add index(k);</span><br><span class="line">alter table T drop primary key;</span><br><span class="line">alter table T add primary key(id);</span><br></pre></td></tr></table></figure></p>
<p>但是，这样的话，前面 k 的索引重建就白做了，因为后面重建了主键索引。可以用一个语句代替：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alter table T engine=InnoDB</span><br></pre></td></tr></table></figure></p>
<h2 id="推测扫描行"><a href="#推测扫描行" class="headerlink" title="推测扫描行"></a>推测扫描行</h2><p><img src="/2019/02/27/geek-mysql/6.png" alt=""></p>
<p>假设有如上索引，我们执行：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from T where k between 3 and 5;</span><br></pre></td></tr></table></figure></p>
<p>将会扫描多少行？</p>
<ol>
<li>在 k 索引上找到 k=3 的记录（这里还会扫描几个非叶子节点），取得 ID = 300；</li>
<li>到 ID 索引树查到 ID = 300 对应的 R3；</li>
<li>顺着 k=3 的记录在 k 索引上找到 k=5 的记录，取得 ID = 500；</li>
<li>回到 ID 索引树查到 ID = 500 对应的 R4；</li>
<li>在 k 索引树取下一个值 k = 6，不满足条件，结束。</li>
</ol>
<h2 id="覆盖索引"><a href="#覆盖索引" class="headerlink" title="覆盖索引"></a>覆盖索引</h2><p>还是上面那句，如果执行：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select ID from T where k between 3 and 5;</span><br></pre></td></tr></table></figure></p>
<p>因为 ID 的值已经在 k 索引树上了，因此可以直接提供查询结果，不需要回表。</p>
<p>问题：<strong>在一个市民信息表上，是否有必要将身份证号和名字建立联合索引？</strong></p>
<p>我们知道，身份证号是市民的唯一标识。也就是说，如果有根据身份证号查询市民信息的需求，我们只要在身份证号字段上建立索引就够了。而再建立一个（身份证号、姓名）的联合索引，是不是浪费空间？如果现在有一个高频请求，要根据市民的身份证号查询他的姓名，这个联合索引就有意义了。它可以在这个高频请求上用到覆盖索引，不再需要回表查整行记录，减少语句的执行时间。</p>
<h2 id="最左前缀原则"><a href="#最左前缀原则" class="headerlink" title="最左前缀原则"></a>最左前缀原则</h2><p>我们以 (name, age) 联合索引来说明：<br><img src="/2019/02/27/geek-mysql/7.jpg" alt=""></p>
<p>上图表示索引项是按照索引定义里面出现的字段顺序排序的。</p>
<p>如果查询语句为 <code>where name like &#39;张%&#39;</code> 会匹配到 ID3 那条记录，然后向后遍历。</p>
<p><strong>建立联合索引的时候，如何安排索引内的字段顺序？</strong><br>有了 (a, b) 联合索引，一般就不用单独在 a 上建立索引了。所以，第一原则是，如果调整顺序可以少维护一个索引，那么这个顺序往往就是需要优先考虑采用的。<br>如果既有联合查询，又有基于 a、b 各自的查询呢？这个时候考虑的就是空间了。比如，name 字段是比 age 字段大的，那么创建 (name, age) 和 (age) 的索引会比创建 (age, nanme) 和 (name) 的索引要省空间。</p>
<h2 id="索引下推"><a href="#索引下推" class="headerlink" title="索引下推"></a>索引下推</h2><p>以下面这个语句为例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from tuser where name like &apos;张 %&apos; and age=10 and ismale=1;</span><br></pre></td></tr></table></figure></p>
<p>在 MySQL 5.6 之前，查询过程如下所示，即每条数据都需要回表：<br><img src="/2019/02/27/geek-mysql/8.jpg" alt=""></p>
<p>而 MySQL 5.6 引入的索引下推优化，可以在索引遍历过程中先做判断：<br><img src="/2019/02/27/geek-mysql/9.jpg" alt=""></p>
<h2 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h2><p>假设有下表：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `geek` (</span><br><span class="line">  `a` int(11) NOT NULL,</span><br><span class="line">  `b` int(11) NOT NULL,</span><br><span class="line">  `c` int(11) NOT NULL,</span><br><span class="line">  `d` int(11) NOT NULL,</span><br><span class="line">  PRIMARY KEY (`a`,`b`),</span><br><span class="line">  KEY `c` (`c`),</span><br><span class="line">  KEY `ca` (`c`,`a`),</span><br><span class="line">  KEY `cb` (`c`,`b`)</span><br><span class="line">) ENGINE=InnoDB;</span><br></pre></td></tr></table></figure></p>
<p>业务中有这样的两种语句：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select * from geek where c=N order by a limit 1;</span><br><span class="line">select * from geek where c=N order by b limit 1;</span><br></pre></td></tr></table></figure></p>
<p>问：’ca’ 和 ‘cb’ 这两个索引是否必要？</p>
<p>答：<br>假设数据表如下：</p>
<table>
<thead>
<tr>
<th style="text-align:center">a</th>
<th style="text-align:center">b</th>
<th style="text-align:center">c</th>
<th style="text-align:center">d</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">2</td>
<td style="text-align:center">3</td>
<td style="text-align:center">d</td>
</tr>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">3</td>
<td style="text-align:center">2</td>
<td style="text-align:center">d</td>
</tr>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">4</td>
<td style="text-align:center">3</td>
<td style="text-align:center">d</td>
</tr>
<tr>
<td style="text-align:center">2</td>
<td style="text-align:center">1</td>
<td style="text-align:center">3</td>
<td style="text-align:center">d</td>
</tr>
<tr>
<td style="text-align:center">2</td>
<td style="text-align:center">2</td>
<td style="text-align:center">2</td>
<td style="text-align:center">d</td>
</tr>
<tr>
<td style="text-align:center">2</td>
<td style="text-align:center">3</td>
<td style="text-align:center">4</td>
<td style="text-align:center">d</td>
</tr>
</tbody>
</table>
<p>需要注意的是，<strong>普通索引中是会自动按照主键来排序的</strong>，所以<br><code>c</code> 和 <code>ca</code> 的效果是一样的，先按 c 排序，再按 a 排序，最后按 b 排序：</p>
<table>
<thead>
<tr>
<th style="text-align:center">c</th>
<th style="text-align:center">a</th>
<th style="text-align:center">b</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">2</td>
<td style="text-align:center">1</td>
<td style="text-align:center">3</td>
</tr>
<tr>
<td style="text-align:center">2</td>
<td style="text-align:center">2</td>
<td style="text-align:center">2</td>
</tr>
<tr>
<td style="text-align:center">3</td>
<td style="text-align:center">1</td>
<td style="text-align:center">2</td>
</tr>
<tr>
<td style="text-align:center">3</td>
<td style="text-align:center">1</td>
<td style="text-align:center">4</td>
</tr>
<tr>
<td style="text-align:center">3</td>
<td style="text-align:center">2</td>
<td style="text-align:center">1</td>
</tr>
<tr>
<td style="text-align:center">4</td>
<td style="text-align:center">2</td>
<td style="text-align:center">3</td>
</tr>
</tbody>
</table>
<p>所以 <code>ca</code> 可以去掉，<code>cb</code> 需要保留</p>
<h1 id="全局锁和表锁-：给表加个字段怎么有这么多阻碍？"><a href="#全局锁和表锁-：给表加个字段怎么有这么多阻碍？" class="headerlink" title="全局锁和表锁 ：给表加个字段怎么有这么多阻碍？"></a>全局锁和表锁 ：给表加个字段怎么有这么多阻碍？</h1><h2 id="全局锁"><a href="#全局锁" class="headerlink" title="全局锁"></a>全局锁</h2><p>加锁语句： <code>Flush tables with read lock (FTWRL)</code>。</p>
<p>使用场景：<strong>全库逻辑备份</strong>，即把整库都 select 出来存成文本。</p>
<p><strong>备份为什么要加锁？</strong><br>假设有用户账户余额和用户所买课程表。如果时间顺序上是先备份账户余额表，然后备份用户课程表，备份期间不加锁会发生如下情况：</p>
<p><img src="/2019/02/27/geek-mysql/10.png" alt=""></p>
<p>如果引擎支持可重复读的隔离级别，可以在备份的时候使用 <code>--single-transaction</code> ，这样不会锁表，数据可以正常更新</p>
<p><strong>为什么不用 <code>set global readonly=true</code>？</strong></p>
<ol>
<li>在有些系统中，readonly 的值会被用来做其他逻辑，比如用来判断一个库是主库还是备库。因此，修改 global 变量的方式影响面更大，我不建议你使用。</li>
<li>在异常处理机制上有差异。如果执行 FTWRL 命令之后由于客户端发生异常断开，那么 MySQL 会自动释放这个全局锁，整个库回到可以正常更新的状态。而将整个库设置为 readonly 之后，如果客户端发生异常，则数据库就会一直保持 readonly 状态，这样会导致整个库长时间处于不可写状态，风险较高。</li>
</ol>
<h2 id="表级锁"><a href="#表级锁" class="headerlink" title="表级锁"></a>表级锁</h2><p>加锁语句：<code>lock tables ... read/write</code>。可以用 unlock tables 主动释放，也可以在客户端断开的时候自动释放。lock tables 语法除了会限制别的线程的读写外，也限定了本线程接下来的操作对象。</p>
<p>另一类表级的锁是 MDL（metadata lock)。MDL 不需要显式使用，在访问一个表的时候会被自动加上。MDL 的作用是，保证读写的正确性。你可以想象一下，如果一个查询正在遍历一个表中的数据，而执行期间另一个线程对这个表结构做变更，删了一列，那么查询线程拿到的结果跟表结构对不上，肯定是不行的。当对一个表做增删改查操作的时候，加 MDL 读锁，当对表结构做变更操作时，加 MDL 写锁。</p>
<h2 id="如何给一个表加字段"><a href="#如何给一个表加字段" class="headerlink" title="如何给一个表加字段"></a>如何给一个表加字段</h2><p>先看一个例子：</p>
<table>
<thead>
<tr>
<th style="text-align:center">sessionA</th>
<th style="text-align:center">sessionB</th>
<th style="text-align:center">sessionC</th>
<th style="text-align:center">sessionD</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">begin;</td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
</tr>
<tr>
<td style="text-align:center">select * from t limit 1;</td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
</tr>
<tr>
<td style="text-align:center">-</td>
<td style="text-align:center">select * from t limit 1;</td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
</tr>
<tr>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
<td style="text-align:center">alter table t add f int;(blocked)</td>
<td style="text-align:center">-</td>
</tr>
<tr>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
<td style="text-align:center">select * from t limit 1;(blocked)</td>
</tr>
</tbody>
</table>
<p>如上图所示，前面两个 session 都可以正常进行，因为都是加的 MDL 读锁，sessionC 由于要修改表字段，所以给表加了 MDL 写锁，会阻塞住后面所有的查询。通过查看当前连接也可以看到这一信息：</p>
<p><img src="/2019/02/27/geek-mysql/11.png" alt=""></p>
<p>手动将 sessionA 提交后，后面的 session 都可以进行了。所以我们在修改表结构的时候要先解决掉正在进行中的事务。</p>
<p>一种比较好的方法是：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE tbl_name WAIT N add column ...</span><br></pre></td></tr></table></figure></p>
<p>这里的 N 单位是秒。</p>
<h2 id="课后题目（不懂）"><a href="#课后题目（不懂）" class="headerlink" title="课后题目（不懂）"></a>课后题目（不懂）</h2><p>备份一般都会在备库上执行，你在用 –-single-transaction 方法做逻辑备份的过程中，如果主库上的一个小表做了一个 DDL，比如给一个表上加了一列。这时候，从备库上会看到什么现象呢？</p>
<p>备份过程中几个关键的语句：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Q1:SET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ;</span><br><span class="line">Q2:START TRANSACTION  WITH CONSISTENT SNAPSHOT；</span><br><span class="line">/* other tables */</span><br><span class="line">Q3:SAVEPOINT sp;</span><br><span class="line">/* 时刻 1 */</span><br><span class="line">Q4:show create table `t1`;</span><br><span class="line">/* 时刻 2 */</span><br><span class="line">Q5:SELECT * FROM `t1`;</span><br><span class="line">/* 时刻 3 */</span><br><span class="line">Q6:ROLLBACK TO SAVEPOINT sp;</span><br><span class="line">/* 时刻 4 */</span><br><span class="line">/* other tables */</span><br></pre></td></tr></table></figure>
<ol>
<li>如果在 Q4 语句执行之前到达，现象：没有影响，备份拿到的是 DDL 后的表结构；</li>
<li>如果在“时刻 2”到达，则表结构被改过，Q5 执行的时候，报 Table definition has changed, please retry transaction，现象：mysqldump 终止；</li>
<li>如果在“时刻 2”和“时刻 3”之间到达，mysqldump 占着 t1 的 MDL 读锁，binlog 被阻塞，现象：主从延迟，直到 Q6 执行完成；</li>
<li>从“时刻 4”开始，mysqldump 释放了 MDL 读锁，现象：没有影响，备份拿到的是 DDL 前的表结构。</li>
</ol>
<h1 id="行锁功过：怎么减少行锁对性能的影响"><a href="#行锁功过：怎么减少行锁对性能的影响" class="headerlink" title="行锁功过：怎么减少行锁对性能的影响"></a>行锁功过：怎么减少行锁对性能的影响</h1><h2 id="两阶段锁"><a href="#两阶段锁" class="headerlink" title="两阶段锁"></a>两阶段锁</h2><p><strong>在 InnoDB 事务中，行锁是在需要的时候才加上的，但并不是不需要了就立刻释放，而是要等到事务结束时才释放。这个就是两阶段锁协议。</strong></p>
<p><strong>如果你的事务中需要锁多个行，要把最可能造成锁冲突、最可能影响并发度的锁尽量往后放。即要减少锁的时间</strong></p>
<h2 id="死锁和死锁检测"><a href="#死锁和死锁检测" class="headerlink" title="死锁和死锁检测"></a>死锁和死锁检测</h2><p>如下图所示，事务A在等待事务B释放 id=2 的行锁，而事务B在等待事务A释放 id=1 的行锁，出现了互相等待，即死锁。</p>
<table>
<thead>
<tr>
<th style="text-align:center">事务A</th>
<th style="text-align:center">事务B</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">begin;update t set k=k+1 where id=1;</td>
<td style="text-align:center">begin;</td>
</tr>
<tr>
<td style="text-align:center">_</td>
<td style="text-align:center">update t set k=k+1 where id=2;</td>
</tr>
<tr>
<td style="text-align:center">update t set k=k+1 where id=2;</td>
<td style="text-align:center">_</td>
</tr>
<tr>
<td style="text-align:center">-</td>
<td style="text-align:center">update t set k=k+1 where id=1;</td>
</tr>
</tbody>
</table>
<p>有两种策略解决死锁：</p>
<ol>
<li>一种策略是，直接进入等待，直到超时。这个超时时间可以通过参数 innodb_lock_wait_timeout 来设置。</li>
<li>另一种策略是，发起死锁检测，发现死锁后，主动回滚死锁链条中的某一个事务，让其他事务得以继续执行。将参数 innodb_deadlock_detect 设置为 on，表示开启这个逻辑。每个线程锁住之后都要判断死锁，所以这个时间复杂度是 O(n)，整个系统的时间复杂度就是 O(n^2) 了。因此你会看到 CPU 利用率很高，但是执行不了几个事务。</li>
</ol>
<p><strong>怎么解决由这种热点行更新导致的性能问题呢？</strong></p>
<ol>
<li>关掉死锁检测，前提是能确保不会出现死锁，显然这种方法不合适</li>
<li>控制并发度。基本思路就是，对于相同行的更新，在进入引擎之前排队。这样在 InnoDB 内部就不会有大量的死锁检测工作了。</li>
<li>你可以考虑通过将一行改成逻辑上的多行来减少锁冲突。还是以影院账户为例，可以考虑放在多条记录上，比如 10 个记录，影院的账户总额等于这 10 个记录的值的总和。这样每次要给影院账户加金额的时候，随机选其中一条记录来加。这样每次冲突概率变成原来的 1/10，可以减少锁等待个数，也就减少了死锁检测的 CPU 消耗。当然余额变成 0 了再要减的时候也要特殊处理。</li>
</ol>
<h1 id="事务到底是隔离的还是不隔离的"><a href="#事务到底是隔离的还是不隔离的" class="headerlink" title="事务到底是隔离的还是不隔离的"></a>事务到底是隔离的还是不隔离的</h1><h2 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h2><table>
<thead>
<tr>
<th style="text-align:center">事务A</th>
<th style="text-align:center">事务B</th>
<th style="text-align:center">事务C</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">start transaction with consistent snapshot;</td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
</tr>
<tr>
<td style="text-align:center">-</td>
<td style="text-align:center">start transaction with consistent snapshot;</td>
<td style="text-align:center">-</td>
</tr>
<tr>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
<td style="text-align:center">update k set k=k+1 where id=1;</td>
</tr>
<tr>
<td style="text-align:center">-</td>
<td style="text-align:center">update t set k=k+1 where id=1;select k from t where id=1;</td>
<td style="text-align:center">_</td>
</tr>
<tr>
<td style="text-align:center">select k from t where id=1;commit</td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
</tr>
<tr>
<td style="text-align:center">-</td>
<td style="text-align:center">commit;</td>
<td style="text-align:center">-</td>
</tr>
</tbody>
</table>
<ol>
<li>如果落在绿色部分，表示这个版本是已提交的事务或者是当前事务自己生成的，这个数据是可见的；</li>
<li>如果落在红色部分，表示这个版本是由将来启动的事务生成的，是肯定不可见的；</li>
<li>如果落在黄色部分，那就包括两种情况<ul>
<li>若 row trx_id 在数组中，表示这个版本是由还没提交的事务生成的，不可见；</li>
<li>若 row trx_id 不在数组中，表示这个版本是已经提交了的事务生成的，可见。</li>
</ul>
</li>
</ol>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/mysql/" rel="tag"># mysql</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/12/28/react-jest/" rel="next" title="react 单元测试">
                <i class="fa fa-chevron-left"></i> react 单元测试
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/04/02/geek-algo/" rel="prev" title="极客时间数据结构与算法">
                极客时间数据结构与算法 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


            </div>
            


            

  
    <div class="comments" id="comments">
      <div id="lv-container" data-id="city" data-uid="MTAyMC8zODAwNS8xNDUzNQ=="></div>
    </div>

  



          </div>
          
            
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Ayou</p>
              <p class="site-description motion-element" itemprop="description">一名转行的菜鸡程序员</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">172</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">19</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">83</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#基础架构：一条-SQL-查询语句是如何执行的？"><span class="nav-number">1.</span> <span class="nav-text">基础架构：一条 SQL 查询语句是如何执行的？</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#基本架构图"><span class="nav-number">1.1.</span> <span class="nav-text">基本架构图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#连接器"><span class="nav-number">1.2.</span> <span class="nav-text">连接器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#查询缓存"><span class="nav-number">1.3.</span> <span class="nav-text">查询缓存</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#分析器"><span class="nav-number">1.4.</span> <span class="nav-text">分析器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#优化器"><span class="nav-number">1.5.</span> <span class="nav-text">优化器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#执行器"><span class="nav-number">1.6.</span> <span class="nav-text">执行器</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#日志系统：一条-SQL-更新语句是如何执行的？"><span class="nav-number">2.</span> <span class="nav-text">日志系统：一条 SQL 更新语句是如何执行的？</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#redo-log"><span class="nav-number">2.1.</span> <span class="nav-text">redo log</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#binlog"><span class="nav-number">2.2.</span> <span class="nav-text">binlog</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#更新数据流程"><span class="nav-number">2.3.</span> <span class="nav-text">更新数据流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#两阶段提交"><span class="nav-number">2.4.</span> <span class="nav-text">两阶段提交</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#事务隔离：为什么你改了我还看不见？"><span class="nav-number">3.</span> <span class="nav-text">事务隔离：为什么你改了我还看不见？</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#隔离级别"><span class="nav-number">3.1.</span> <span class="nav-text">隔离级别</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#隔离级别举例说明"><span class="nav-number">3.2.</span> <span class="nav-text">隔离级别举例说明</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#隔离级别实现"><span class="nav-number">3.3.</span> <span class="nav-text">隔离级别实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#如何避免长事务对业务的影响？"><span class="nav-number">3.4.</span> <span class="nav-text">如何避免长事务对业务的影响？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#启动方式"><span class="nav-number">3.5.</span> <span class="nav-text">启动方式</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#深入浅出索引"><span class="nav-number">4.</span> <span class="nav-text">深入浅出索引</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#常见类型"><span class="nav-number">4.1.</span> <span class="nav-text">常见类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#InnoDB-的索引模型"><span class="nav-number">4.2.</span> <span class="nav-text">InnoDB 的索引模型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#索引维护"><span class="nav-number">4.2.1.</span> <span class="nav-text">索引维护</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#重建索引"><span class="nav-number">4.3.</span> <span class="nav-text">重建索引</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#推测扫描行"><span class="nav-number">4.4.</span> <span class="nav-text">推测扫描行</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#覆盖索引"><span class="nav-number">4.5.</span> <span class="nav-text">覆盖索引</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#最左前缀原则"><span class="nav-number">4.6.</span> <span class="nav-text">最左前缀原则</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#索引下推"><span class="nav-number">4.7.</span> <span class="nav-text">索引下推</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#题目"><span class="nav-number">4.8.</span> <span class="nav-text">题目</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#全局锁和表锁-：给表加个字段怎么有这么多阻碍？"><span class="nav-number">5.</span> <span class="nav-text">全局锁和表锁 ：给表加个字段怎么有这么多阻碍？</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#全局锁"><span class="nav-number">5.1.</span> <span class="nav-text">全局锁</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#表级锁"><span class="nav-number">5.2.</span> <span class="nav-text">表级锁</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#如何给一个表加字段"><span class="nav-number">5.3.</span> <span class="nav-text">如何给一个表加字段</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#课后题目（不懂）"><span class="nav-number">5.4.</span> <span class="nav-text">课后题目（不懂）</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#行锁功过：怎么减少行锁对性能的影响"><span class="nav-number">6.</span> <span class="nav-text">行锁功过：怎么减少行锁对性能的影响</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#两阶段锁"><span class="nav-number">6.1.</span> <span class="nav-text">两阶段锁</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#死锁和死锁检测"><span class="nav-number">6.2.</span> <span class="nav-text">死锁和死锁检测</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#事务到底是隔离的还是不隔离的"><span class="nav-number">7.</span> <span class="nav-text">事务到底是隔离的还是不隔离的</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#例子"><span class="nav-number">7.1.</span> <span class="nav-text">例子</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


          
        </div>
      </main>

      <footer id="footer" class="footer">
        <div class="footer-inner">
          <div class="copyright">&copy; <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ayou</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




          







          
        </div>
      </footer>

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
        </div>
      

      
    
  
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  












  





  

  

  

  
  

  

  

  

  
</body>
</html>
